<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563EB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="appStyle.css">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <title>Class Manager</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" src="https://www.payhere.lk/lib/payhere.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>

    <div id="app" class="container">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <img src="assets/favicon.ico" alt="Logo" class="nav-logo">
                    <span class="navbar-title">Class Manager</span>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">        
                    <div id="syncStatus" style="font-size: 12px; color: rgba(255,255,255,0.8);">            
                        <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">Synced</span>        
                    </div>       
                    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                </div>
            </div>
        </nav>

        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Teacher Portal</h3>
                <p>Welcome back!</p>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-screen="dashboard" onclick="navigateTo('dashboard')">
                    <span>üìä</span><span>Dashboard</span>
                </div>
                <div class="menu-item" data-screen="students" onclick="navigateTo('students')">
                    <span>üë•</span><span>Students</span>
                </div>
                <div class="menu-item" data-screen="timetable" onclick="navigateTo('timetable')">
                    <span>üìÖ</span><span>Timetable</span>
                </div>
                <div class="menu-item" data-screen="attendance" onclick="navigateTo('attendance')">
                    <span>‚úÖ</span><span>Attendance</span>
                </div>
                <div class="menu-item" data-screen="payments" onclick="navigateTo('payments')">
                    <span>üí∞</span><span>Payments</span>
                </div>
                <div class="menu-item" data-screen="reports" onclick="navigateTo('reports')">
                    <span>üìÑ</span><span>Reports</span>
                </div>
                <div class="menu-item" data-screen="subscription" onclick="navigateTo('subscription')">        
                    <span>‚≠ê</span><span>Subscription</span>    
                </div>
                <div class="menu-item" data-screen="settings" onclick="navigateTo('settings')">
                    <span>‚öôÔ∏è</span><span>Settings</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <span>üö™</span><span>Logout</span>
                </div>
            </div>
        </div>

        <div class="content">
            
            <!-- Dashboard Screen -->
            <div id="dashboard" class="screen active">
                <div class="screen-header">
                    <h1 class="screen-title">Dashboard</h1>
                    <p class="screen-subtitle">Welcome back! Here's your overview</p>
                </div>
                <div class="form-group" style="max-width: 300px;">
                    <label>Filter by Grade</label>
                    <select id="gradeFilter" onchange="updateDashboard()">
                        <option value="all">All Grades</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Total Students</p>
                                <h3 id="totalStudents">0</h3>
                            </div>
                            <div class="stat-icon blue">üë•</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Today's Classes</p>
                                <h3 id="todayClasses">0</h3>
                            </div>
                            <div class="stat-icon green">üìÖ</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Pending Payments</p>
                                <h3 id="pendingPayments">0</h3>
                            </div>
                            <div class="stat-icon amber">‚ö†Ô∏è</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Attendance Rate</p>
                                <h3 id="attendanceRate">0%</h3>
                            </div>
                            <div class="stat-icon purple">‚úÖ</div>
                        </div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title">Quick Actions</h3>
                        <button class="btn btn-primary" onclick="navigateTo('attendance')" style="margin-bottom: 12px;">‚úÖ Mark Attendance</button>
                        <button class="btn btn-success" onclick="navigateTo('payments')" style="margin-bottom: 12px;">üí∞ Record Payment</button>
                        <button class="btn btn-secondary" onclick="navigateTo('reports')">üìÑ Generate Report</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Today's Classes</h3>
                        <div id="todayClassesList"></div>
                    </div>
                </div>
            </div>

            <!-- Students Screen -->
            <div id="students" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Student Management</h1>        
                    <p class="screen-subtitle">Manage all students</p>    
                </div>
    
                <!-- SIMPLE EXPORT BUTTONS -->   
                <div class="glass-card" style="margin-bottom: 20px; max-width: 700px; margin-left: auto; margin-right: auto;">        
                    <h3 class="card-title">üì• Export Students</h3>       
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">           
                        <button class="btn btn-success" onclick="exportStudentsToExcel()">              
                            üìä All Students Excel            
                        </button>           
                        <button class="btn btn-primary" onclick="exportStudentsByGrade()">               
                            üìë By Grade Excel            
                        </button>            
                        <button class="btn btn-secondary" onclick="exportCurrentGradeStudents()">                
                            üìÑ Current Tab Only            
                        </button>        
                    </div>   
                </div>
   
                <div class="grid-2">
                    <!-- Left Side - Student List by Grade Tabs -->
                    <div class="card">
                        <h3 class="card-title">Students by Grade</h3>
                        
                        <!-- Grade Tabs -->
                        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="grade-tab active" data-grade="all" onclick="switchGradeTab('all')">
                                All
                            </button>
                            <div id="gradeTabs"></div>
                        </div>

                        <!-- Search -->
                        <div class="form-group">
                            <input type="text" id="studentSearchBox" placeholder="Search by name, ID, or phone..." oninput="filterStudentsByTab()">
                        </div>

                        <!-- Student List -->
                        <div id="studentListByGrade" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <!-- Right Side - Student Form -->
                    <div class="card">
                        <h3 class="card-title" id="studentFormTitle">Add New Student</h3>
                        
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="studentNameInput" placeholder="Enter student name">
                        </div>

                        <div class="form-group">
                            <label>Birthday *</label>
                            <input type="date" id="studentBirthdayInput">
                        </div>

                        <div class="form-group">
                            <label>Gender *</label>
                            <select id="studentGenderInput">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Class *</label>
                            <select id="studentClassInput">
                                <option value="">Select Class</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Grade *</label>
                            <select id="studentGradeInput"></select>
                        </div>

                        <div class="form-group">
                            <label>Student's Phone Number</label>
                            <input type="tel" id="studentPhoneInput" placeholder="e.g., 0771234567">
                        </div>

                        <div class="form-group">
                            <label>Parent's Phone Number *</label>
                            <input type="tel" id="parentPhoneInput" placeholder="e.g., 0771234567">
                        </div>

                        <div id="studentIdDisplaySection" style="display: none;">
    
                            <div class="form-group">        
                                <label>Student ID</label>        
                                <input type="text" id="studentIdDisplay" disabled style="background: #F3F4F6; font-weight: 600;">   
                            </div>
        
                            <div style="text-align: center; padding: 20px; background: #F3F4F6; border-radius: 12px; border: 2px dashed #D1D5DB;">        
                                <div style="font-size: 48px; margin-bottom: 12px;">üì±</div>    
                                <p style="font-weight: 600; color: #374151; margin-bottom: 8px;">QR Code Ready</p>
                                <p style="font-size: 14px; color: #6B7280; margin-bottom: 16px;" id="qrCodeText"></p>        
        
                                <button type="button" class="btn btn-primary" onclick="showQRCodeForCurrentStudent()">            
                                    üé´ View & Download QR Code        
                                </button>    
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid-2" style="gap: 12px; margin-top: 20px;">
                            <button class="btn btn-primary" id="addStudentBtn" onclick="addNewStudent()">
                                ‚ûï Add
                            </button>
                            <button class="btn btn-success" id="updateStudentBtn" style="display: none;" onclick="updateExistingStudent()">
                                üíæ Update
                            </button>
                            <button class="btn btn-danger" id="deleteStudentBtn" style="display: none;" onclick="deleteExistingStudent()">
                                üóëÔ∏è Delete
                            </button>
                            <button class="btn btn-secondary" id="clearStudentBtn" onclick="clearStudentForm()">
                                ‚úñÔ∏è Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Timetable Screen -->
            <div id="timetable" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Timetable</h1>
                    <p class="screen-subtitle" id="subjectDisplay">Subject: Mathematics</p>
                </div>
                <button class="btn btn-primary" onclick="showAddTimetable()" style="margin-bottom: 20px;">‚ûï Add Class</button>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Grade</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timetableTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 40px; color: #6B7280;">No classes scheduled</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Screen -->
            <div id="attendance" class="screen">  
                <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">      
                    <div class="screen-header">            
                        <h1 class="screen-title">Mark Attendance</h1>         
                        <p class="screen-subtitle">Track student attendance</p>     
                    </div>

                    <!-- Step 1 & 2: Select Class and Date -->     
                    <div class="card">           
                        <h3 class="card-title">Step 1 & 2: Select Class and Date</h3>           
            
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Select Class *</label>                    
                                <select id="attendanceClassSelect" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 16px;">                       
                                    <option value="">Choose a class</option>        
                                    <option value="06">Grade 06</option>                        
                                    <option value="07">Grade 07</option>                        
                                    <option value="08">Grade 08</option>                        
                                    <option value="09">Grade 09</option>                        
                                    <option value="10">Grade 10</option>                       
                                    <option value="11">Grade 11</option>                       
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Select Date *</label>                 
                                <input type="date" id="attendanceDateSelect" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 16px;">
                            </div>
                        </div>
            
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="loadAttendanceStudents()" style="flex: 1;">
                                üìã Load Students
                            </button>
                            <button class="btn btn-secondary" onclick="openQRScanner('attendance')">        
                                üì∑ Scan QR    
                            </button>    
                            <button class="btn btn-secondary" onclick="manualQRInput('attendance')">        
                                ‚å®Ô∏è Manual Entry    
                            </button>
                        </div>        
                    </div>

                    <!-- Step 4: Mark Present/Absent -->
                    <div class="card" id="attendanceStudentCard" style="display: none;">
                        <h3 class="card-title">Step 4: Mark Attendance</h3>
            
                        <!-- Stats -->           
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">                
                            <div style="background: #F3F4F6; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #6B7280; margin-bottom: 5px;">Total Students</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #1F2937;" id="attendanceTotalCount">0</h3>                
                            </div>                
                            <div style="background: #D1FAE5; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #065F46; margin-bottom: 5px;">Present</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #065F46;" id="attendancePresentCount">0</h3>                
                            </div>                
                            <div style="background: #FEE2E2; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #991B1B; margin-bottom: 5px;">Absent</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #991B1B;" id="attendanceAbsentCount">0</h3>                
                            </div>            
                        </div>
            
                        <!-- Student List -->
                        <div id="attendanceStudentsList"></div>

                        <!-- Step 5: Save -->            
                        <button class="btn btn-success" onclick="saveAttendanceData()" style="margin-top: 20px; width: 100%;">                
                            üíæ Step 5: Save Attendance
                        </button>        
                    </div>
                </div>
            </div>

            <!-- Payments Screen -->
            <div id="payments" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Payment Management</h1>
                    <p class="screen-subtitle">Manage student fee payments</p>
                </div>

                <div class="card">
                    <h3 class="card-title">Record Payment</h3>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">    
                        <button class="btn btn-primary" onclick="openQRScanner('payment')" style="flex: 1;">        
                            üì∑ Scan QR Code    
                        </button>    
                        <button class="btn btn-secondary" onclick="manualQRInput('payment')">        
                            ‚å®Ô∏è Manual Entry
                        </button>
                    </div>

                    <div class="form-group">
                        <label>Student ID *</label>
                        <input type="text" id="paymentStudentId" placeholder="Enter student ID or scan QR">
                    </div>

                    <div class="form-group">
                        <label>Class (Auto-filled)</label>
                        <input type="text" id="paymentClass" placeholder="Will auto-fill after entering ID" disabled>
                    </div>

                    <div class="form-group">
                        <label>Month *</label>
                        <select id="paymentMonthDropdown">
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="paymentAmountInput" placeholder="Enter amount">
                    </div>

                    <div class="form-group">
                        <label>Payment Status *</label>
                        <select id="paymentStatusDropdown">
                            <option value="Paid">Paid</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Free Card">Free Card</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="recordPayment()">
                        üíæ Record Payment
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title">Payment History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th>Class</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #6B7280;">
                                        No payment records yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Screen -->
            <div id="reports" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Reports</h1>
                </div>
                <div class="card">
                    <h3 class="card-title">Generate Report</h3>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="attendance">Monthly Attendance by Grade</option>
                            <option value="payment">Payment Collection Summary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Month</label>
                        <input type="month" id="reportMonth">
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="reportGrade">
                            <option value="all">All Grades</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">üìä Generate</button>
                    <button class="btn btn-success" onclick="exportToExcel()" style="margin-top: 12px;">üì• Export Excel</button>
                </div>
                <div class="card" id="reportPreview" style="display: none;">
                    <h3 class="card-title">Preview</h3>
                    <div id="reportContent"></div>
                </div>
            </div>
       
            <!-- QR Scanner Modal -->
            <div class="modal" id="qrScannerModal">    
                <div class="modal-content" style="max-width: 600px;">        
                    <div class="modal-header">            
                        <h3 class="modal-title">üì∑ Scan QR Code</h3>            
                        <button class="close-btn" onclick="closeQRScanner()">‚úñ</button>
                    </div>        
                    <div id="qr-reader" style="width: 100%;"></div>                
                    <div style="margin-top: 20px; padding: 15px; background: #F3F4F6; border-radius: 8px;">            
                        <p style="margin: 0; font-size: 14px; color: #6B7280;">                
                            üì± Position the QR code in front of your camera            
                        </p>
                        <button class="btn btn-secondary" onclick="switchCamera()" style="margin-top: 15px;">            
                            üîÑ Switch Camera        
                        </button>
                    </div>
               
                    <div id="qr-result" style="margin-top: 15px; padding: 15px; background: #D1FAE5; border-radius: 8px; display: none;">            
                        <p style="margin: 0; font-weight: 600; color: #065F46;">             
                            ‚úÖ Scanned: <span id="qr-scanned-id"></span>            
                        </p>        
                    </div>    
                </div>
            </div>

            <!-- Subscription Screen -->
            <div id="subscription" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Subscription Plans</h1>       
                    <p class="screen-subtitle">Choose the plan that fits your needs</p>    
                </div>
    
                <!-- Current Subscription Status -->    
                <div class="glass-card" style="margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">       
                    <h3 class="card-title">üìã Current Subscription</h3>
             
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">           
                        <div style="background: rgba(59,130,246,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Current Plan</p>               
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="currentPlanName">Free Trial</p>            
                        </div>            
                        <div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Status</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="subscriptionStatus">Active</p>            
                        </div>            
                        <div style="background: rgba(245,158,11,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Students</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;"><span id="currentStudents">0</span> / <span id="maxStudents">10</span></p>            
                        </div>            
                        <div style="background: rgba(139,92,246,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Valid Until</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="subscriptionEndDate">-</p>            
                        </div>   
                    </div>        
                    <div id="subscriptionWarning" style="display: none; background: rgba(239,68,68,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.3);">            
                        <p style="margin: 0; color: #FEE2E2; font-weight: 600;">‚ö†Ô∏è <span id="warningMessage"></span></p>        
                    </div>    
                </div>
    
                <!-- Pricing Plans -->    
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
               
                    <!-- Free Trial Plan -->        
                    <div class="glass-card" style="position: relative;">            
                        <div style="background: rgba(107,114,128,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">                
                            <span style="font-size: 12px; font-weight: 600; color: #fff;">FREE TRIAL</span>            
                        </div>         
            
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 10px;">                
                            Free            
                        </h3>            
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Perfect for trying out</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Up to 10 students</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Attendance tracking</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Payment records</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #EF4444; font-size: 20px;">‚úó</span>                    
                                <span style="color: rgba(255,255,255,0.5);">Advanced reports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #EF4444; font-size: 20px;">‚úó</span>                    
                                <span style="color: rgba(255,255,255,0.5);">Unlimited students</span>                
                            </div>            
                        </div>            
            
                        <button class="btn btn-secondary" onclick="selectPlan('free_trial')" id="btnFreeTrial">                
                            Current Plan            
                        </button>        
                    </div>
        
                    <!-- Monthly Plan -->       
                    <div class="glass-card" style="position: relative; border: 2px solid #10B981;">            
                        <div style="position: absolute; top: -12px; right: 20px; background: #10B981; padding: 4px 12px; border-radius: 12px;">                
                            <span style="font-size: 11px; font-weight: 700; color: #fff;">POPULAR</span>           
                        </div>
                       
                        <div style="background: rgba(16,185,129,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">              
                            <span style="font-size: 12px; font-weight: 600; color: #D1FAE5;">MONTHLY</span>            
                        </div>
                        
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 5px;">                
                            LKR.1000.00<span style="font-size: 16px; font-weight: 400; color: rgba(255,255,255,0.7);">/month</span>          
                        </h3>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Best for small classes</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Unlimited students</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">All attendance features</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Advanced reports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                   
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Excel exports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Priority support</span>                
                            </div>            
                        </div>           
                        <button class="btn btn-success" onclick="initiatePayment('monthly')" id="btnMonthly">                
                            Subscribe Monthly            
                        </button>        
                    </div>
    
                    <!-- Annual Plan -->        
                    <div class="glass-card" style="position: relative; border: 2px solid #3B82F6;">            
                        <div style="position: absolute; top: -12px; right: 20px; background: #3B82F6; padding: 4px 12px; border-radius: 12px;">               
                            <span style="font-size: 11px; font-weight: 700; color: #fff;">SAVE 20%</span>           
                        </div>
                       
                        <div style="background: rgba(59,130,246,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">                
                            <span style="font-size: 12px; font-weight: 600; color: #DBEAFE;">ANNUAL</span>           
                        </div>
                       
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 5px;">                
                            LKR.9600.00<span style="font-size: 16px; font-weight: 400; color: rgba(255,255,255,0.7);">/year</span>            
                        </h3>
                        
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Save LKR.2400.00/year</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">               
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                   
                                <span style="color: rgba(255,255,255,0.9);">Everything in Monthly</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">20% discount</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Priority updates</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Dedicated support</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">No ads (coming soon)</span>                
                            </div>            
                        </div>
                        
                        <button class="btn btn-primary" onclick="initiatePayment('annual')" id="btnAnnual">                
                            Subscribe Annual            
                        </button>        
                    </div>    
                </div>

                <!-- Payment History -->
                <div class="glass-card" style="margin-top: 40px; max-width: 1000px; margin-left: auto; margin-right: auto;">  
                    <h3 class="card-title">üí≥ Payment History</h3>
       
                    <div class="table-container">        
                        <table>            
                            <thead>                
                                <tr>                    
                                    <th>Date</th>                    
                                    <th>Order ID</th>                    
                                    <th>Plan</th>                    
                                    <th>Amount</th>                   
                                    <th>Status</th>                
                                </tr>            
                            </thead>           
                            <tbody id="paymentHistoryTableBody">                
                                <tr>                    
                                    <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">                        
                                        No payment history yet                   
                                    </td>                
                                </tr>            
                            </tbody>        
                        </table>    
                    </div>
                </div>
    
                <!-- FAQs -->    
                <div class="glass-card" style="margin-top: 40px; max-width: 800px; margin-left: auto; margin-right: auto;">        
                    <h3 class="card-title">‚ùì Frequently Asked Questions</h3>        
        
                    <div style="margin-bottom: 20px;">           
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">Can I cancel anytime?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Yes! You can cancel your subscription at any time. You'll continue to have access until the end of your billing period.</p>        
                    </div>
                
                    <div style="margin-bottom: 20px;">            
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">What happens to my data if I cancel?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Your data is always yours. You can export all your data before canceling. We keep your data for 30 days after cancellation.</p>      
                    </div>
        
                    <div style="margin-bottom: 20px;">                  
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">Can I upgrade or downgrade my plan?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Yes! You can change your plan at any time. Upgrades are immediate, and downgrades take effect at the end of your billing period.</p>        
                    </div>    
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settings" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Settings</h1>   
                </div>

                <div class="card">                    
                    <h3 class="card-title">üë§ Account</h3>
                        
                    <div style="background: rgba(59,130,246,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px;">                            
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Your Teacher ID:</p>                      
                        <p style="font-size: 16px; font-weight: 600; color: #fff; font-family: monospace;" id="teacherIdDisplay"></p>                       
                        <button class="btn btn-secondary" onclick="copyTeacherId()" style="margin-top: 10px; width: auto;">                
                            üìã Copy ID                      
                        </button>                   
                    </div>
                        
                    <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">                            
                        üí° Save this ID to access your data from any device                    
                    </p>    
                    
                    <button class="btn btn-primary" onclick="manualSync()" style="margin-bottom: 12px;">                            
                        üîÑ Sync Now                    
                    </button>            
                </div>
       
                <!-- Grades Card -->   
                <div class="card">
                    <h3 class="card-title">Grades</h3>        
                    <div id="gradesList"></div>       
                    <div style="display: flex; gap: 12px; margin-top: 16px;">            
                        <input type="text" id="newGrade" placeholder="e.g., 13" style="flex: 1;">            
                        <button class="btn btn-primary" onclick="addGrade()">‚ûï Add</button>        
                    </div>    
                </div>
        
                <!-- Subject Card -->    
                <div class="card">        
                    <h3 class="card-title">Subject</h3>        
                    <div class="form-group">            
                        <label>Subject Name</label>            
                        <input type="text" id="subjectNameInput" value="Mathematics">        
                    </div>        
                    <button class="btn btn-primary" onclick="saveSubject()">üíæ Save</button>    
                </div>
        
                <!-- Data Management Card -->    
                <div class="card">        
                    <h3 class="card-title">Data Management</h3>        
        
                    <!-- Auto-Save Status -->        
                    <div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(16,185,129,0.3);">            
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">                
                            <span style="font-size: 20px;">‚úÖ</span>                
                            <span style="font-weight: 600; color: #D1FAE5;">Auto-Save Active</span>            
                        </div>            
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">                
                            Your data is automatically saved every time you make changes           
                        </p>       
                    </div>
        
                    <!-- Last Saved Info -->        
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px;">            
                        <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 0;">                
                            üìÖ Last Saved: <span id="lastSavedTime" style="font-weight: 600; color: #fff;">Never</span>            
                        </p>           
                        <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 8px 0 0 0;">                
                            üì¶ Last Backup: <span id="lastBackupTime" style="font-weight: 600; color: #fff;">Never</span>           
                        </p>        
                    </div>
        
                    <!-- Manual Backup -->        
                    <h4 style="color: #fff; font-size: 16px; margin-bottom: 12px;">Manual Backup</h4>        
                    <button class="btn btn-primary" onclick="downloadBackup()" style="margin-bottom: 12px;">            
                        üíæ Download Backup File        
                    </button>        
                    <button class="btn btn-secondary" onclick="uploadBackup()" style="margin-bottom: 20px;">            
                        üìÇ Restore from Backup File        
                    </button>

                    <!-- Data Statistics -->        
                    <h4 style="color: #fff; font-size: 16px; margin-bottom: 12px;">Data Statistics</h4>        
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">            
                        <div style="background: rgba(59,130,246,0.2); padding: 12px; border-radius: 8px; text-align: center;">                
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Students</p>                
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsStudents">0</p>           
                        </div>           
                        <div style="background: rgba(16,185,129,0.2); padding: 12px; border-radius: 8px; text-align: center;">                
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Payments</p>                
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsPayments">0</p>            
                        </div>            
                        <div style="background: rgba(245,158,11,0.2); padding: 12px; border-radius: 8px; text-align: center;">                
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Classes</p>                
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsTimetable">0</p>           
                        </div>            
                        <div style="background: rgba(139,92,246,0.2); padding: 12px; border-radius: 8px; text-align: center;">                
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Attendance Records</p>              
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsAttendance">0</p>         
                        </div>        
                    </div>
        
                    <!-- Export Data -->        
                    <h4 style="color: #fff; font-size: 16px; margin-bottom: 12px;">Export Data</h4>       
                    <button class="btn btn-success" onclick="exportAllDataToExcel()" style="margin-bottom: 20px;">            
                        üìä Export All Data to Excel       
                    </button>
        
                    <!-- Danger Zone -->        
                    <div style="background: rgba(239,68,68,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.3);">           
                        <h4 style="color: #FEE2E2; font-size: 16px; margin-bottom: 8px;">‚ö†Ô∏è Danger Zone</h4>            
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px;">                
                            This action cannot be undone. All data will be permanently deleted.            
                        </p>            
                        <button class="btn btn-danger" onclick="clearAllData()">                
                            üóëÔ∏è Clear All Data            
                        </button>        
                    </div>    
                </div>
            </div>

            <!-- QR Code Display Modal -->
            <div class="modal" id="qrCodeDisplayModal">    
                <div class="modal-content" style="max-width: 500px;">        
                    <div class="modal-header">            
                        <h3 class="modal-title">Student QR Code</h3>            
                        <button class="close-btn" onclick="closeQRCodeDisplay()">‚úñ</button>        
                    </div>
        
                    <div style="text-align: center;">            
                        <div style="background: #F3F4F6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">                
                            <p style="font-size: 18px; font-weight: 600; color: #1F2937; margin-bottom: 5px;" id="qrStudentName"></p>                
                            <p style="font-size: 14px; color: #6B7280; margin-bottom: 15px;" id="qrStudentDetails"></p>
                            
                            <!-- QR Code will be generated here -->                                
                            <div id="qrcode-container" style="display: flex; justify-content: center; margin: 20px 0;"></div>                                
                            
                            <p style="font-size: 16px; font-weight: 600; color: #2563EB;" id="qrStudentId"></p>            
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">                
                            <button class="btn btn-primary" onclick="downloadQRCode()">        
                                üíæ Download QR Code            
                            </button>                
                            <button class="btn btn-success" onclick="downloadStudentCard()">                    
                                üé´ Download ID Card        
                            </button>            
                        </div>        
                    </div>    
                </div>
            </div>
    
            <!-- Timetable Modal -->   
            <div class="modal" id="timetableModal">       
                <div class="modal-content">           
                    <div class="modal-header">                
                        <h3 class="modal-title" id="timetableModalTitle">Add Class</h3>                
                        <button class="close-btn" onclick="closeTimetableModal()">‚úñ</button>            
                    </div>           
                    <div class="form-group">                
                        <label>Day</label>                
                        <select id="timetableDay">                    
                            <option>Monday</option>                   
                            <option>Tuesday</option>                    
                            <option>Wednesday</option>                    
                            <option>Thursday</option>                    
                            <option>Friday</option>                   
                            <option>Saturday</option>                    
                            <option>Sunday</option>               
                        </select>            
                    </div>            
                    <div class="form-group">                
                        <label>Time</label>                
                        <input type="time" id="timetableTime">           
                    </div>            
                    <div class="form-group">                
                        <label>Grade</label>                
                        <select id="timetableGrade"></select>            
                    </div>           
                    <div class="form-group">                
                        <label>Notes</label>               
                        <input type="text" id="timetableNotes" placeholder="e.g., Room 101">           
                    </div>            
                    <button class="btn btn-primary" onclick="saveTimetableEntry()">üíæ Save</button>        
                </div>    
            </div>
    
            <!-- Payment Modal -->
            <div class="modal" id="paymentModal">        
                <div class="modal-content">            
                    <div class="modal-header">                
                        <h3 class="modal-title">Record Payment</h3>                
                        <button class="close-btn" onclick="closePaymentModal()">‚úñ</button>            
                    </div>            
                    <div class="form-group">                
                        <label>Amount</label>                
                        <input type="number" id="paymentAmount" placeholder="Enter amount">            
                    </div>            
                    <div class="form-group">                
                        <label>Date</label>                
                        <input type="date" id="paymentDate">            
                    </div>            
                    <div class="form-group">                
                        <label>Month</label>                
                        <input type="month" id="paymentMonth">            
                    </div>            
                    <div class="form-group">                
                        <label>Method</label>                
                        <select id="paymentMethod">                    
                            <option>Cash</option>                    
                            <option>Bank Transfer</option>                    
                            <option>Mobile Payment</option>              
                        </select>            
                    </div>         
                    <button class="btn btn-primary" onclick="savePayment()">üíæ Record</button>        
                </div>    
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        
        const firebaseConfig = {          
            apiKey: "AIzaSyD4z857J2ipSxqK8pN4tEWqU-jeK_mwA2I",          
            authDomain: "class-manager-383ad.firebaseapp.com",          
            databaseURL: "https://class-manager-383ad-default-rtdb.asia-southeast1.firebasedatabase.app",          
            projectId: "class-manager-383ad",          
            storageBucket: "class-manager-383ad.firebasestorage.app",          
            messagingSenderId: "1085651561679",          
            appId: "1:1085651561679:web:82ca82d59d6ff2ec671bba"    
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let currentUserId = null;
        let lastSyncedTimestamp = null;
        
        // ============================================
        // PAYHERE & APP DATA
        // ============================================
        
        // PayHere Configuration
        const PAYHERE_CONFIG = {    
            merchantId: '1221149',
            sandbox: true,
            returnUrl: window.location.href,
            cancelUrl: window.location.href,
            notifyUrl: 'https://yourwebsite.com/notify',
            businessName: 'Class Manager',
            currency: 'LKR'
        };
 
        // Subscription prices in LKR
        const SUBSCRIPTION_PRICES = {    
            monthly: {        
                amount: 1000.00,
                currency: 'LKR',        
                description: 'Class Manager - Monthly Subscription'   
            },    
            annual: {        
                amount: 9600.00,
                currency: 'LKR',
                description: 'Class Manager - Annual Subscription'
            }
        };

        let appData = {    
            students: [],    
            grades: ['06', '07', '08', '09', '10', '11', '12'],    
            timetable: [],    
            attendance: {},    
            payments: [],    
            subjectName: 'Mathematics',    
            selectedStudent: null,    
            editingTimetable: null,   
            selectedPaymentStudent: null,   
            subscription: {        
                plan: 'free_trial',
                status: 'active',
                startDate: new Date().toISOString(),        
                endDate: null,        
                maxStudents: 10,
                features: {            
                    students: true,            
                    attendance: true,            
                    payments: true,            
                    reports: true,            
                    backup: true        
                }    
            }
        };

        // ============================================
        // CHECK AUTHENTICATION
        // ============================================

        auth.onAuthStateChanged((user) => {    
            if (user) {        
                currentUser = user;        
                currentUserId = user.uid;
                
                console.log('‚úÖ User authenticated:', user.email);        
                console.log('User ID:', currentUserId);
                
                setTimeout(() => {            
                    const loader = document.getElementById('loader');            
                    if (loader) {                
                        loader.classList.add('hide-loader');                
                        setTimeout(() => {                    
                            loader.style.display = 'none';                
                        }, 600);            
                    }        
                }, 1000);
                
                initializeApp();
            
            } else {        
                console.log('‚ùå No user authenticated, redirecting...');        
                window.location.href = 'index.html';    
            }
        });
        
        // ============================================
        // LOGOUT FUNCTION
        // ============================================

        function logout() {    
            if (!confirm('Are you sure you want to sign out?')) {        
                return;    
            }
    
            auth.signOut()        
                .then(() => {            
                    console.log('‚úÖ User logged out');            
                    window.location.href = 'index.html';        
                })        
                .catch((error) => {            
                    console.error('Logout error:', error);            
                    alert('‚ùå Error signing out: ' + error.message);        
                });
        }

        // ============================================
        // INITIALIZE APP
        // ============================================

        function initializeApp() {    
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');    
            console.log('‚ïë   APP INITIALIZATION                   ‚ïë');    
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');    
            console.log('User:', currentUser.email);    
            console.log('UID:', currentUserId);
        
            loadData();
            initializeSubscription();
            enableRealtimeSync();
        
            console.log('‚úÖ App initialized');
        }
        
        // ============================================
        // SAVE DATA TO FIREBASE
        // ============================================

        function saveData() {    
            if (!currentUserId) {        
                console.error('‚ùå No user authenticated');        
                return false;    
            }
        
            try {        
                const dataToSave = {            
                    ...appData,            
                    lastSaved: new Date().toISOString()        
                };
                
                console.log('üíæ Saving data for:', currentUserId);
                
                updateSyncStatus('syncing');
                
                database.ref('users/' + currentUserId + '/data').set(dataToSave)            
                    .then(() => {                
                        console.log('‚úÖ Data saved to Firebase');                
                        localStorage.setItem('classManagerData_' + currentUserId, JSON.stringify(dataToSave));
                        
                        updateLastSavedTime();
                        updateSyncStatus('synced');
                    })            
                    .catch((error) => {                
                        console.error('‚ùå Firebase save error:', error);                
                        localStorage.setItem('classManagerData_' + currentUserId, JSON.stringify(dataToSave));
                        updateSyncStatus('error');            
                    });
                
                return true;    
            } catch (error) {        
                console.error('‚ùå Error saving data:', error);        
                return false;    
            }
        }

        // ============================================
        // LOAD DATA FUNCTION
        // ============================================

        function loadData() {    
            if (!currentUserId) {        
                console.error('‚ùå No user authenticated');        
                return;    
            }
        
            console.log('üì• Loading data for:', currentUserId);
       
            database.ref('users/' + currentUserId + '/data').once('value')        
                .then((snapshot) => {            
                    const firebaseData = snapshot.val();
                        
                    if (firebaseData) {                
                        console.log('‚úÖ Data loaded from Firebase');
                               
                        appData = {                    
                            ...appData,                    
                            ...firebaseData,                    
                            students: firebaseData.students || [],                    
                            timetable: firebaseData.timetable || [],                    
                            payments: firebaseData.payments || [],                    
                            attendance: firebaseData.attendance || {},                    
                            grades: firebaseData.grades || ['06', '07', '08', '09', '10', '11', '12']                
                        };
                                
                        localStorage.setItem('classManagerData_' + currentUserId, JSON.stringify(appData));            
                    } else {                
                        console.log('‚ÑπÔ∏è No Firebase data, checking localStorage...');
                                
                        const localData = localStorage.getItem('classManagerData_' + currentUserId);                
                        if (localData) {                   
                            const parsedData = JSON.parse(localData);                    
                            appData = { ...appData, ...parsedData };                    
                            saveData();                    
                            console.log('‚úÖ Local data uploaded to Firebase');                
                        } else {                    
                            console.log('‚ÑπÔ∏è No saved data, using defaults');                
                        }            
                    }
                        
                    populateGradeDropdowns();
                    updateDashboard();
                    updateSyncStatus('synced');
                    displayTeacherId();
                })        
                .catch((error) => {            
                    console.error('‚ùå Firebase load error:', error);
                        
                    const localData = localStorage.getItem('classManagerData_' + currentUserId);            
                    if (localData) {                
                        appData = { ...appData, ...JSON.parse(localData) };                
                        console.log('‚úÖ Loaded from localStorage (fallback)');            
                    }
                        
                    populateGradeDropdowns();
                    updateDashboard();
                    updateSyncStatus('error');
                });        
        }

        // ============================================
        // REAL-TIME SYNC FUNCTION (FIXED)
        // ============================================

        function enableRealtimeSync() {    
            if (!currentUserId) {        
                console.warn('‚ö†Ô∏è Cannot enable sync: No user');        
                return;    
            }
        
            console.log('üîÑ Real-time sync enabled');
        
            database.ref('users/' + currentUserId + '/data').on('value', (snapshot) => {        
                const data = snapshot.val();
                
                if (data && data.lastSaved) {
                    // Only update if the remote data is newer than what we have
                    if (!lastSyncedTimestamp || data.lastSaved > lastSyncedTimestamp) {
                        lastSyncedTimestamp = data.lastSaved;
                        
                        console.log('üîÑ Data updated from cloud');
                        
                        appData = {                
                            ...appData,                
                            ...data,                
                            students: data.students || [],                
                            timetable: data.timetable || [],                
                            payments: data.payments || [],                
                            attendance: data.attendance || {},                
                            grades: data.grades || ['06', '07', '08', '09', '10', '11', '12']            
                        };
                        
                        localStorage.setItem('classManagerData_' + currentUserId, JSON.stringify(appData));
                        
                        // Refresh current screen
                        const activeScreen = document.querySelector('.screen.active');           
                        if (activeScreen) {                
                            const screenId = activeScreen.id;                
                            if (screenId === 'students') loadStudentsScreen();
                            if (screenId === 'timetable') loadTimetable();
                            if (screenId === 'payments') loadPaymentHistory();
                            if (screenId === 'dashboard') updateDashboard();
                        }
                    }
                }    
            }, (error) => {        
                console.error('‚ùå Sync error:', error);    
            });
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function updateSyncStatus(status) {    
            const syncIcon = document.getElementById('syncIcon');    
            const syncText = document.getElementById('syncText');    
    
            if (!syncIcon || !syncText) return;
        
            if (status === 'syncing') {        
                syncIcon.textContent = 'üîÑ';        
                syncText.textContent = 'Syncing...';    
            } else if (status === 'synced') {        
                syncIcon.textContent = '‚òÅÔ∏è';        
                syncText.textContent = 'Synced';    
            } else if (status === 'error') {        
                syncIcon.textContent = '‚ö†Ô∏è';        
                syncText.textContent = 'Offline';    
            }
        }

        function updateLastSavedTime() {    
            const lastSavedEl = document.getElementById('lastSavedTime');    
            if (lastSavedEl && appData.lastSaved) {        
                const savedDate = new Date(appData.lastSaved);        
                lastSavedEl.textContent = savedDate.toLocaleString();    
            }
        }
        
        function manualSync() {    
            if (!currentUserId) {        
                alert('‚ùå No user ID found. Please refresh the page.');        
                return;    
            }
       
            console.log('üîÑ Manual sync started for user:', currentUserId);    
            updateSyncStatus('syncing');
        
            database.ref('users/' + currentUserId + '/data').once('value')        
                .then((snapshot) => {            
                    const data = snapshot.val();
                      
                    if (data) {                
                        console.log('‚úÖ Data retrieved from Firebase');                
                        appData = {                   
                            ...appData,                    
                            ...data,                    
                            students: data.students || [],                    
                            timetable: data.timetable || [],                    
                            payments: data.payments || [],                    
                            attendance: data.attendance || {},                    
                            grades: data.grades || ['06', '07', '08', '09', '10', '11', '12']                
                        };
                               
                        localStorage.setItem('classManagerData_' + currentUserId, JSON.stringify(appData));
                                
                        updateDashboard();                
                        const activeScreen = document.querySelector('.screen.active');               
                        if (activeScreen && activeScreen.id === 'students') {                    
                            loadStudentsScreen();                                        
                        }
                                
                        updateSyncStatus('synced');                
                        alert('‚úÖ Data synced successfully!');            
                    } else {                
                        console.log('‚ÑπÔ∏è No data in Firebase, uploading local data...');                
                        saveData();                
                        updateSyncStatus('synced');                
                        alert('‚úÖ Local data uploaded to cloud!');            
                    }        
                })        
                .catch((error) => {            
                    console.error('‚ùå Sync error:', error);            
                    updateSyncStatus('error');
                        
                    let errorMsg = 'Sync failed: ' + error.message;
                        
                    if (error.code === 'PERMISSION_DENIED') {                
                        errorMsg = '‚ùå Permission Denied\n\nPlease check:\n1. Firebase Database Rules\n2. Database URL is correct';            
                    }
                
                    alert(errorMsg);       
                });
        }

        function displayTeacherId() {    
            const teacherIdEl = document.getElementById('teacherIdDisplay');    
            if (teacherIdEl && currentUserId) {        
                teacherIdEl.textContent = currentUserId;    
            }
        }

        function copyTeacherId() {    
            if (navigator.clipboard && currentUserId) {        
                navigator.clipboard.writeText(currentUserId);        
                alert('‚úÖ Teacher ID copied to clipboard!');    
            }
        }

        // ============================================
        // NAVIGATION AND UI FUNCTIONS
        // ============================================

        function navigateTo(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-screen="${screenName}"]`);
            
            if (menuItem) menuItem.classList.add('active');
            
            toggleSidebar();
            
            if (screenName === 'students') loadStudentsScreen();
            if (screenName === 'timetable') loadTimetable();
            if (screenName === 'attendance') {
                const dateInput = document.getElementById('attendanceDateSelect');
                if (dateInput && !dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }
            if (screenName === 'payments') loadPaymentHistory();
            if (screenName === 'settings') loadSettings();
            if (screenName === 'subscription') updateSubscriptionDisplay();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function populateGradeDropdowns() {
            const html = appData.grades.map(g => `<option value="${g}">Grade ${g}</option>`).join('');
        
            const gradeFilter = document.getElementById('gradeFilter');
            if (gradeFilter) {
                gradeFilter.innerHTML = '<option value="all">All Grades</option>' + html;
            }
    
            const studentGradeInput = document.getElementById('studentGradeInput');
            if (studentGradeInput) {
                studentGradeInput.innerHTML = '<option value="">Select Grade</option>' + html;
            }
    
            const attendanceClassSelect = document.getElementById('attendanceClassSelect');
            if (attendanceClassSelect) {
                attendanceClassSelect.innerHTML = '<option value="">Choose a class</option>' + html;
            }
    
            const timetableGrade = document.getElementById('timetableGrade');
            if (timetableGrade) {
                timetableGrade.innerHTML = html;
            }
    
            const reportGrade = document.getElementById('reportGrade');
            if (reportGrade) {
                reportGrade.innerHTML = '<option value="all">All Grades</option>' + html;
            }
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================

        function updateDashboard() {
            const filter = document.getElementById('gradeFilter').value;
            const filtered = filter === 'all' ? appData.students : appData.students.filter(s => s.grade === filter);
            
            document.getElementById('totalStudents').textContent = filtered.length;
            
            const today = new Date().getDay();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayClasses = appData.timetable.filter(t => t.day === days[today]);
            document.getElementById('todayClasses').textContent = todayClasses.length;
            
            const pending = getPendingPayments().length;
            document.getElementById('pendingPayments').textContent = pending;
            
            document.getElementById('attendanceRate').textContent = getTodayAttendanceRate();
            
            const list = document.getElementById('todayClassesList');
            if (todayClasses.length === 0) {
                list.innerHTML = '<p style="color: #6B7280; font-size: 14px;">No classes today</p>';
            } else {
                list.innerHTML = todayClasses.map(c => `
                    <div style="padding: 12px; background: #EFF6FF; border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600;">Grade ${c.grade}</div>
                        <div style="font-size: 14px; color: #6B7280;">${c.time}</div>
                    </div>
                `).join('');
            }
        }

        function getPendingPayments() {
            const current = new Date();
            return appData.students.filter(student => {
                const payments = appData.payments.filter(p => p.studentId === student.id);
                if (payments.length === 0 && current.getDate() > 14) return true;
                if (payments.length > 0) {
                    const last = payments[payments.length - 1];
                    const payDate = new Date(last.date);
                    const months = (current.getFullYear() - payDate.getFullYear()) * 12 + (current.getMonth() - payDate.getMonth());
                    return months > 0 && current.getDate() > 14;
                }
                return false;
            });
        }

        function getTodayAttendanceRate() {
            const today = new Date().toISOString().split('T')[0];
            const att = appData.attendance[today] || {};
            const total = Object.keys(att).length;
            if (total === 0) return '0%';
            const present = Object.values(att).filter(s => s === 'present').length;
            return Math.round((present / total) * 100) + '%';
        }

        // ============================================
        // STUDENT MANAGEMENT
        // ============================================

        let currentSelectedGradeTab = 'all';
        let selectedStudentForEdit = null;

        function loadStudentsScreen() {
            populateStudentGradeDropdown();
            createGradeTabs();
            filterStudentsByTab();
        }

        function populateStudentGradeDropdown() {
            const gradeSelect = document.getElementById('studentGradeInput');
            if (gradeSelect) {
                gradeSelect.innerHTML = '<option value="">Select Grade</option>' + 
                    appData.grades.map(g => `<option value="${g}">Grade ${g}</option>`).join('');
            }
        }

        function createGradeTabs() {
            const tabsContainer = document.getElementById('gradeTabs');
            if (tabsContainer) {
                tabsContainer.innerHTML = appData.grades.map(g => `
                    <button class="grade-tab" data-grade="${g}" onclick="switchGradeTab('${g}')">
                        Grade ${g}
                    </button>
                `).join('');
            }
        }

        function switchGradeTab(grade) {
            currentSelectedGradeTab = grade;
            
            document.querySelectorAll('.grade-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.grade-tab[data-grade="${grade}"]`).classList.add('active');
            
            filterStudentsByTab();
        }

        function filterStudentsByTab() {
            const searchTerm = document.getElementById('studentSearchBox').value.toLowerCase();
            
            let filtered = appData.students;
            
            if (currentSelectedGradeTab !== 'all') {
                filtered = filtered.filter(s => s.grade === currentSelectedGradeTab);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.name.toLowerCase().includes(searchTerm) ||
                    s.id.includes(searchTerm) ||
                    (s.studentPhone && s.studentPhone.includes(searchTerm)) ||
                    (s.parentPhone && s.parentPhone.includes(searchTerm))
                );
            }
            
            displayStudentList(filtered);
        }

        function displayStudentList(students) {    
            const listContainer = document.getElementById('studentListByGrade');
        
            if (students.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #6B7280; padding: 40px;">No students found</p>';        
                return;    
            }
        
            listContainer.innerHTML = students.map(s => `                    
                <div class="student-card ${selectedStudentForEdit?.id === s.id ? 'selected' : ''}"                             
                    onclick='selectStudentForEdit(${JSON.stringify(s).replace(/'/g, "&apos;")})'>                            
                    <div style="display: flex; justify-content: space-between; align-items: center;">                                    
                        <div style="flex: 1;">                                
                            <div class="student-card-name">${s.name}</div>                                            
                            <div class="student-card-details">                                            
                                ID: ${s.id}<br>                                                    
                                Grade ${s.grade} - Class ${s.class || 'N/A'} | ${s.gender || 'N/A'}<br>                                                    
                                Parent: ${s.parentPhone || 'N/A'}   
                            </div>                                
                        </div>                    
                        <button onclick='event.stopPropagation(); showQRCode(${JSON.stringify(s).replace(/'/g, "&apos;")})'                         
                                style="background: #2563EB; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">                    
                            üì± QR                                    
                        </button>            
                    </div>
                </div>        
            `).join(''); 
        }

        function selectStudentForEdit(student) {
            selectedStudentForEdit = student;
            
            document.getElementById('studentFormTitle').textContent = 'Edit Student';
            document.getElementById('studentNameInput').value = student.name;
            document.getElementById('studentBirthdayInput').value = student.birthday || '';
            document.getElementById('studentGenderInput').value = student.gender || '';
            document.getElementById('studentClassInput').value = student.class || '';
            document.getElementById('studentGradeInput').value = student.grade;
            document.getElementById('studentPhoneInput').value = student.studentPhone || '';
            document.getElementById('parentPhoneInput').value = student.parentPhone || '';
            
            document.getElementById('studentIdDisplay').value = student.id;
            document.getElementById('studentIdDisplaySection').style.display = 'block';
            
            document.getElementById('addStudentBtn').style.display = 'none';
            document.getElementById('updateStudentBtn').style.display = 'block';
            document.getElementById('deleteStudentBtn').style.display = 'block';
            
            filterStudentsByTab();
        }

        function addNewStudent() {
            if (!canAddStudent()) {       
                return;    
            }
            
            const name = document.getElementById('studentNameInput').value.trim();
            const birthday = document.getElementById('studentBirthdayInput').value;
            const gender = document.getElementById('studentGenderInput').value;
            const studentClass = document.getElementById('studentClassInput').value;
            const grade = document.getElementById('studentGradeInput').value;
            const studentPhone = document.getElementById('studentPhoneInput').value.trim();
            const parentPhone = document.getElementById('parentPhoneInput').value.trim();
            
            if (!name) {
                alert('Please enter student name');
                return;
            }
            if (!birthday) {
                alert('Please select birthday');
                return;
            }
            if (!gender) {
                alert('Please select gender');
                return;
            }
            if (!studentClass) {
                alert('Please select class');
                return;
            }
            if (!grade) {
                alert('Please select grade');
                return;
            }
            if (!parentPhone) {
                alert('Please enter parent\'s phone number');
                return;
            }
            
            const studentId = generateStudentId(grade);
            
            const newStudent = {
                id: studentId,
                name: name,
                birthday: birthday,
                gender: gender,
                class: studentClass,
                grade: grade,
                studentPhone: studentPhone,
                parentPhone: parentPhone,
                qrCode: studentId
            };
            
            appData.students.push(newStudent);
            saveData();
            
            filterStudentsByTab();
            clearStudentForm();
            
            alert('‚úÖ Student added successfully!\n\nStudent ID: ' + studentId);
        }

        function updateExistingStudent() {
            if (!selectedStudentForEdit) return;
            
            const name = document.getElementById('studentNameInput').value.trim();
            const birthday = document.getElementById('studentBirthdayInput').value;
            const gender = document.getElementById('studentGenderInput').value;
            const studentClass = document.getElementById('studentClassInput').value;
            const grade = document.getElementById('studentGradeInput').value;
            const studentPhone = document.getElementById('studentPhoneInput').value.trim();
            const parentPhone = document.getElementById('parentPhoneInput').value.trim();
            
            if (!name || !birthday || !gender || !studentClass || !grade || !parentPhone) {
                alert('Please fill in all required fields');
                return;
            }
            
            appData.students = appData.students.map(s => {
                if (s.id === selectedStudentForEdit.id) {
                    return {
                        ...s,
                        name: name,
                        birthday: birthday,
                        gender: gender,
                        class: studentClass,
                        grade: grade,
                        studentPhone: studentPhone,
                        parentPhone: parentPhone
                    };
                }
                return s;
            });
            
            saveData();
            filterStudentsByTab();
            clearStudentForm();
            
            alert('‚úÖ Student updated successfully!');
        }

        function deleteExistingStudent() {
            if (!selectedStudentForEdit) return;
            
            if (!confirm(`Are you sure you want to delete this student?\n\nName: ${selectedStudentForEdit.name}\nID: ${selectedStudentForEdit.id}`)) {
                return;
            }
            
            appData.students = appData.students.filter(s => s.id !== selectedStudentForEdit.id);
            saveData();
            
            filterStudentsByTab();
            clearStudentForm();
            
            alert('‚úÖ Student deleted successfully!');
        }

        function clearStudentForm() {
            selectedStudentForEdit = null;
            
            document.getElementById('studentFormTitle').textContent = 'Add New Student';
            document.getElementById('studentNameInput').value = '';
            document.getElementById('studentBirthdayInput').value = '';
            document.getElementById('studentGenderInput').value = '';
            document.getElementById('studentClassInput').value = '';
            document.getElementById('studentGradeInput').value = '';
            document.getElementById('studentPhoneInput').value = '';
            document.getElementById('parentPhoneInput').value = '';
            
            document.getElementById('studentIdDisplaySection').style.display = 'none';
            
            document.getElementById('addStudentBtn').style.display = 'block';
            document.getElementById('updateStudentBtn').style.display = 'none';
            document.getElementById('deleteStudentBtn').style.display = 'none';
            
            filterStudentsByTab();
        }

        function generateStudentId(grade) {
            const year = new Date().getFullYear();
            const gradeStudents = appData.students.filter(s => s.grade === grade);
            const nextNumber = String(gradeStudents.length + 1).padStart(3, '0');
            return `${year}${grade}${nextNumber}`;
        }
        
        function showQRCodeForCurrentStudent() {    
            if (!selectedStudentForEdit) {        
                alert('No student selected');        
                return;    
            }
        
            showQRCode(selectedStudentForEdit);
        }

        // ============================================
        // EXCEL EXPORT FUNCTIONS
        // ============================================

        function exportStudentsToExcel() {    
            try {        
                const students = appData.students;
               
                if (students.length === 0) {            
                    alert('‚ö†Ô∏è No students to export!\n\nPlease add students first.');            
                    return;       
                }
                
                const data = [];
                
                data.push([            
                    'Student ID',            
                    'Name',            
                    'Birthday',            
                    'Age',           
                    'Gender',            
                    'Class',            
                    'Grade',            
                    'Student Phone',            
                    'Parent Phone'        
                ]);
            
                students.forEach(s => {          
                    let age = '';                               
                    if (s.birthday) {                
                        const birthDate = new Date(s.birthday);                
                        const today = new Date();                
                        age = today.getFullYear() - birthDate.getFullYear();                
                        const monthDiff = today.getMonth() - birthDate.getMonth();                
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {                    
                            age--;                
                        }            
                    }
                        
                    data.push([                
                        s.id,                
                        s.name,               
                        s.birthday || '',                
                        age,                
                        s.gender || '',                
                        s.class || '',                
                        s.grade,                
                        s.studentPhone || '',                
                        s.parentPhone || ''            
                    ]);        
                });
                
                const wb = XLSX.utils.book_new();        
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                ws['!cols'] = [           
                    { wch: 15 },
                    { wch: 25 },
                    { wch: 12 },
                    { wch: 6 },
                    { wch: 10 },
                    { wch: 8 },
                    { wch: 8 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Students');
                
                const fileName = `Students_List_${new Date().toISOString().split('T')[0]}.xlsx`;        
                XLSX.writeFile(wb, fileName);
               
                alert(`‚úÖ Students exported successfully!\n\nFile: ${fileName}\nTotal Students: ${students.length}`);    
            } catch (error) {        
                console.error('‚ùå Export error:', error);        
                alert('‚ö†Ô∏è Error exporting students to Excel.');    
            }
        }

        function exportStudentsByGrade() {    
            try {        
                if (appData.students.length === 0) {            
                    alert('‚ö†Ô∏è No students to export!');           
                    return;        
                }
                
                const wb = XLSX.utils.book_new();        
                let totalExported = 0;        
        
                appData.grades.forEach(grade => {            
                    const gradeStudents = appData.students.filter(s => s.grade === grade);
                        
                    if (gradeStudents.length > 0) {                
                        const data = [];
                                
                        data.push([                    
                            'Student ID',                    
                            'Name',                    
                            'Birthday',                    
                            'Gender',                    
                            'Class',                    
                            'Student Phone',                    
                            'Parent Phone'                
                        ]);
                                
                        gradeStudents.forEach(s => {                    
                            data.push([                      
                                s.id,                        
                                s.name,                        
                                s.birthday || '',                        
                                s.gender || '',                       
                                s.class || '',                       
                                s.studentPhone || '',                        
                                s.parentPhone || ''                    
                            ]);                
                        });
                               
                        const ws = XLSX.utils.aoa_to_sheet(data);                
                        ws['!cols'] = [                    
                            { wch: 15 },                    
                            { wch: 25 },                    
                            { wch: 12 },                   
                            { wch: 10 },                    
                            { wch: 8 },                    
                            { wch: 15 },                    
                            { wch: 15 }              
                        ];
                                
                        XLSX.utils.book_append_sheet(wb, ws, `Grade ${grade}`);               
                        totalExported += gradeStudents.length;            
                    }        
                });        
                
                const fileName = `Students_By_Grade_${new Date().toISOString().split('T')[0]}.xlsx`;        
                XLSX.writeFile(wb, fileName);   
        
                alert(`‚úÖ Students exported by grade!\n\nFile: ${fileName}\nTotal Students: ${totalExported}\nGrades: ${appData.grades.length}`);   
            } catch (error) {        
                console.error('‚ùå Export error:', error);        
                alert('‚ö†Ô∏è Error exporting students.');    
            }
        }

        function exportCurrentGradeStudents() {    
            try {        
                const grade = currentSelectedGradeTab;
                
                let students;                      
                if (grade === 'all') {          
                    students = appData.students;        
                } else {           
                    students = appData.students.filter(s => s.grade === grade);       
                }
                
                if (students.length === 0) {           
                    alert('‚ö†Ô∏è No students in this grade!');            
                    return;        
                }
                
                const data = [];
                
                data.push([            
                    'Student ID',            
                    'Name',            
                    'Birthday',            
                    'Gender',            
                    'Class',            
                    'Student Phone',            
                    'Parent Phone'        
                ]);
                
                students.forEach(s => {            
                    data.push([                
                        s.id,                
                        s.name,                
                        s.birthday || '',                
                        s.gender || '',                
                        s.class || '',                
                        s.studentPhone || '',
                        s.parentPhone || ''            
                    ]);        
                });
                
                const wb = XLSX.utils.book_new();        
                const ws = XLSX.utils.aoa_to_sheet(data);
               
                ws['!cols'] = [           
                    { wch: 15 },            
                    { wch: 25 },            
                    { wch: 12 },            
                    { wch: 10 },            
                    { wch: 8 },            
                    { wch: 15 },            
                    { wch: 15 }        
                ];        
        
                XLSX.utils.book_append_sheet(wb, ws, grade === 'all' ? 'All Students' : `Grade ${grade}`);       
        
                const fileName = `Students_${grade === 'all' ? 'All' : 'Grade_' + grade}_${new Date().toISOString().split('T')[0]}.xlsx`;       
                XLSX.writeFile(wb, fileName);
                
                alert(`‚úÖ Exported successfully!\n\nFile: ${fileName}\nStudents: ${students.length}`);    
            } catch (error) {        
                console.error('‚ùå Export error:', error);        
                alert('‚ö†Ô∏è Error exporting students.');    
            }
        }

        function exportAllDataToExcel() {   
            try {        
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Students        
                const studentsData = [
                    ['Student ID', 'Name', 'Birthday', 'Gender', 'Class', 'Grade', 'Student Phone', 'Parent Phone']        
                ];        
                appData.students.forEach(s => {            
                    studentsData.push([                
                        s.id,               
                        s.name,                
                        s.birthday || '',                
                        s.gender || '',                
                        s.class || '',                
                        'Grade ' + s.grade,                
                        s.studentPhone || '',                
                        s.parentPhone || ''            
                    ]);        
                });        
                const wsStudents = XLSX.utils.aoa_to_sheet(studentsData);        
                XLSX.utils.book_append_sheet(wb, wsStudents, 'Students');
                
                // Sheet 2: Payments        
                const paymentsData = [            
                    ['Date', 'Student ID', 'Student Name', 'Grade', 'Month', 'Amount', 'Status']        
                ];        
                (appData.payments || []).forEach(p => {            
                    paymentsData.push([                
                        p.date,                
                        p.studentId,                
                        p.studentName,                
                        p.class,                
                        p.month,                
                        p.amount,                
                        p.status            
                    ]);        
                });        
                const wsPayments = XLSX.utils.aoa_to_sheet(paymentsData);        
                XLSX.utils.book_append_sheet(wb, wsPayments, 'Payments');
                
                // Sheet 3: Timetable        
                const timetableData = [            
                    ['Day', 'Time', 'Grade', 'Notes']        
                ];        
                appData.timetable.forEach(t => {            
                    timetableData.push([                
                        t.day,                
                        t.time,                
                        'Grade ' + t.grade,               
                        t.notes || ''            
                    ]);        
                });        
                const wsTimetable = XLSX.utils.aoa_to_sheet(timetableData);        
                XLSX.utils.book_append_sheet(wb, wsTimetable, 'Timetable');
               
                // Sheet 4: Attendance Summary        
                const attendanceData = [            
                    ['Date', 'Grade', 'Total Students', 'Present', 'Absent', 'Rate']        
                ];
                
                Object.keys(appData.attendance || {}).forEach(date => {            
                    const dayData = appData.attendance[date];            
                    const total = Object.keys(dayData).length;            
                    const present = Object.values(dayData).filter(s => s === 'present').length;            
                    const absent = total - present;            
                    const rate = total > 0 ? Math.round((present / total) * 100) + '%' : '0%';
                        
                    const firstStudentId = Object.keys(dayData)[0];            
                    const student = appData.students.find(s => s.id === firstStudentId);            
                    const grade = student ? 'Grade ' + student.grade : 'N/A';
                        
                    attendanceData.push([                
                        date,                
                        grade,                
                        total,                
                        present,                
                        absent,               
                        rate            
                    ]);        
                });        
                const wsAttendance = XLSX.utils.aoa_to_sheet(attendanceData);        
                XLSX.utils.book_append_sheet(wb, wsAttendance, 'Attendance');
                
                const fileName = `ClassManager_Complete_Export_${new Date().toISOString().split('T')[0]}.xlsx`;        
                XLSX.writeFile(wb, fileName);
                            
                alert('‚úÖ All data exported to Excel!\n\nFile: ' + fileName + '\n\nSheets:\n- Students\n- Payments\n- Timetable\n- Attendance');                
            } catch (error) {        
                console.error('‚ùå Export error:', error);        
                alert('‚ö†Ô∏è Error exporting data to Excel.');    
            }
        }

        // ============================================
        // TIMETABLE FUNCTIONS
        // ============================================
        
        function loadTimetable() {
            const tbody = document.getElementById('timetableTableBody');
            if (appData.timetable.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6B7280;">No classes</td></tr>';
                return;
            }
            tbody.innerHTML = appData.timetable.map(t => `
                <tr>
                    <td>${t.day}</td>
                    <td>${t.time}</td>
                    <td><span class="badge badge-blue">Grade ${t.grade}</span></td>
                    <td>${t.notes || '-'}</td>
                    <td>
                        <button class="icon-btn icon-btn-blue" onclick='editTimetable(${JSON.stringify(t)})'>‚úèÔ∏è</button>
                        <button class="icon-btn icon-btn-red" onclick="deleteTimetable('${t.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddTimetable() {
            appData.editingTimetable = null;
            document.getElementById('timetableModalTitle').textContent = 'Add Class';
            document.getElementById('timetableDay').value = 'Monday';
            document.getElementById('timetableTime').value = '';
            document.getElementById('timetableGrade').value = appData.grades[0];
            document.getElementById('timetableNotes').value = '';
            document.getElementById('timetableModal').classList.add('active');
        }

        function editTimetable(entry) {
            appData.editingTimetable = entry;
            document.getElementById('timetableModalTitle').textContent = 'Edit Class';
            document.getElementById('timetableDay').value = entry.day;
            document.getElementById('timetableTime').value = entry.time;
            document.getElementById('timetableGrade').value = entry.grade;
            document.getElementById('timetableNotes').value = entry.notes || '';
            document.getElementById('timetableModal').classList.add('active');
        }

        function closeTimetableModal() {
            document.getElementById('timetableModal').classList.remove('active');
        }

        function saveTimetableEntry() {
            const day = document.getElementById('timetableDay').value;
            const time = document.getElementById('timetableTime').value;
            const grade = document.getElementById('timetableGrade').value;
            const notes = document.getElementById('timetableNotes').value;
            
            if (!time) {
                alert('Enter time');
                return;
            }
            
            if (appData.editingTimetable) {
                appData.timetable = appData.timetable.map(t => t.id === appData.editingTimetable.id ? { ...t, day, time, grade, notes } : t);
            } else {
                appData.timetable.push({ id: Date.now().toString(), day, time, grade, notes });
            }
            
            saveData();
            closeTimetableModal();
            loadTimetable();
            updateDashboard();
            alert('Saved!');
        }

        function deleteTimetable(id) {
            if (!confirm('Delete?')) return;
            appData.timetable = appData.timetable.filter(t => t.id !== id);
            saveData();
            loadTimetable();
            updateDashboard();
        }
        
        // ============================================
        // PAYMENT MANAGEMENT FUNCTIONS
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            const studentIdInput = document.getElementById('paymentStudentId');
            if (studentIdInput) {
                studentIdInput.addEventListener('input', function() {
                    const studentId = this.value.trim();
                    const student = appData.students.find(s => s.id === studentId);
                    
                    if (student) {
                        document.getElementById('paymentClass').value = 'Grade ' + student.grade;
                    } else {
                        document.getElementById('paymentClass').value = '';
                    }
                });
            }
        });

        function recordPayment() {
            const studentId = document.getElementById('paymentStudentId').value.trim();
            const month = document.getElementById('paymentMonthDropdown').value;
            const amount = document.getElementById('paymentAmountInput').value.trim();
            const status = document.getElementById('paymentStatusDropdown').value;

            if (!studentId) {
                alert('Please enter Student ID');
                return;
            }

            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                alert('Student ID not found!');
                return;
            }

            if (!month) {
                alert('Please select Month');
                return;
            }

            if (!amount && status !== 'Free Card') {
                alert('Please enter Amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                studentId: studentId,
                studentName: student.name,
                class: 'Grade ' + student.grade,
                month: month,
                amount: status === 'Free Card' ? 0 : parseFloat(amount),
                status: status
            };

            if (!appData.payments) appData.payments = [];
            appData.payments.push(payment);
            
            saveData();
            loadPaymentHistory();

            document.getElementById('paymentStudentId').value = '';
            document.getElementById('paymentClass').value = '';
            document.getElementById('paymentMonthDropdown').value = '';
            document.getElementById('paymentAmountInput').value = '';
            document.getElementById('paymentStatusDropdown').value = 'Paid';

            alert('‚úÖ Payment recorded successfully!');
        }

        function loadPaymentHistory() {
            const tbody = document.getElementById('paymentHistoryTable');
            
            if (!appData.payments || appData.payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6B7280;">No payment records yet</td></tr>';
                return;
            }

            const sorted = [...appData.payments].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sorted.map(p => {
                let statusBadge = '';
                if (p.status === 'Paid') {
                    statusBadge = '<span class="badge badge-green">Paid</span>';
                } else if (p.status === 'Unpaid') {
                    statusBadge = '<span class="badge badge-red">Unpaid</span>';
                } else if (p.status === 'Free Card') {
                    statusBadge = '<span class="badge badge-blue">Free Card</span>';
                }

                return `
                    <tr>
                        <td>${p.date}</td>
                        <td>${p.studentId}</td>
                        <td>${p.studentName}</td>
                        <td>${p.class}</td>
                        <td>${p.month}</td>
                        <td>Rs. ${p.amount.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // REPORTS FUNCTIONS
        // ============================================

        function generateReport() {
            const type = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').value;
            const grade = document.getElementById('reportGrade').value;
            
            if (!month) {
                alert('Select month');
                return;
            }
            
            let html = '';
            if (type === 'attendance') html = generateAttendanceReport(month, grade);
            else html = generatePaymentReport(month, grade);
            
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportPreview').style.display = 'block';
        }

        function generateAttendanceReport(month, grade) {
            const students = grade === 'all' ? appData.students : appData.students.filter(s => s.grade === grade);
            let html = `<h4 style="margin-bottom: 16px;">Attendance Report - ${month}</h4>`;
            html += '<table><thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Present</th><th>Absent</th><th>Rate</th></tr></thead><tbody>';
            
            students.forEach(s => {
                let present = 0, total = 0;
                Object.keys(appData.attendance).forEach(date => {
                    if (date.startsWith(month)) {
                        total++;
                        if (appData.attendance[date][s.id] === 'present') present++;
                    }
                });
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                html += `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>Grade ${s.grade}</td>
                        <td>${present}</td>
                        <td>${total - present}</td>
                        <td><span class="badge ${rate >= 75 ? 'badge-green' : 'badge-red'}">${rate}%</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generatePaymentReport(month, grade) {
            const students = grade === 'all' ? appData.students : appData.students.filter(s => s.grade === grade);
            let html = `<h4 style="margin-bottom: 16px;">Payment Report - ${month}</h4>`;
            html += '<table><thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
            
            let total = 0;
            students.forEach(s => {
                const monthPayments = appData.payments.filter(p => p.studentId === s.id && p.month === month);
                const amount = monthPayments.reduce((sum, p) => sum + p.amount, 0);
                const status = monthPayments.length > 0 ? 'Paid' : 'Unpaid';
                if (amount > 0) total += amount;
                
                html += `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>Grade ${s.grade}</td>
                        <td>Rs. ${amount.toFixed(2)}</td>
                        <td><span class="badge ${status === 'Paid' ? 'badge-green' : 'badge-red'}">${status}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            html += `<div style="margin-top: 20px; padding: 16px; background: #EFF6FF; border-radius: 8px;">
                <strong>Total Collected: Rs. ${total.toFixed(2)}</strong>
            </div>`;
            return html;
        }

        function exportToExcel() {    
            const type = document.getElementById('reportType').value;            
            const month = document.getElementById('reportMonth').value;            
            const grade = document.getElementById('reportGrade').value;
                
            if (!month) {                    
                alert('‚ö†Ô∏è Please select a month first');                    
                return;            
            }
                
            if (type === 'attendance') {                    
                exportAttendanceToExcel(month, grade);            
            } else if (type === 'payment') {                    
                exportPaymentToExcel(month, grade);            
            }    
        }
    
        function exportAttendanceToExcel(month, grade) {            
            const students = grade === 'all' ? appData.students : appData.students.filter(s => s.grade === grade);
                
            const data = [];
            data.push(['Student ID', 'Name', 'Grade', 'Present Days', 'Absent Days', 'Attendance Rate']);
        
            students.forEach(s => {                    
                let presentDays = 0;                    
                let totalDays = 0;
                            
                Object.keys(appData.attendance || {}).forEach(date => {                            
                    if (date.startsWith(month)) {                                    
                        totalDays++;                                    
                        if (appData.attendance[date][s.id] === 'present') {                    
                            presentDays++;                
                        }                            
                    }        
                });
                            
                const rate = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                    
                data.push([                        
                    s.id,                                        
                    s.name,                           
                    'Grade ' + s.grade,                            
                    presentDays,                            
                    totalDays - presentDays,                            
                    rate + '%'                    
                ]);            
            });
                
            const wb = XLSX.utils.book_new();            
            const ws = XLSX.utils.aoa_to_sheet(data);
                
            ws['!cols'] = [
                { wch: 15 },
                { wch: 25 },
                { wch: 10 },
                { wch: 12 },
                { wch: 12 },
                { wch: 15 }
            ];
               
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');
                
            const filename = `Attendance_Report_${month}_${grade === 'all' ? 'All_Grades' : 'Grade_' + grade}.xlsx`;            
            XLSX.writeFile(wb, filename);
                
            alert('‚úÖ Excel file downloaded!\n\nFile: ' + filename);    
        }
    
        function exportPaymentToExcel(month, grade) {            
            const students = grade === 'all' ? appData.students : appData.students.filter(s => s.grade === grade);
                
            const data = [];
            data.push(['Student ID', 'Name', 'Grade', 'Amount Paid', 'Status']);
                
            let totalCollected = 0;
                
            students.forEach(s => {                    
                const monthPayments = (appData.payments || []).filter(p =>                             
                    p.studentId === s.id && p.month === month                
                );
                    
                const amount = monthPayments.reduce((sum, p) => sum + p.amount, 0);            
                const status = monthPayments.length > 0 ? 'Paid' : 'Unpaid';
                    
                if (amount > 0) totalCollected += amount;
                    
                data.push([
                    s.id,                            
                    s.name,                            
                    'Grade ' + s.grade,                           
                    'Rs. ' + amount.toFixed(2),                            
                    status                    
                ]);            
            });    
        
            data.push([]);           
            data.push(['', '', '', 'Total Collected:', 'Rs. ' + totalCollected.toFixed(2)]);
                
            const wb = XLSX.utils.book_new();            
            const ws = XLSX.utils.aoa_to_sheet(data);
                
            ws['!cols'] = [
                { wch: 15 },
                { wch: 25 },
                { wch: 10 },
                { wch: 15 },
                { wch: 10 }
            ];
                
            XLSX.utils.book_append_sheet(wb, ws, 'Payment Report');
                
            const filename = `Payment_Report_${month}_${grade === 'all' ? 'All_Grades' : 'Grade_' + grade}.xlsx`;            
            XLSX.writeFile(wb, filename);
                
            alert('‚úÖ Excel file downloaded!\n\nFile: ' + filename);    
        }

        // ============================================
        // ATTENDANCE MANAGEMENT
        // ============================================

        let currentAttendanceData = {};
        let currentAttendanceStudents = [];

        function loadAttendanceStudents() {
            const gradeSelect = document.getElementById('attendanceClassSelect');
            const dateSelect = document.getElementById('attendanceDateSelect');
    
            if (!gradeSelect || !dateSelect) {
                alert('Error: Controls not found');
                return;    
            }
        
            const grade = gradeSelect.value;    
            const date = dateSelect.value;
        
            console.log('Loading attendance - Grade:', grade, 'Date:', date);
        
            if (!grade) {        
                alert('‚ö†Ô∏è Please select a class first');        
                return;    
            }
    
            if (!date) {        
                alert('‚ö†Ô∏è Please select a date first');        
                return;    
            }
        
            currentAttendanceStudents = appData.students.filter(s => s.grade === grade);        
            console.log('Found students:', currentAttendanceStudents.length);
        
            if (currentAttendanceStudents.length === 0) {        
                alert('‚ùå No students in Grade ' + grade + '\n\nPlease add students first.');        
                document.getElementById('attendanceStudentCard').style.display = 'none';        
                return;  
            }
    
            document.getElementById('attendanceStudentCard').style.display = 'block';    
    
            if (!appData.attendance) {        
                appData.attendance = {};    
            }
        
            if (appData.attendance[date]) {        
                currentAttendanceData = { ...appData.attendance[date] };        
                console.log('Loaded existing attendance:', currentAttendanceData);    
            } else {        
                currentAttendanceData = {};        
                console.log('No existing attendance for this date');    
            }
    
            displayAttendanceStudents();
        }

        function displayAttendanceStudents() {    
            const container = document.getElementById('attendanceStudentsList');    
    
            if (!container) {        
                console.error('Student list container not found');        
                return;    
            }
        
            let html = '';    
    
            currentAttendanceStudents.forEach(s => {        
                const isPresent = currentAttendanceData[s.id] === 'present';        
        
                html += `            
                    <div style="background: ${isPresent ? '#D1FAE5' : '#F3F4F6'}; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid ${isPresent ? '#10B981' : '#D1D5DB'}; transition: all 0.3s;">                
                        <div style="display: flex; justify-content: space-between; align-items: center;">                    
                            <div>                        
                                <div style="font-weight: 700; font-size: 18px; margin-bottom: 5px; color: #1F2937;">${s.name}</div>                        
                                <div style="color: #6B7280; font-size: 14px;">ID: ${s.id} | Grade ${s.grade}</div>
                            </div>
                            <button onclick="toggleAttendance('${s.id}')"                             
                            style="background: ${isPresent ? '#10B981' : '#EF4444'}; color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: 700; min-width: 140px; transition: all 0.3s;">
                            ${isPresent ? '‚úì Present' : '‚úó Absent'}                
                            </button>
                        </div>
                    </div>
                `;
            });
    
            container.innerHTML = html;
            updateAttendanceCounts();
        }
   
        function toggleAttendance(studentId) {            
            console.log('Toggle attendance for:', studentId);
            
            if (currentAttendanceData[studentId] === 'present') {                    
                currentAttendanceData[studentId] = 'absent';           
            } else {                    
                currentAttendanceData[studentId] = 'present';            
            }
                
            console.log('New status:', currentAttendanceData[studentId]);
            displayAttendanceStudents();    
        }
    
        function updateAttendanceCounts() {            
            const total = currentAttendanceStudents.length;            
            const present = currentAttendanceStudents.filter(s => currentAttendanceData[s.id] === 'present').length;            
            const absent = total - present;
                
            const totalEl = document.getElementById('attendanceTotalCount');       
            const presentEl = document.getElementById('attendancePresentCount');            
            const absentEl = document.getElementById('attendanceAbsentCount');
                
            if (totalEl) totalEl.textContent = total;            
            if (presentEl) presentEl.textContent = present;            
            if (absentEl) absentEl.textContent = absent;       
        
            console.log('Counts updated - Total:', total, 'Present:', present, 'Absent:', absent);
        }
    
        function saveAttendanceData() {            
            const dateSelect = document.getElementById('attendanceDateSelect');    
            const gradeSelect = document.getElementById('attendanceClassSelect');
            
            if (!dateSelect || !gradeSelect) {                    
                alert('Error: Controls not found');                    
                return;            
            }
                
            const date = dateSelect.value;            
            const grade = gradeSelect.value;        
        
            if (!date || !grade) {                    
                alert('‚ö†Ô∏è Please select class and date first');                    
                return;            
            }
                
            if (!appData.attendance) {                   
                appData.attendance = {};            
            }
                
            appData.attendance[date] = { ...currentAttendanceData };        
            saveData();        
        
            const present = currentAttendanceStudents.filter(s => currentAttendanceData[s.id] === 'present').length;            
            const absent = currentAttendanceStudents.length - present;     
        
            alert(`‚úÖ Attendance Saved Successfully!\n\nDate: ${date}\nClass: Grade ${grade}\n\nPresent: ${present}\nAbsent: ${absent}`);        
        
            console.log('Attendance saved:', appData.attendance[date]);    
        }

        function processQRForAttendance(studentId) {    
            const student = appData.students.find(s => s.id === studentId.trim());
        
            if (!student) {        
                alert('‚ùå Student not found!\n\nScanned ID: ' + studentId);        
                return;    
            }
        
            const gradeSelect = document.getElementById('attendanceClassSelect');    
            const selectedClass = gradeSelect ? gradeSelect.value : '';
        
            if (!selectedClass) {        
                alert('‚ö†Ô∏è Please select a class first before scanning');        
                return;    
            }
        
            if (student.grade !== selectedClass) {        
                alert(`‚ùå Wrong Class!\n\nStudent: ${student.name}\nStudent's Grade: ${student.grade}\nSelected Grade: ${selectedClass}`);        
                return;    
            }
        
            currentAttendanceData[studentId.trim()] = 'present';
        
            if (currentAttendanceStudents.length === 0) {        
                loadAttendanceStudents();    
            } else {            
                displayAttendanceStudents();    
            }
        
            alert('‚úÖ Success!\n\n' + student.name + '\nMarked as Present');
        }

        // ============================================
        // QR CODE SCANNER (FIXED)
        // ============================================

        let html5QrcodeScanner = null;
        let qrScanMode = null;
        let isScannerRunning = false;
        let currentCameraIndex = 0;
        let availableCameras = [];
        
        function openQRScanner(mode) {        
            qrScanMode = mode;        
            document.getElementById('qrScannerModal').classList.add('active');
   
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
            Html5Qrcode.getCameras().then(cameras => {                
                if (cameras && cameras.length) {                     
                    availableCameras = cameras;
                    let selectedCamera = cameras[0];
                    
                    const backCamera = cameras.find(camera =>               
                        camera.label.toLowerCase().includes('back') ||                
                        camera.label.toLowerCase().includes('rear') ||                
                        camera.label.toLowerCase().includes('environment')
                    );
                       
                    if (backCamera) {                
                        selectedCamera = backCamera;                
                        console.log('Using back camera:', backCamera.label);            
                    } else {                
                        console.log('Back camera not found, using:', selectedCamera.label);            
                    }            
            
                    const cameraId = selectedCamera.id;
                            
                    html5QrcodeScanner.start(                
                        cameraId,                                
                        {                                        
                            fps: 10,                                       
                            qrbox: { width: 250, height: 250 },                    
                            aspectRatio: 1.0,                  
                            facingMode: { ideal: "environment" }                
                        },                                
                        onScanSuccess,                                
                        onScanFailure                        
                    ).then(() => {                                
                        isScannerRunning = true;                                
                        console.log('Scanner started successfully');                        
                    }).catch(err => {                            
                        console.error('Error starting scanner:', err);                                
                        isScannerRunning = false;
                                        
                        if (err.name === 'NotAllowedError') {                                       
                            alert('‚ùå Camera Permission Denied\n\nPlease allow camera access in your browser settings and try again.');                                
                        } else {                                        
                            alert('‚ùå Cannot access camera\n\nError: ' + err.message);                                
                        }                        
                
                        document.getElementById('qrScannerModal').classList.remove('active');                        
                    });                
                } else {                        
                    alert('‚ùå No cameras found on this device');                        
                    document.getElementById('qrScannerModal').classList.remove('active');                
                }        
            }).catch(err => {                
                console.error('Error getting cameras:', err);
               
                if (err.name === 'NotAllowedError') {                        
                    alert('‚ùå Camera Permission Denied\n\nPlease:\n1. Allow camera access when prompted\n2. Check browser settings\n3. Try again');                
                } else {                        
                    alert('‚ùå Error accessing camera\n\n' + err.message);                
                }
                
                document.getElementById('qrScannerModal').classList.remove('active');        
            });
        }
        
        function switchCamera() {
            if (!html5QrcodeScanner || !isScannerRunning) {
                alert('‚ö†Ô∏è Scanner not running');
                return;
            }
            
            if (availableCameras.length <= 1) {
                alert('‚ÑπÔ∏è Only one camera available');
                return;
            }
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.start(
                    availableCameras[currentCameraIndex].id,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        facingMode: { ideal: "environment" }
                    },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    console.log('Switched to camera:', availableCameras[currentCameraIndex].label);
                }).catch(err => {
                    console.error('Error switching camera:', err);
                    alert('‚ùå Error switching camera');
                });
            });
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
        
            document.getElementById('qr-scanned-id').textContent = decodedText;
            document.getElementById('qr-result').style.display = 'block';
        
            if (qrScanMode === 'attendance') {        
                processQRForAttendance(decodedText);    
            } else if (qrScanMode === 'payment') {    
                processQRForPayment(decodedText);    
            }
        
            setTimeout(() => {        
                closeQRScanner();    
            }, 2000);
        }

        function onScanFailure(error) {
            // Normal - scanner is trying to detect QR
        }

        function closeQRScanner() {
            if (html5QrcodeScanner && isScannerRunning) {        
                html5QrcodeScanner.stop().then(() => {        
                    isScannerRunning = false;            
                    html5QrcodeScanner = null;            
                    document.getElementById('qrScannerModal').classList.remove('active');            
                    document.getElementById('qr-result').style.display = 'none';        
                    console.log('Scanner stopped successfully');        
                }).catch(err => {        
                    console.error('Error stopping scanner:', err);        
                    isScannerRunning = false;            
                    html5QrcodeScanner = null;            
                    document.getElementById('qrScannerModal').classList.remove('active');            
                    document.getElementById('qr-result').style.display = 'none';    
                });    
            } else {        
                isScannerRunning = false;        
                html5QrcodeScanner = null;        
                document.getElementById('qrScannerModal').classList.remove('active');        
                document.getElementById('qr-result').style.display = 'none';    
            }
        }

        function processQRForPayment(studentId) {
            const student = appData.students.find(s => s.id === studentId.trim());
        
            if (!student) {        
                alert('‚ùå Student not found!\n\nScanned ID: ' + studentId);        
                return;    
            }
        
            const studentIdInput = document.getElementById('paymentStudentId');    
            const classInput = document.getElementById('paymentClass');
        
            if (studentIdInput) studentIdInput.value = studentId;    
            if (classInput) classInput.value = 'Grade ' + student.grade;
        
            alert('‚úÖ Student Loaded!\n\n' + student.name + '\nGrade ' + student.grade + '\n\nPlease fill in payment details below.');
        }

        function manualQRInput(mode) {    
            const studentId = prompt('Enter Student ID:\n\n(Camera not working? Enter ID manually)');
        
            if (!studentId) return;
        
            if (mode === 'attendance') {        
                processQRForAttendance(studentId);    
            } else if (mode === 'payment') {        
                processQRForPayment(studentId);    
            }
        }

        // ============================================
        // ATTENDANCE MANAGEMENT
        // ============================================

        let currentAttendanceData = {};
        let currentAttendanceStudents = [];

        function loadAttendanceStudents() {
            const gradeSelect = document.getElementById('attendanceClassSelect');
            const dateSelect = document.getElementById('attendanceDateSelect');
    
            if (!gradeSelect || !dateSelect) {
                alert('Error: Controls not found');
                return;    
            }
        
            const grade = gradeSelect.value;    
            const date = dateSelect.value;
        
            console.log('Loading attendance - Grade:', grade, 'Date:', date);
        
            if (!grade) {        
                alert('‚ö†Ô∏è Please select a class first');        
                return;    
            }
    
            if (!date) {        
                alert('‚ö†Ô∏è Please select a date first');        
                return;    
            }
        
            currentAttendanceStudents = appData.students.filter(s => s.grade === grade);        
            console.log('Found students:', currentAttendanceStudents.length);
        
            if (currentAttendanceStudents.length === 0) {        
                alert('‚ùå No students in Grade ' + grade + '\n\nPlease add students first.');        
                document.getElementById('attendanceStudentCard').style.display = 'none';        
                return;  
            }
    
            document.getElementById('attendanceStudentCard').style.display = 'block';    
    
            if (!appData.attendance) {        
                appData.attendance = {};    
            }
        
            if (appData.attendance[date]) {        
                currentAttendanceData = { ...appData.attendance[date] };        
                console.log('Loaded existing attendance:', currentAttendanceData);    
            } else {        
                currentAttendanceData = {};        
                console.log('No existing attendance for this date');    
            }
    
            displayAttendanceStudents();
        }

        function displayAttendanceStudents() {    
            const container = document.getElementById('attendanceStudentsList');    
    
            if (!container) {        
                console.error('Student list container not found');        
                return;    
            }
        
            let html = '';    
    
            currentAttendanceStudents.forEach(s => {        
                const isPresent = currentAttendanceData[s.id] === 'present';        
        
                html += `            
                    <div style="background: ${isPresent ? '#D1FAE5' : '#F3F4F6'}; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid ${isPresent ? '#10B981' : '#D1D5DB'}; transition: all 0.3s;">                
                        <div style="display: flex; justify-content: space-between; align-items: center;">                    
                            <div>                        
                                <div style="font-weight: 700; font-size: 18px; margin-bottom: 5px; color: #1F2937;">${s.name}</div>                        
                                <div style="color: #6B7280; font-size: 14px;">ID: ${s.id} | Grade ${s.grade}</div>
                            </div>
                            <button onclick="toggleAttendance('${s.id}')"                             
                            style="background: ${isPresent ? '#10B981' : '#EF4444'}; color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: 700; min-width: 140px; transition: all 0.3s;">
                            ${isPresent ? '‚úì Present' : '‚úó Absent'}                
                            </button>
                        </div>
                    </div>
                `;
            });
    
            container.innerHTML = html;
            updateAttendanceCounts();
        }
   
        function toggleAttendance(studentId) {            
            console.log('Toggle attendance for:', studentId);
            
            if (currentAttendanceData[studentId] === 'present') {                    
                currentAttendanceData[studentId] = 'absent';           
            } else {                    
                currentAttendanceData[studentId] = 'present';            
            }
                
            console.log('New status:', currentAttendanceData[studentId]);
            displayAttendanceStudents();    
        }
    
        function updateAttendanceCounts() {            
            const total = currentAttendanceStudents.length;            
            const present = currentAttendanceStudents.filter(s => currentAttendanceData[s.id] === 'present').length;            
            const absent = total - present;
                
            const totalEl = document.getElementById('attendanceTotalCount');       
            const presentEl = document.getElementById('attendancePresentCount');            
            const absentEl = document.getElementById('attendanceAbsentCount');
                
            if (totalEl) totalEl.textContent = total;            
            if (presentEl) presentEl.textContent = present;            
            if (absentEl) absentEl.textContent = absent;       
        
            console.log('Counts updated - Total:', total, 'Present:', present, 'Absent:', absent);
        }
    
        function saveAttendanceData() {            
            const dateSelect = document.getElementById('attendanceDateSelect');    
            const gradeSelect = document.getElementById('attendanceClassSelect');
            
            if (!dateSelect || !gradeSelect) {                    
                alert('Error: Controls not found');                    
                return;            
            }
                
            const date = dateSelect.value;            
            const grade = gradeSelect.value;        
        
            if (!date || !grade) {                    
                alert('‚ö†Ô∏è Please select class and date first');                    
                return;            
            }
                
            if (!appData.attendance) {                   
                appData.attendance = {};            
            }
                
            appData.attendance[date] = { ...currentAttendanceData };        
            saveData();        
        
            const present = currentAttendanceStudents.filter(s => currentAttendanceData[s.id] === 'present').length;            
            const absent = currentAttendanceStudents.length - present;     
        
            alert(`‚úÖ Attendance Saved Successfully!\n\nDate: ${date}\nClass: Grade ${grade}\n\nPresent: ${present}\nAbsent: ${absent}`);        
        
            console.log('Attendance saved:', appData.attendance[date]);    
        }

        function processQRForAttendance(studentId) {    
            const student = appData.students.find(s => s.id === studentId.trim());
        
            if (!student) {        
                alert('‚ùå Student not found!\n\nScanned ID: ' + studentId);        
                return;    
            }
        
            const gradeSelect = document.getElementById('attendanceClassSelect');    
            const selectedClass = gradeSelect ? gradeSelect.value : '';
        
            if (!selectedClass) {        
                alert('‚ö†Ô∏è Please select a class first before scanning');        
                return;    
            }
        
            if (student.grade !== selectedClass) {        
                alert(`‚ùå Wrong Class!\n\nStudent: ${student.name}\nStudent's Grade: ${student.grade}\nSelected Grade: ${selectedClass}`);        
                return;    
            }
        
            currentAttendanceData[studentId.trim()] = 'present';
        
            if (currentAttendanceStudents.length === 0) {        
                loadAttendanceStudents();    
            } else {            
                displayAttendanceStudents();    
            }
        
            alert('‚úÖ Success!\n\n' + student.name + '\nMarked as Present');
        }

        // ============================================
        // QR CODE SCANNER (FIXED)
        // ============================================

        let html5QrcodeScanner = null;
        let qrScanMode = null;
        let isScannerRunning = false;
        let currentCameraIndex = 0;
        let availableCameras = [];
        
        function openQRScanner(mode) {        
            qrScanMode = mode;        
            document.getElementById('qrScannerModal').classList.add('active');
   
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
            Html5Qrcode.getCameras().then(cameras => {                
                if (cameras && cameras.length) {                     
                    availableCameras = cameras;
                    let selectedCamera = cameras[0];
                    
                    const backCamera = cameras.find(camera =>               
                        camera.label.toLowerCase().includes('back') ||                
                        camera.label.toLowerCase().includes('rear') ||                
                        camera.label.toLowerCase().includes('environment')
                    );
                       
                    if (backCamera) {                
                        selectedCamera = backCamera;                
                        console.log('Using back camera:', backCamera.label);            
                    } else {                
                        console.log('Back camera not found, using:', selectedCamera.label);            
                    }            
            
                    const cameraId = selectedCamera.id;
                            
                    html5QrcodeScanner.start(                
                        cameraId,                                
                        {                                        
                            fps: 10,                                       
                            qrbox: { width: 250, height: 250 },                    
                            aspectRatio: 1.0,                  
                            facingMode: { ideal: "environment" }                
                        },                                
                        onScanSuccess,                                
                        onScanFailure                        
                    ).then(() => {                                
                        isScannerRunning = true;                                
                        console.log('Scanner started successfully');                        
                    }).catch(err => {                            
                        console.error('Error starting scanner:', err);                                
                        isScannerRunning = false;
                                        
                        if (err.name === 'NotAllowedError') {                                       
                            alert('‚ùå Camera Permission Denied\n\nPlease allow camera access in your browser settings and try again.');                                
                        } else {                                        
                            alert('‚ùå Cannot access camera\n\nError: ' + err.message);                                
                        }                        
                
                        document.getElementById('qrScannerModal').classList.remove('active');                        
                    });                
                } else {                        
                    alert('‚ùå No cameras found on this device');                        
                    document.getElementById('qrScannerModal').classList.remove('active');                
                }        
            }).catch(err => {                
                console.error('Error getting cameras:', err);
               
                if (err.name === 'NotAllowedError') {                        
                    alert('‚ùå Camera Permission Denied\n\nPlease:\n1. Allow camera access when prompted\n2. Check browser settings\n3. Try again');                
                } else {                        
                    alert('‚ùå Error accessing camera\n\n' + err.message);                
                }
                
                document.getElementById('qrScannerModal').classList.remove('active');        
            });
        }
        
        function switchCamera() {
            if (!html5QrcodeScanner || !isScannerRunning) {
                alert('‚ö†Ô∏è Scanner not running');
                return;
            }
            
            if (availableCameras.length <= 1) {
                alert('‚ÑπÔ∏è Only one camera available');
                return;
            }
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.start(
                    availableCameras[currentCameraIndex].id,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        facingMode: { ideal: "environment" }
                    },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    console.log('Switched to camera:', availableCameras[currentCameraIndex].label);
                }).catch(err => {
                    console.error('Error switching camera:', err);
                    alert('‚ùå Error switching camera');
                });
            });
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
        
            document.getElementById('qr-scanned-id').textContent = decodedText;
            document.getElementById('qr-result').style.display = 'block';
        
            if (qrScanMode === 'attendance') {        
                processQRForAttendance(decodedText);    
            } else if (qrScanMode === 'payment') {    
                processQRForPayment(decodedText);    
            }
        
            setTimeout(() => {        
                closeQRScanner();    
            }, 2000);
        }

        function onScanFailure(error) {
            // Normal - scanner is trying to detect QR
        }

        function closeQRScanner() {
            if (html5QrcodeScanner && isScannerRunning) {        
                html5QrcodeScanner.stop().then(() => {        
                    isScannerRunning = false;            
                    html5QrcodeScanner = null;            
                    document.getElementById('qrScannerModal').classList.remove('active');            
                    document.getElementById('qr-result').style.display = 'none';        
                    console.log('Scanner stopped successfully');        
                }).catch(err => {        
                    console.error('Error stopping scanner:', err);        
                    isScannerRunning = false;            
                    html5QrcodeScanner = null;            
                    document.getElementById('qrScannerModal').classList.remove('active');            
                    document.getElementById('qr-result').style.display = 'none';    
                });    
            } else {        
                isScannerRunning = false;        
                html5QrcodeScanner = null;        
                document.getElementById('qrScannerModal').classList.remove('active');        
                document.getElementById('qr-result').style.display = 'none';    
            }
        }

        function processQRForPayment(studentId) {
            const student = appData.students.find(s => s.id === studentId.trim());
        
            if (!student) {        
                alert('‚ùå Student not found!\n\nScanned ID: ' + studentId);        
                return;    
            }
        
            const studentIdInput = document.getElementById('paymentStudentId');    
            const classInput = document.getElementById('paymentClass');
        
            if (studentIdInput) studentIdInput.value = studentId;    
            if (classInput) classInput.value = 'Grade ' + student.grade;
        
            alert('‚úÖ Student Loaded!\n\n' + student.name + '\nGrade ' + student.grade + '\n\nPlease fill in payment details below.');
        }

        function manualQRInput(mode) {    
            const studentId = prompt('Enter Student ID:\n\n(Camera not working? Enter ID manually)');
        
            if (!studentId) return;
        
            if (mode === 'attendance') {        
                processQRForAttendance(studentId);    
            } else if (mode === 'payment') {        
                processQRForPayment(studentId);    
            }
        }

        // ============================================
        // QR CODE GENERATION & DISPLAY
        // ============================================

        let currentQRStudent = null;

        function showQRCode(student) {    
            currentQRStudent = student;
        
            document.getElementById('qrStudentName').textContent = student.name;    
            document.getElementById('qrStudentDetails').textContent = `Grade ${student.grade} - Class ${student.class || 'N/A'}`;    
            document.getElementById('qrStudentId').textContent = `ID: ${student.id}`;
        
            const container = document.getElementById('qrcode-container');    
            container.innerHTML = '';
        
            new QRCode(container, {        
                text: student.id,        
                width: 200,        
                height: 200,        
                colorDark: "#000000",        
                colorLight: "#ffffff",        
                correctLevel: QRCode.CorrectLevel.H    
            });
        
            document.getElementById('qrCodeDisplayModal').classList.add('active');
        }

        function closeQRCodeDisplay() {    
            document.getElementById('qrCodeDisplayModal').classList.remove('active');    
            currentQRStudent = null;
        }

        function downloadQRCode() {    
            if (!currentQRStudent) return;
        
            const canvas = document.querySelector('#qrcode-container canvas');
        
            if (!canvas) {        
                alert('QR Code not found');        
                return;    
            }
        
            const link = document.createElement('a');    
            link.download = `QR_${currentQRStudent.id}_${currentQRStudent.name}.png`;    
            link.href = canvas.toDataURL();    
            link.click();
        
            alert(`‚úÖ QR Code downloaded!\n\nFile: QR_${currentQRStudent.id}_${currentQRStudent.name}.png`);
        }

        function downloadStudentCard() {    
            if (!currentQRStudent) return;    
    
            const student = currentQRStudent;
    
            const canvas = document.createElement('canvas');   
            canvas.width = 800;    
            canvas.height = 500;    
            const ctx = canvas.getContext('2d');
        
            const gradient = ctx.createLinearGradient(0, 0, 800, 500);    
            gradient.addColorStop(0, '#2563EB');    
            gradient.addColorStop(1, '#1E40AF');    
            ctx.fillStyle = gradient;    
            ctx.fillRect(0, 0, 800, 500);
        
            ctx.fillStyle = '#FFFFFF';    
            ctx.roundRect(20, 60, 760, 380, 15);    
            ctx.fill();
    
            ctx.fillStyle = '#2563EB';    
            ctx.roundRect(20, 60, 760, 70, [15, 15, 0, 0]);    
            ctx.fill();
    
            ctx.fillStyle = '#FFFFFF';    
            ctx.font = 'bold 36px Arial';    
            ctx.textAlign = 'center';    
            ctx.fillText('STUDENT ID CARD', 400, 110);
    
            ctx.fillStyle = '#E5E7EB';    
            ctx.roundRect(50, 160, 180, 220, 10);    
            ctx.fill();
       
            ctx.fillStyle = '#9CA3AF';    
            ctx.font = 'bold 20px Arial';    
            ctx.textAlign = 'center';    
            ctx.fillText('PHOTO', 140, 275);
        
            ctx.fillStyle = '#1F2937';    
            ctx.font = 'bold 32px Arial';    
            ctx.textAlign = 'left';    
            ctx.fillText(student.name, 260, 195);
        
            ctx.fillStyle = '#4B5563';    
            ctx.font = '22px Arial';
    
            const details = [        
                `ID: ${student.id}`,                   
                `Grade: ${student.grade}`,                    
                `Class: ${student.class || 'N/A'}`,                    
                student.studentPhone ? `Phone: ${student.studentPhone}` : null            
            ].filter(Boolean);
                
            details.forEach((detail, index) => {
                ctx.fillText(detail, 260, 240 + (index * 35));            
            });
            
            const qrCanvas = document.querySelector('#qrcode-container canvas');
            
            if (qrCanvas) {                    
                ctx.fillStyle = '#F9FAFB';                    
                ctx.roundRect(580, 160, 180, 180, 10);                   
                ctx.fill();
                            
                ctx.drawImage(qrCanvas, 595, 175, 150, 150);
                            
                ctx.fillStyle = '#6B7280';        
                ctx.font = '14px Arial';        
                ctx.textAlign = 'center';        
                ctx.fillText('Scan to verify', 670, 355);    
            }
        
            ctx.fillStyle = '#9CA3AF';    
            ctx.font = 'italic 16px Arial';    
            ctx.textAlign = 'center';    
            ctx.fillText('Keep this card safe and bring it to class', 400, 420);
    
            ctx.strokeStyle = '#2563EB';    
            ctx.lineWidth = 3;    
            ctx.roundRect(20, 60, 760, 380, 15);   
            ctx.stroke();
    
            const link = document.createElement('a');    
            link.download = `Student_ID_${student.id}_${student.name.replace(/\s+/g, '_')}.png`;    
            link.href = canvas.toDataURL('image/png');    
            link.click();
        
            alert(`‚úÖ ID Card Downloaded!\n\n${student.name}\nID: ${student.id}`);
        }

        CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {    
            if (typeof radius === 'number') {        
                radius = [radius, radius, radius, radius];    
            }
    
            this.beginPath();    
            this.moveTo(x + radius[0], y);    
            this.lineTo(x + width - radius[1], y);    
            this.quadraticCurveTo(x + width, y, x + width, y + radius[1]);    
            this.lineTo(x + width, y + height - radius[2]);    
            this.quadraticCurveTo(x + width, y + height, x + width - radius[2], y + height);    
            this.lineTo(x + radius[3], y + height);    
            this.quadraticCurveTo(x, y + height, x, y + height - radius[3]);    
            this.lineTo(x, y + radius[0]);    
            this.quadraticCurveTo(x, y, x + radius[0], y);    
            this.closePath();    
            return this;
        };

        // ============================================
        // SUBSCRIPTION SYSTEM
        // ============================================

        function initializeSubscription() {    
            if (!appData.subscription) {        
                appData.subscription = {           
                    plan: 'free_trial',            
                    status: 'active',            
                    startDate: new Date().toISOString(),            
                    endDate: null,            
                    maxStudents: 10,            
                    features: {                
                        students: true,                
                        attendance: true,                
                        payments: true,               
                        reports: true,                
                        backup: true            
                    }        
                };        
                saveData();
            }    
    
            checkSubscriptionStatus();
        }

        function checkSubscriptionStatus() {    
            const sub = appData.subscription;
        
            if (sub.endDate) {        
                const endDate = new Date(sub.endDate);        
                const now = new Date();
                
                if (now > endDate) {            
                    sub.status = 'expired';            
                    sub.plan = 'free_trial';            
                    sub.maxStudents = 10;            
                    saveData();        
                }    
            }
        
            if (sub.plan === 'free_trial' && appData.students.length >= sub.maxStudents) {        
                return false;    
            }    
    
            return sub.status === 'active';
        }

        function updateSubscriptionDisplay() {    
            const sub = appData.subscription;
        
            const planNames = {        
                'free_trial': 'Free Trial',        
                'monthly': 'Monthly Plan',        
                'annual': 'Annual Plan'    
            };
        
            const currentPlanEl = document.getElementById('currentPlanName');    
            if (currentPlanEl) {        
                currentPlanEl.textContent = planNames[sub.plan] || 'Free Trial';    
            }
        
            const statusEl = document.getElementById('subscriptionStatus');    
            if (statusEl) {        
                statusEl.textContent = sub.status.charAt(0).toUpperCase() + sub.status.slice(1);        
                statusEl.style.color = sub.status === 'active' ? '#D1FAE5' : '#FEE2E2';    
            }
        
            const currentStudentsEl = document.getElementById('currentStudents');    
            const maxStudentsEl = document.getElementById('maxStudents');    
            if (currentStudentsEl) currentStudentsEl.textContent = appData.students.length;    
            if (maxStudentsEl) {        
                maxStudentsEl.textContent = sub.plan === 'free_trial' ? sub.maxStudents : '‚àû';    
            }
        
            const endDateEl = document.getElementById('subscriptionEndDate');    
            if (endDateEl) {        
                if (sub.endDate) {            
                    const date = new Date(sub.endDate);           
                    endDateEl.textContent = date.toLocaleDateString();        
                } else {            
                    endDateEl.textContent = sub.plan === 'free_trial' ? 'No expiry' : '-';        
                }    
            }
        
            const warningEl = document.getElementById('subscriptionWarning');    
            const warningMsgEl = document.getElementById('warningMessage');    
    
            if (sub.plan === 'free_trial' && appData.students.length >= sub.maxStudents - 2) {        
                warningEl.style.display = 'block';        
                warningMsgEl.textContent = `You're using ${appData.students.length} of ${sub.maxStudents} free students. Upgrade to add unlimited students!`;    
            } else if (sub.status === 'expired') {        
                warningEl.style.display = 'block';       
                warningMsgEl.textContent = 'Your subscription has expired. Please renew to continue using premium features.';    
            } else {        
                warningEl.style.display = 'none';   
            }
        
            updateSubscriptionButtons();
        }

        function updateSubscriptionButtons() {    
            const sub = appData.subscription;
        
            const btnFreeTrial = document.getElementById('btnFreeTrial');    
            const btnMonthly = document.getElementById('btnMonthly');    
            const btnAnnual = document.getElementById('btnAnnual');
        
            if (btnFreeTrial) {        
                btnFreeTrial.className = 'btn btn-secondary';        
                btnFreeTrial.textContent = 'Select Plan';    
            }    
            if (btnMonthly) {        
                btnMonthly.className = 'btn btn-success';        
                btnMonthly.textContent = 'Subscribe Monthly';   
            }    
            if (btnAnnual) {        
                btnAnnual.className = 'btn btn-primary';        
                btnAnnual.textContent = 'Subscribe Annual';    
            }
        
            if (sub.plan === 'free_trial' && btnFreeTrial) {        
                btnFreeTrial.className = 'btn btn-secondary';        
                btnFreeTrial.textContent = 'Current Plan';        
                btnFreeTrial.disabled = true;        
                btnFreeTrial.style.opacity = '0.6';
    
            } else if (sub.plan === 'monthly' && btnMonthly) {        
                btnMonthly.className = 'btn btn-success';        
                btnMonthly.textContent = 'Current Plan';        
                btnMonthly.disabled = true;        
                btnMonthly.style.opacity = '0.6';
    
            } else if (sub.plan === 'annual' && btnAnnual) {        
                btnAnnual.className = 'btn btn-primary';        
                btnAnnual.textContent = 'Current Plan';        
                btnAnnual.disabled = true;        
                btnAnnual.style.opacity = '0.6';                
            }
            
            displayPaymentHistory();
        }

        function selectPlan(plan) {    
            const sub = appData.subscription;
       
            if (plan === sub.plan) {        
                alert('‚ÑπÔ∏è You are already on this plan.');        
                return;    
            }
        
            if (plan === 'free_trial') {        
                if (!confirm('‚¨áÔ∏è Downgrade to Free Trial?\n\n‚ö†Ô∏è You will be limited to 10 students\n‚ö†Ô∏è Some premium features will be disabled')) {            
                    return;        
                }
              
                appData.subscription.plan = 'free_trial';        
                appData.subscription.status = 'active';        
                appData.subscription.maxStudents = 10;        
                appData.subscription.endDate = null;
             
                saveData();        
                updateSubscriptionDisplay();
               
                alert('‚úÖ Downgraded to Free Trial\n\nYou can now add up to 10 students.');    
            } else {        
                initiatePayment(plan);    
            }
        }

        function canAddStudent() {    
            const sub = appData.subscription;
        
            if (sub.plan === 'free_trial' && appData.students.length >= sub.maxStudents) {        
                if (confirm(`‚ö†Ô∏è Student Limit Reached!\n\nYou've reached the limit of ${sub.maxStudents} students on the Free Trial.\n\nWould you like to upgrade to add unlimited students?`)) {            
                    navigateTo('subscription');        
                }        
                return false;   
            }    
    
            return true;
        }

        function displayPaymentHistory() {    
            const tbody = document.getElementById('paymentHistoryTableBody');
        
            if (!tbody) return;    
    
            const history = appData.paymentHistory || [];
       
            if (history.length === 0) {        
                tbody.innerHTML = `           
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                            No payment history yet
                        </td>
                    </tr>
                `;       
                return;  
            }
       
            tbody.innerHTML = history.reverse().map(p => {        
                const date = new Date(p.date).toLocaleDateString();        
                const planName = p.plan === 'monthly' ? 'Monthly' : 'Annual';        
                const statusBadge = p.status === 'completed'             
                    ? '<span class="badge badge-green">Completed</span>'            
                    : '<span class="badge badge-amber">Pending</span>';
               
                return `           
                    <tr>
                        <td>${date}</td>
                        <td style="font-family: monospace; font-size: 12px;">${p.orderId}</td>
                        <td>${planName}</td>
                        <td>Rs. ${p.amount.toLocaleString('en-LK', { minimumFractionDigits: 2 })}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;   
            }).join('');
        }

        // ============================================
        // PAYHERE PAYMENT INTEGRATION
        // ============================================

        function initiatePayment(plan) {    
            const sub = appData.subscription;
        
            if (sub.plan === plan && sub.status === 'active') {       
                alert('‚ÑπÔ∏è You are already on this plan.');       
                return;    
            }
        
            const planDetails = SUBSCRIPTION_PRICES[plan];
        
            if (!planDetails) {        
                alert('‚ùå Invalid plan selected');        
                return;    
            }
       
            const confirmMsg = `üí≥ Proceed to Payment?\n\nPlan: ${plan === 'monthly' ? 'Monthly' : 'Annual'}\nAmount: Rs. ${planDetails.amount.toLocaleString()}\n\n‚úì Unlimited students\n‚úì All premium features\n‚úì Priority support`;
       
            if (!confirm(confirmMsg)) {        
                return;    
            }
        
            const orderId = generateOrderId(plan);
        
            const payment = {       
                sandbox: PAYHERE_CONFIG.sandbox,        
                merchant_id: PAYHERE_CONFIG.merchantId,        
                return_url: PAYHERE_CONFIG.returnUrl,        
                cancel_url: PAYHERE_CONFIG.cancelUrl,        
                notify_url: PAYHERE_CONFIG.notifyUrl,        
                order_id: orderId,        
                items: planDetails.description,        
                amount: planDetails.amount.toFixed(2),       
                currency: planDetails.currency,
        
                first_name: getUserName(),        
                last_name: '',        
                email: getUserEmail(),       
                phone: getUserPhone(),        
                address: '',        
                city: 'Colombo',      
                country: 'Sri Lanka',

                custom_1: plan,
                custom_2: new Date().toISOString()
            };
        
            storePendingPayment(orderId, plan, planDetails.amount);
            payhere.startPayment(payment);
        }

        function generateOrderId(plan) {    
            const timestamp = Date.now();    
            const random = Math.floor(Math.random() * 1000);    
            return `CM_${plan.toUpperCase()}_${timestamp}_${random}`;
        }

        function getUserName() {    
            let userName = localStorage.getItem('userName');    
            if (!userName) {        
                userName = prompt('Enter your name:', 'Teacher') || 'Teacher';        
                localStorage.setItem('userName', userName);    
            }    
            return userName;
        }

        function getUserEmail() {    
            let userEmail = localStorage.getItem('userEmail');    
            if (!userEmail) {        
                userEmail = prompt('Enter your email:', 'teacher@school.com') || 'teacher@school.com';        
                localStorage.setItem('userEmail', userEmail);    
            }                
            return userEmail;
        }

        function getUserPhone() {    
            let userPhone = localStorage.getItem('userPhone');    
            if (!userPhone) {        
                userPhone = prompt('Enter your phone number:', '0771234567') || '0771234567';        
                localStorage.setItem('userPhone', userPhone);    
            }    
            return userPhone;
        }

        function storePendingPayment(orderId, plan, amount) {    
            const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
       
            pendingPayments.push({        
                orderId: orderId,        
                plan: plan,        
                amount: amount,        
                timestamp: new Date().toISOString(),       
                status: 'pending'   
            });
       
            localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
        }

        payhere.onCompleted = function onCompleted(orderId) {    
            console.log('Payment completed. OrderID:', orderId);
        
            const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');    
            const payment = pendingPayments.find(p => p.orderId === orderId);
        
            if (payment) {       
                activateSubscription(payment.plan, orderId);
                
                payment.status = 'completed';       
                payment.completedDate = new Date().toISOString();        
                localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
                
                alert(`‚úÖ Payment Successful!\n\nOrder ID: ${orderId}\nPlan: ${payment.plan === 'monthly' ? 'Monthly' : 'Annual'}\n\nYour subscription is now active!`);
                
                updateSubscriptionDisplay();
                storePaymentRecord(payment);    
            } else {        
                alert('‚úÖ Payment Successful!\n\nYour subscription is now active!');    
            }
        };

        payhere.onDismissed = function onDismissed() {    
            console.log('Payment dismissed');    
            alert('‚ùå Payment Cancelled\n\nYou cancelled the payment process.');
        };

        payhere.onError = function onError(error) {    
            console.log('Payment error:', error);    
            alert(`‚ùå Payment Failed\n\nError: ${error}\n\nPlease try again or contact support.`);
        };

        function activateSubscription(plan, orderId) {    
            appData.subscription.plan = plan;    
            appData.subscription.status = 'active';    
            appData.subscription.startDate = new Date().toISOString();    
            appData.subscription.orderId = orderId;    
            appData.subscription.maxStudents = Infinity;
       
            const endDate = new Date();   
            if (plan === 'monthly') {        
                endDate.setMonth(endDate.getMonth() + 1);    
            } else if (plan === 'annual') {        
                endDate.setFullYear(endDate.getFullYear() + 1);   
            }    
            appData.subscription.endDate = endDate.toISOString();    
    
            appData.subscription.features = {       
                students: true,       
                attendance: true,        
                payments: true,        
                reports: true,        
                backup: true,        
                export: true,        
                priority_support: true    
            };   
    
            saveData();
        }

        function storePaymentRecord(payment) {    
            if (!appData.paymentHistory) {        
                appData.paymentHistory = [];   
            }
        
            appData.paymentHistory.push({        
                orderId: payment.orderId,        
                plan: payment.plan,       
                amount: payment.amount,        
                date: payment.completedDate || new Date().toISOString(),        
                status: 'completed'    
            });
        
            saveData();
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        function loadSettings() {    
            document.getElementById('subjectNameInput').value = appData.subjectName;   
            document.getElementById('subjectDisplay').textContent = 'Subject: ' + appData.subjectName;
        
            const list = document.getElementById('gradesList');    
            list.innerHTML = appData.grades.map(g => `        
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 8px;">            
                    <span style="font-weight: 600; color: #fff;">Grade ${g}</span>
                    <button class="icon-btn icon-btn-red" onclick="deleteGrade('${g}')">üóëÔ∏è Remove</button>
                </div>
            `).join('');
        
            updateLastSavedTime();
        
            const lastBackup = localStorage.getItem('lastBackupTime');    
            const backupTimeEl = document.getElementById('lastBackupTime');    
            if (backupTimeEl) {        
                backupTimeEl.textContent = lastBackup || 'Never';    
            }
        
            updateDataStatistics();
            displayTeacherId();
        }

        function addGrade() {
            const newGrade = document.getElementById('newGrade').value.trim();
            
            if (!newGrade) {
                alert('Enter grade number');
                return;
            }
            
            if (appData.grades.includes(newGrade)) {
                alert('Grade already exists');
                return;
            }
            
            appData.grades.push(newGrade);
            appData.grades.sort();
            saveData();
            populateGradeDropdowns();
            loadSettings();
            document.getElementById('newGrade').value = '';
            alert('Grade added!');
        }

        function deleteGrade(grade) {
            const hasStudents = appData.students.some(s => s.grade === grade);
            
            if (hasStudents) {
                alert('Cannot delete grade with students');
                return;
            }
            
            if (!confirm(`Delete Grade ${grade}?`)) return;
            
            appData.grades = appData.grades.filter(g => g !== grade);
            saveData();
            populateGradeDropdowns();
            loadSettings();
            alert('Grade deleted!');
        }

        function saveSubject() {
            const subject = document.getElementById('subjectNameInput').value.trim();
            
            if (!subject) {
                alert('Enter subject name');
                return;
            }
            
            appData.subjectName = subject;
            saveData();
            document.getElementById('subjectDisplay').textContent = 'Subject: ' + subject;
            alert('Subject saved!');
        }

        function updateDataStatistics() {    
            const statsStudents = document.getElementById('statsStudents');    
            const statsPayments = document.getElementById('statsPayments');    
            const statsTimetable = document.getElementById('statsTimetable');    
            const statsAttendance = document.getElementById('statsAttendance');
        
            if (statsStudents) statsStudents.textContent = appData.students.length;    
            if (statsPayments) statsPayments.textContent = (appData.payments || []).length;   
            if (statsTimetable) statsTimetable.textContent = appData.timetable.length;    
            if (statsAttendance) statsAttendance.textContent = Object.keys(appData.attendance || {}).length;
        }

        // ============================================
        // BACKUP AND DATA MANAGEMENT
        // ============================================

        function downloadBackup() {    
            try {    
                const dataToBackup = {            
                    ...appData,            
                    backupDate: new Date().toISOString(),
                    appVersion: '1.0'        
                };                
                const dataStr = JSON.stringify(dataToBackup, null, 2);        
                const dataBlob = new Blob([dataStr], { type: 'application/json' });        
                const url = URL.createObjectURL(dataBlob);        
                const link = document.createElement('a');        
                const fileName = `ClassManager_Backup_${new Date().toISOString().split('T')[0]}.json`;
                
                link.href = url;
                link.download = fileName;        
                link.click();        
        
                const now = new Date().toLocaleString();        
                localStorage.setItem('lastBackupTime', now);        
                const backupTimeEl = document.getElementById('lastBackupTime');        
                if (backupTimeEl) backupTimeEl.textContent = now;
                
                alert('‚úÖ Backup downloaded successfully!\n\nFile: ' + fileName);    
            } catch (error) {        
                console.error('‚ùå Backup error:', error);        
                alert('‚ö†Ô∏è Error creating backup file.');    
            }
        }

        function uploadBackup() {                
            const input = document.createElement('input');    
            input.type = 'file';    
            input.accept = '.json';    
    
            input.onchange = (e) => {      
                const file = e.target.files[0];        
                if (!file) return;        
        
                const reader = new FileReader();
                
                reader.onload = (event) => {            
                    try {                
                        const restored = JSON.parse(event.target.result);
                                
                        if (!restored.students || !Array.isArray(restored.students)) {                    
                            throw new Error('Invalid backup file format');                
                        }
                                
                        if (!confirm('‚ö†Ô∏è Restore data from backup?\n\nThis will replace all current data!\n\nStudents: ' + (restored.students?.length || 0) + '\nPayments: ' + (restored.payments?.length || 0))) {                    
                            return;                
                        }
                                
                        appData = {                    
                            students: restored.students || [],                    
                            grades: restored.grades || ['06', '07', '08', '09', '10', '11', '12'],                    
                            timetable: restored.timetable || [],                    
                            attendance: restored.attendance || {},                    
                            payments: restored.payments || [],                    
                            subjectName: restored.subjectName || 'Mathematics',                    
                            selectedStudent: null,                    
                            editingTimetable: null,                    
                            selectedPaymentStudent: null,
                            subscription: restored.subscription || appData.subscription               
                        };
                                
                        saveData();                
                        populateGradeDropdowns();                
                        updateDashboard();
                               
                        const activeScreen = document.querySelector('.screen.active');               
                        if (activeScreen) {                    
                            const screenId = activeScreen.id;                    
                            if (screenId === 'students') loadStudentsScreen();                    
                            if (screenId === 'timetable') loadTimetable();                    
                            if (screenId === 'payments') loadPaymentHistory();                   
                            if (screenId === 'settings') loadSettings();                
                        }
                                
                        alert('‚úÖ Data restored successfully!\n\nStudents: ' + appData.students.length + '\nPayments: ' + appData.payments.length);                              
                    } catch (err) {                
                        console.error('‚ùå Restore error:', err);                
                        alert('‚ö†Ô∏è Invalid backup file!\n\nPlease select a valid Class Manager backup file.');           
                    }        
                };
                
                reader.onerror = () => {            
                    alert('‚ö†Ô∏è Error reading backup file.');        
                };
                
                reader.readAsText(file);    
            };
        
            input.click();
        }

        function clearAllData() {    
            if (!confirm('‚ö†Ô∏è DELETE ALL DATA?\n\nThis will permanently delete:\n- All students\n- All payments\n- All attendance records\n- All timetable entries\n\nThis CANNOT be undone!')) {        
                return;    
            }
        
            if (!confirm('‚ö†Ô∏è Are you ABSOLUTELY SURE?\n\nThis is your last chance to cancel!')) {        
                return;    
            }
        
            // Clear Firebase
            if (currentUserId) {
                database.ref('users/' + currentUserId).remove()
                    .then(() => {
                        console.log('‚úÖ Firebase data cleared');
                    })
                    .catch((error) => {
                        console.error('‚ùå Error clearing Firebase:', error);
                    });
            }

            // Clear localStorage
            localStorage.clear();
        
            alert('‚úÖ All data cleared!\n\nThe app will now reload.');
        
            location.reload();
        }
    </script>
</body>
</html>

























