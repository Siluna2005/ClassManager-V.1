<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563EB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https: wss: data: blob:;">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <title>Class Manager</title>
    <link rel="stylesheet" href="appStyle.css">
</head>
<body>

    <div id="app" class="container">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <img src="assets/favicon.ico" alt="Logo" class="nav-logo">
                    <span class="navbar-title">Class Manager</span>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">        
                    <div id="syncStatus" style="font-size: 12px; color: rgba(255,255,255,0.8);">            
                        <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">Synced</span>        
                    </div>       
                    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                </div>
            </div>
        </nav>

        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Teacher Portal</h3>
                <p>Welcome back!</p>
            </div>
            <div class="sidebar-menu">
                <!-- Admin Panel (Only visible to admins) -->
                <div class="menu-item" data-screen="admin-panel" onclick="navigateTo('admin-panel')" id="adminMenuItem" style="display: none;">    
                    <span>üëë</span><span>Admin Panel</span>
                </div>
                <div class="menu-item active" data-screen="dashboard" onclick="navigateTo('dashboard')">
                    <span>üìä</span><span>Dashboard</span>
                </div>
                <div class="menu-item" data-screen="students" onclick="navigateTo('students')">
                    <span>üë•</span><span>Students</span>
                </div>
                <div class="menu-item" data-screen="timetable" onclick="navigateTo('timetable')">
                    <span>üìÖ</span><span>Timetable</span>
                </div>
                <div class="menu-item" data-screen="attendance" onclick="navigateTo('attendance')">
                    <span>‚úÖ</span><span>Attendance</span>
                </div>
                <div class="menu-item" data-screen="payments" onclick="navigateTo('payments')">
                    <span>üí∞</span><span>Payments</span>
                </div>
                <div class="menu-item" data-screen="reports" onclick="navigateTo('reports')">
                    <span>üìÑ</span><span>Reports</span>
                </div>
                <div class="menu-item" data-screen="subscription" onclick="navigateTo('subscription')">        
                    <span>‚≠ê</span><span>Subscription</span>    
                </div>
                <div class="menu-item" data-screen="settings" onclick="navigateTo('settings')">
                    <span>‚öôÔ∏è</span><span>Settings</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <span>üö™</span><span>Logout</span>
                </div>
            </div>
        </div>

        <div class="content">
          
            <!-- Admin Panel Screen -->
            <div id="admin-panel" class="screen">    
                <div class="screen-header">       
                    <h1 class="screen-title">üëë Admin Control Panel</h1>      
                    <p class="screen-subtitle">System administration and user management</p>   
                </div>
   
                <!-- Admin Stats Dashboard -->    
                <div class="stats-grid">     
                    <div class="stat-card">      
                        <div class="stat-header">        
                            <div class="stat-info">        
                                <p>Total Users</p>           
                                <h3 id="adminTotalUsers">0</h3>          
                            </div>           
                            <div class="stat-icon blue">üë•</div>          
                        </div>       
                    </div>
         
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Active Subscriptions</p>
                                <h3 id="adminActiveSubscriptions">0</h3> 
                            </div>  
                            <div class="stat-icon green">üí≥</div> 
                        </div> 
                    </div>
         
                    <div class="stat-card">        
                        <div class="stat-header">       
                            <div class="stat-info">         
                                <p>Total Students</p>          
                                <h3 id="adminTotalStudents">0</h3>         
                            </div>         
                            <div class="stat-icon purple">üéì</div>         
                        </div>       
                    </div>
                
                    <div class="stat-card">      
                        <div class="stat-header">
                                  <div class="stat-info">        
                                <p>Total Revenue</p>        
                                <h3 id="adminTotalRevenue">LKR 0</h3>                
                            </div>             
                            <div class="stat-icon amber">üí∞</div>         
                        </div>       
                    </div>    
                </div>
   
                <!-- Admin Tabs --> 
                <div class="card" style="margin-top: 20px;">      
                    <div class="admin-tabs" style="display: flex; gap: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 20px;">          
                        <button class="admin-tab active" onclick="showAdminTab('users')" style="padding: 10px 20px; border: none; background: #2563EB; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">All Users</button>           
                        <button class="admin-tab" onclick="showAdminTab('subscriptions')" style="padding: 10px 20px; border: none; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">Subscriptions</button>           
                        <button class="admin-tab" onclick="showAdminTab('analytics')" style="padding: 10px 20px; border: none; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">Analytics</button>           
                        <button class="admin-tab" onclick="showAdminTab('settings')" style="padding: 10px 20px; border: none; background: #f3f4f6; color: #374151; border-radius: 8px; cursor: pointer; font-weight: 600;">Admin Settings</button>    
                    </div>
        
                    <!-- Users Tab -->      
                    <div id="admin-users-tab" class="admin-tab-content active">         
                        <h3 class="card-title">All Registered Users</h3>
                     
                        <div class="form-group" style="max-width: 400px;">            
                            <input type="text" id="adminUserSearch" placeholder="üîç Search users by email or ID..." onkeyup="filterAdminUsers()" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; width: 100%;">           
                        </div>
                 
                        <div style="overflow-x: auto; margin-top: 20px;">                
                            <table class="data-table" style="width: 100%; border-collapse: collapse;">   
                                <thead>    
                                    <tr style="background: #f3f4f6; text-align: left;">     
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Email</th>     
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">User ID</th>         
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Students</th>        
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Subscription</th>        
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Status</th>       
                                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Actions</th>       
                                    </tr>        
                                </thead>                   
                                <tbody id="adminUsersTableBody">                      
                                    <tr>                         
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">                            
                                            Click "All Users" tab to load data                          
                                        </td>                       
                                    </tr>                    
                                </tbody>                        
                            </table>         
                        </div>    
                    </div>
       
                    <!-- Subscriptions Tab -->      
                    <div id="admin-subscriptions-tab" class="admin-tab-content" style="display: none;">        
                        <h3 class="card-title">Subscription Overview</h3>         
                        <div id="adminSubscriptionsList">         
                            <p>Subscription management tools coming soon...</p>        
                        </div>      
                    </div>
      
                    <!-- Analytics Tab -->    
                    <div id="admin-analytics-tab" class="admin-tab-content" style="display: none;">      
                        <h3 class="card-title">Platform Analytics</h3>        
                        <div id="adminAnalytics">        
                            <p>Analytics dashboard coming soon...</p>        
                        </div>      
                    </div>

     
                    <!-- Admin Settings Tab -->    
                    <div id="admin-settings-tab" class="admin-tab-content" style="display: none;">      
                        <h3 class="card-title">Admin Management</h3>            
     
                        <div class="card" style="background: #f9fafb; padding: 20px; margin: 20px 0; border-radius: 12px;">     
                            <h4 style="margin-top: 0;">Add New Admin</h4>
                               
                            <div class="form-group">              
                                <label>Email Address</label>              
                                <input type="email" id="newAdminEmail" placeholder="admin@example.com" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; width: 100%; max-width: 400px;">           
                            </div>
                              
                            <div class="form-group">                 
                                <label>Admin Role</label>                 
                                <select id="newAdminRole" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; width: 100%; max-width: 400px;">                   
                                    <option value="super_admin">Super Admin (Full Access)</option>        
                                    <option value="support_admin">Support Admin (User Management)</option>                     
                                    <option value="analytics_admin">Analytics Admin (View Only)</option>                 
                                </select>                  
                                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">                  
                                    ‚ö†Ô∏è The user must have an account before being made an admin                
                                </p>              
                            </div>
                               
                            <button class="btn btn-primary" onclick="addNewAdmin()" style="margin-top: 10px;">             
                                ‚ûï Add Admin             
                            </button>
                        </div>
                      
                        <div id="adminsList" style="margin-top: 30px;">            
                            <h3>Current Admins</h3>            
                            <p style="color: #6b7280;">Loading...</p>          
                        </div>      
                    </div>   
                </div>
            </div>
            
            <!-- Dashboard Screen -->
            <div id="dashboard" class="screen active">
                <div class="screen-header">
                    <h1 class="screen-title">Dashboard</h1>
                    <p class="screen-subtitle">Welcome back! Here's your overview</p>
                </div>
                <div class="form-group" style="max-width: 300px;">
                    <label>Filter by Grade</label>
                    <select id="gradeFilter" onchange="updateDashboard()">
                        <option value="all">All Grades</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Total Students</p>
                                <h3 id="totalStudents">0</h3>
                            </div>
                            <div class="stat-icon blue">üë•</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Today's Classes</p>
                                <h3 id="todayClasses">0</h3>
                            </div>
                            <div class="stat-icon green">üìÖ</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Pending Payments</p>
                                <h3 id="pendingPayments">0</h3>
                            </div>
                            <div class="stat-icon amber">‚ö†Ô∏è</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-info">
                                <p>Attendance Rate</p>
                                <h3 id="attendanceRate">0%</h3>
                            </div>
                            <div class="stat-icon purple">‚úÖ</div>
                        </div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <h3 class="card-title">Quick Actions</h3>
                        <button class="btn btn-primary" onclick="navigateTo('attendance')" style="margin-bottom: 12px;">‚úÖ Mark Attendance</button>
                        <button class="btn btn-success" onclick="navigateTo('payments')" style="margin-bottom: 12px;">üí∞ Record Payment</button>
                        <button class="btn btn-secondary" onclick="navigateTo('reports')">üìÑ Generate Report</button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Today's Classes</h3>
                        <div id="todayClassesList"></div>
                    </div>
                </div>
            </div>

            <!-- Students Screen -->
            <div id="students" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Student Management</h1>        
                    <p class="screen-subtitle">Manage all students</p>    
                </div>
    
                <!-- SIMPLE EXPORT BUTTONS -->   
                <div class="glass-card" style="margin-bottom: 20px; max-width: 700px; margin-left: auto; margin-right: auto;">        
                    <h3 class="card-title">üì• Export Students</h3>       
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">           
                        <button class="btn btn-success" onclick="exportStudentsToExcel()">              
                            üìä All Students Excel            
                        </button>           
                        <button class="btn btn-primary" onclick="exportStudentsByGrade()">               
                            üìë By Grade Excel            
                        </button>            
                        <button class="btn btn-secondary" onclick="exportCurrentGradeStudents()">                
                            üìÑ Current Tab Only            
                        </button>        
                    </div>   
                </div>
   
                <div class="grid-2">
                    <!-- Left Side - Student List by Grade Tabs -->
                    <div class="card">
                        <h3 class="card-title">Students by Grade</h3>
                        
                        <!-- Grade Tabs -->
                        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="grade-tab active" data-grade="all" onclick="switchGradeTab('all')">
                                All
                            </button>
                            <div id="gradeTabs"></div>
                        </div>

                        <!-- Search -->
                        <div class="form-group">
                            <input type="text" id="studentSearchBox" placeholder="Search by name, ID, or phone..." oninput="filterStudentsByTab()">
                        </div>

                        <!-- Student List -->
                        <div id="studentListByGrade" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <!-- Right Side - Student Form -->
                    <div class="card">
                        <h3 class="card-title" id="studentFormTitle">Add New Student</h3>
                        
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="studentNameInput" placeholder="Enter student name">
                        </div>

                        <div class="form-group">
                            <label>Birthday *</label>
                            <input type="date" id="studentBirthdayInput">
                        </div>

                        <div class="form-group">
                            <label>Gender *</label>
                            <select id="studentGenderInput">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Class *</label>
                            <select id="studentClassInput">
                                <option value="">Select Class</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Grade *</label>
                            <select id="studentGradeInput"></select>
                        </div>

                        <div class="form-group">
                            <label>Student's Phone Number</label>
                            <input type="tel" id="studentPhoneInput" placeholder="e.g., 0771234567">
                        </div>

                        <div class="form-group">
                            <label>Parent's Phone Number *</label>
                            <input type="tel" id="parentPhoneInput" placeholder="e.g., 0771234567">
                        </div>

                        <div id="studentIdDisplaySection" style="display: none;">
    
                            <div class="form-group">        
                                <label>Student ID</label>        
                                <input type="text" id="studentIdDisplay" disabled style="background: #F3F4F6; font-weight: 600;">   
                            </div>
        
                            <div style="text-align: center; padding: 20px; background: #F3F4F6; border-radius: 12px; border: 2px dashed #D1D5DB;">        
                                <div style="font-size: 48px; margin-bottom: 12px;">üì±</div>    
                                <p style="font-weight: 600; color: #374151; margin-bottom: 8px;">QR Code Ready</p>
                                <p style="font-size: 14px; color: #6B7280; margin-bottom: 16px;" id="qrCodeText"></p>        
        
                                <button type="button" class="btn btn-primary" onclick="showQRCodeForCurrentStudent()">            
                                    üé´ View & Download QR Code        
                                </button>    
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid-2" style="gap: 12px; margin-top: 20px;">
                            <button class="btn btn-primary" id="addStudentBtn" onclick="addNewStudent()">
                                ‚ûï Add
                            </button>
                            <button class="btn btn-success" id="updateStudentBtn" style="display: none;" onclick="updateExistingStudent()">
                                üíæ Update
                            </button>
                            <button class="btn btn-danger" id="deleteStudentBtn" style="display: none;" onclick="deleteExistingStudent()">
                                üóëÔ∏è Delete
                            </button>
                            <button class="btn btn-secondary" id="clearStudentBtn" onclick="clearStudentForm()">
                                ‚úñÔ∏è Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Timetable Screen -->
            <div id="timetable" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Timetable</h1>
                    <p class="screen-subtitle" id="subjectDisplay">Subject: Mathematics</p>
                </div>
                <button class="btn btn-primary" onclick="showAddTimetable()" style="margin-bottom: 20px;">‚ûï Add Class</button>
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Grade</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timetableTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 40px; color: #6B7280;">No classes scheduled</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Screen -->
            <div id="attendance" class="screen">  
                <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">      
                    <div class="screen-header">            
                        <h1 class="screen-title">Mark Attendance</h1>         
                        <p class="screen-subtitle">Track student attendance</p>     
                    </div>

                    <!-- Step 1 & 2: Select Class and Date -->     
                    <div class="card">           
                        <h3 class="card-title">Step 1 & 2: Select Class and Date</h3>           
            
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Select Class *</label>                    
                                <select id="attendanceClassSelect" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 16px;">                       
                                    <option value="">Choose a class</option>        
                                    <option value="06">Grade 06</option>                        
                                    <option value="07">Grade 07</option>                        
                                    <option value="08">Grade 08</option>                        
                                    <option value="09">Grade 09</option>                        
                                    <option value="10">Grade 10</option>                       
                                    <option value="11">Grade 11</option>                       
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Select Date *</label>                 
                                <input type="date" id="attendanceDateSelect" style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 16px;">
                            </div>
                        </div>
            
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="loadAttendanceStudents()" style="flex: 1;">
                                üìã Load Students
                            </button>
                            <button class="btn btn-secondary" onclick="openQRScanner('attendance')">        
                                üì∑ Scan QR    
                            </button>    
                            <button class="btn btn-secondary" onclick="manualQRInput('attendance')">        
                                ‚å®Ô∏è Manual Entry    
                            </button>
                        </div>        
                    </div>

                    <!-- Step 4: Mark Present/Absent -->
                    <div class="card" id="attendanceStudentCard" style="display: none;">
                        <h3 class="card-title">Step 4: Mark Attendance</h3>
            
                        <!-- Stats -->           
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">                
                            <div style="background: #F3F4F6; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #6B7280; margin-bottom: 5px;">Total Students</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #1F2937;" id="attendanceTotalCount">0</h3>                
                            </div>                
                            <div style="background: #D1FAE5; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #065F46; margin-bottom: 5px;">Present</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #065F46;" id="attendancePresentCount">0</h3>                
                            </div>                
                            <div style="background: #FEE2E2; padding: 15px; border-radius: 10px; text-align: center;">                    
                                <p style="font-size: 14px; color: #991B1B; margin-bottom: 5px;">Absent</p>                    
                                <h3 style="font-size: 28px; font-weight: bold; color: #991B1B;" id="attendanceAbsentCount">0</h3>                
                            </div>            
                        </div>
            
                        <!-- Student List -->
                        <div id="attendanceStudentsList"></div>

                        <!-- Step 5: Save -->            
                        <button class="btn btn-success" onclick="saveAttendanceData()" style="margin-top: 20px; width: 100%;">                
                            üíæ Step 5: Save Attendance
                        </button>        
                    </div>
                </div>
            </div>

            <!-- Payments Screen -->
            <div id="payments" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Payment Management</h1>
                    <p class="screen-subtitle">Manage student fee payments</p>
                </div>

                <div class="card">
                    <h3 class="card-title">Record Payment</h3>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">    
                        <button class="btn btn-primary" onclick="openQRScanner('payment')" style="flex: 1;">        
                            üì∑ Scan QR Code    
                        </button>    
                        <button class="btn btn-secondary" onclick="manualQRInput('payment')">        
                            ‚å®Ô∏è Manual Entry
                        </button>
                    </div>

                    <div class="form-group">
                        <label>Student ID *</label>
                        <input type="text" id="paymentStudentId" placeholder="Enter student ID or scan QR">
                    </div>

                    <div class="form-group">
                        <label>Class (Auto-filled)</label>
                        <input type="text" id="paymentClass" placeholder="Will auto-fill after entering ID" disabled>
                    </div>

                    <div class="form-group">
                        <label>Month *</label>
                        <select id="paymentMonthDropdown">
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="paymentAmountInput" placeholder="Enter amount">
                    </div>

                    <div class="form-group">
                        <label>Payment Status *</label>
                        <select id="paymentStatusDropdown">
                            <option value="Paid">Paid</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Free Card">Free Card</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="recordPayment()">
                        üíæ Record Payment
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title">Payment History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th>Class</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #6B7280;">
                                        No payment records yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Screen -->
            <div id="reports" class="screen">
                <div class="screen-header">
                    <h1 class="screen-title">Reports</h1>
                </div>
                <div class="card">
                    <h3 class="card-title">Generate Report</h3>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="attendance">Monthly Attendance by Grade</option>
                            <option value="payment">Payment Collection Summary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Month</label>
                        <input type="month" id="reportMonth">
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="reportGrade">
                            <option value="all">All Grades</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">üìä Generate</button>
                    <button class="btn btn-success" onclick="exportToExcel()" style="margin-top: 12px;">üì• Export Excel</button>
                </div>
                <div class="card" id="reportPreview" style="display: none;">
                    <h3 class="card-title">Preview</h3>
                    <div id="reportContent"></div>
                </div>
            </div>
       
            <!-- QR Scanner Modal -->
            <div class="modal" id="qrScannerModal">    
                <div class="modal-content" style="max-width: 600px;">        
                    <div class="modal-header">            
                        <h3 class="modal-title">üì∑ Scan QR Code</h3>            
                        <button class="close-btn" onclick="closeQRScanner()">‚úñ</button>
                    </div>        
                    <div id="qr-reader" style="width: 100%;"></div>                
                    <div style="margin-top: 20px; padding: 15px; background: #F3F4F6; border-radius: 8px;">            
                        <p style="margin: 0; font-size: 14px; color: #6B7280;">                
                            üì± Position the QR code in front of your camera            
                        </p>
                        <button class="btn btn-secondary" onclick="switchCamera()" style="margin-top: 15px;">            
                            üîÑ Switch Camera        
                        </button>
                    </div>
               
                    <div id="qr-result" style="margin-top: 15px; padding: 15px; background: #D1FAE5; border-radius: 8px; display: none;">            
                        <p style="margin: 0; font-weight: 600; color: #065F46;">             
                            ‚úÖ Scanned: <span id="qr-scanned-id"></span>            
                        </p>        
                    </div>    
                </div>
            </div>

            <!-- Subscription Screen -->
            <div id="subscription" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Subscription Plans</h1>       
                    <p class="screen-subtitle">Choose the plan that fits your needs</p>    
                </div>
    
                <!-- Current Subscription Status -->    
                <div class="glass-card" style="margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">       
                    <h3 class="card-title">üìã Current Subscription</h3>
             
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">           
                        <div style="background: rgba(59,130,246,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Current Plan</p>               
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="currentPlanName">Free Trial</p>            
                        </div>            
                        <div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Status</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="subscriptionStatus">Active</p>            
                        </div>            
                        <div style="background: rgba(245,158,11,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Students</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;"><span id="currentStudents">0</span> / <span id="maxStudents">10</span></p>            
                        </div>            
                        <div style="background: rgba(139,92,246,0.2); padding: 15px; border-radius: 12px;">                
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Valid Until</p>                
                            <p style="font-size: 20px; font-weight: 700; color: #fff; margin: 0;" id="subscriptionEndDate">-</p>            
                        </div>   
                    </div>        
                    <div id="subscriptionWarning" style="display: none; background: rgba(239,68,68,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.3);">            
                        <p style="margin: 0; color: #FEE2E2; font-weight: 600;">‚ö†Ô∏è <span id="warningMessage"></span></p>        
                    </div>    
                </div>
    
                <!-- Pricing Plans -->    
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
               
                    <!-- Free Trial Plan -->        
                    <div class="glass-card" style="position: relative;">            
                        <div style="background: rgba(107,114,128,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">                
                            <span style="font-size: 12px; font-weight: 600; color: #fff;">FREE TRIAL</span>            
                        </div>         
            
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 10px;">                
                            Free            
                        </h3>            
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Perfect for trying out</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Up to 10 students</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Attendance tracking</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Payment records</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #EF4444; font-size: 20px;">‚úó</span>                    
                                <span style="color: rgba(255,255,255,0.5);">Advanced reports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #EF4444; font-size: 20px;">‚úó</span>                    
                                <span style="color: rgba(255,255,255,0.5);">Unlimited students</span>                
                            </div>            
                        </div>            
            
                        <button class="btn btn-secondary" onclick="selectPlan('free_trial')" id="btnFreeTrial">                
                            Current Plan            
                        </button>        
                    </div>
        
                    <!-- Monthly Plan -->       
                    <div class="glass-card" style="position: relative; border: 2px solid #10B981;">            
                        <div style="position: absolute; top: -12px; right: 20px; background: #10B981; padding: 4px 12px; border-radius: 12px;">                
                            <span style="font-size: 11px; font-weight: 700; color: #fff;">POPULAR</span>           
                        </div>
                       
                        <div style="background: rgba(16,185,129,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">              
                            <span style="font-size: 12px; font-weight: 600; color: #D1FAE5;">MONTHLY</span>            
                        </div>
                        
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 5px;">                
                            LKR.1000.00<span style="font-size: 16px; font-weight: 400; color: rgba(255,255,255,0.7);">/month</span>          
                        </h3>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Best for small classes</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Unlimited students</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">All attendance features</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Advanced reports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                   
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Excel exports</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Priority support</span>                
                            </div>            
                        </div>           
                        <button class="btn btn-success" onclick="initiatePayment('monthly')" id="btnMonthly">                
                            Subscribe Monthly            
                        </button>        
                    </div>
    
                    <!-- Annual Plan -->        
                    <div class="glass-card" style="position: relative; border: 2px solid #3B82F6;">            
                        <div style="position: absolute; top: -12px; right: 20px; background: #3B82F6; padding: 4px 12px; border-radius: 12px;">               
                            <span style="font-size: 11px; font-weight: 700; color: #fff;">SAVE 20%</span>           
                        </div>
                       
                        <div style="background: rgba(59,130,246,0.3); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">                
                            <span style="font-size: 12px; font-weight: 600; color: #DBEAFE;">ANNUAL</span>           
                        </div>
                       
                        <h3 style="font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 5px;">                
                            LKR.9600.00<span style="font-size: 16px; font-weight: 400; color: rgba(255,255,255,0.7);">/year</span>            
                        </h3>
                        
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Save LKR.2400.00/year</p>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-bottom: 20px;">               
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                   
                                <span style="color: rgba(255,255,255,0.9);">Everything in Monthly</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">20% discount</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Priority updates</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">Dedicated support</span>                
                            </div>                
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">                    
                                <span style="color: #10B981; font-size: 20px;">‚úì</span>                    
                                <span style="color: rgba(255,255,255,0.9);">No ads (coming soon)</span>                
                            </div>            
                        </div>
                        
                        <button class="btn btn-primary" onclick="initiatePayment('annual')" id="btnAnnual">                
                            Subscribe Annual            
                        </button>        
                    </div>    
                </div>

                <!-- Payment History -->
                <div class="glass-card" style="margin-top: 40px; max-width: 1000px; margin-left: auto; margin-right: auto;">  
                    <h3 class="card-title">üí≥ Payment History</h3>
       
                    <div class="table-container">        
                        <table>            
                            <thead>                
                                <tr>                    
                                    <th>Date</th>                    
                                    <th>Order ID</th>                    
                                    <th>Plan</th>                    
                                    <th>Amount</th>                   
                                    <th>Status</th>                
                                </tr>            
                            </thead>           
                            <tbody id="paymentHistoryTableBody">                
                                <tr>                    
                                    <td colspan="5" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">                        
                                        No payment history yet                   
                                    </td>                
                                </tr>            
                            </tbody>        
                        </table>    
                    </div>
                </div>
    
                <!-- FAQs -->    
                <div class="glass-card" style="margin-top: 40px; max-width: 800px; margin-left: auto; margin-right: auto;">        
                    <h3 class="card-title">‚ùì Frequently Asked Questions</h3>        
        
                    <div style="margin-bottom: 20px;">           
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">Can I cancel anytime?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Yes! You can cancel your subscription at any time. You'll continue to have access until the end of your billing period.</p>        
                    </div>
                
                    <div style="margin-bottom: 20px;">            
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">What happens to my data if I cancel?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Your data is always yours. You can export all your data before canceling. We keep your data for 30 days after cancellation.</p>      
                    </div>
        
                    <div style="margin-bottom: 20px;">                  
                        <h4 style="color: #fff; font-size: 16px; margin-bottom: 8px;">Can I upgrade or downgrade my plan?</h4>            
                        <p style="color: rgba(255,255,255,0.7); font-size: 14px;">Yes! You can change your plan at any time. Upgrades are immediate, and downgrades take effect at the end of your billing period.</p>        
                    </div>    
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settings" class="screen">    
                <div class="screen-header">        
                    <h1 class="screen-title">Settings</h1>   
                </div>

                <!-- Data Synchronization Card - NEW -->
                <div class="card">
                    <h3 class="card-title">üíæ Data Synchronization</h3>
        
                    <!-- Sync Status Row -->
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="flex: 1;">
                            <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 14px; color: rgba(255,255,255,0.9);">Last Synced</p>
                            <p id="lastSyncTime" style="margin: 0; color: rgba(255,255,255,0.7); font-size: 14px;">Never</p>
                        </div>
            
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <!-- Sync Indicator -->
                            <div id="syncIndicator" style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px rgba(16,185,129,0.5);"></div>
                
                            <!-- Sync Button -->
                            <button class="btn btn-primary" onclick="syncNowManual()" id="syncNowBtn">
                                <span id="syncNowBtnText">üîÑ Sync Now</span>
                            </button>
                        </div>
                    </div>
        
                    <!-- Sync Status Message -->
                    <div id="syncStatusMessage" style="display: none; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px;">
                        <p id="syncStatusText" style="margin: 0; font-size: 14px; font-weight: 500;"></p>
                    </div>
        
                    <!-- Sync Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(59,130,246,0.2); border-radius: 8px; text-align: center; border: 1px solid rgba(59,130,246,0.3);">
                            <p style="margin: 0 0 4px 0; font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">Students</p>
                            <p id="syncStudentsCount" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff;">0</p>
                        </div>
            
                        <div style="padding: 12px; background: rgba(16,185,129,0.2); border-radius: 8px; text-align: center; border: 1px solid rgba(16,185,129,0.3);">
                            <p style="margin: 0 0 4px 0; font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">Classes</p>
                            <p id="syncClassesCount" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff;">0</p>
                        </div>
            
                        <div style="padding: 12px; background: rgba(245,158,11,0.2); border-radius: 8px; text-align: center; border: 1px solid rgba(245,158,11,0.3);">
                            <p style="margin: 0 0 4px 0; font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">Payments</p>
                            <p id="syncPaymentsCount" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff;">0</p>
                        </div>
                    </div>
        
                    <!-- Info Text -->
                    <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 0; line-height: 1.5;">
                        ‚ÑπÔ∏è Your data is automatically synced with the cloud in real-time. Use the "Sync Now" button to manually force synchronization or check for updates.
                    </p>
                </div>

                <!-- Account Card -->
                <div class="card">                    
                    <h3 class="card-title">üë§ Account</h3>
            
                    <div style="background: rgba(59,130,246,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px;">                            
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">Your Teacher ID:</p>                      
                        <p style="font-size: 16px; font-weight: 600; color: #fff; font-family: monospace;" id="teacherIdDisplay"></p>                       
                        <button class="btn btn-secondary" onclick="copyTeacherId()" style="margin-top: 10px; width: auto;">                
                            üìã Copy ID                      
                        </button>                   
                    </div>
            
                    <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">                            
                        üí° Save this ID to access your data from any device                    
                    </p>    
                </div>

                <!-- Cloud Sync Status - NEW SECTION -->
                <div class="card">
                    <h3 class="card-title">‚òÅÔ∏è Cloud Synchronization</h3>
        
                    <div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(16,185,129,0.3);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 20px;">‚úÖ</span>
                            <span style="font-weight: 600; color: #D1FAE5;">Cloud Sync Active</span>
                        </div>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">
                            Your data is automatically saved to the cloud in real-time
                        </p>
                    </div>
        
                    <!-- Last Saved Info -->
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 0;">
                            üìÖ Last Saved: <span id="lastSavedTime" style="font-weight: 600; color: #fff;">Never</span>
                        </p>
                    </div>
        
                    <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 0 0 8px 0; line-height: 1.6;">
                        ‚úì Works on all your devices<br>
                        ‚úì Always up-to-date<br>
                        ‚úì Protected by Firebase security<br>
                        ‚úì No manual saving required
                    </p>
                </div>

                <!-- Grades Card -->   
                <div class="card">
                    <h3 class="card-title">Grades</h3>        
                    <div id="gradesList"></div>       
                    <div style="display: flex; gap: 12px; margin-top: 16px;">            
                        <input type="text" id="newGrade" placeholder="e.g., 13" style="flex: 1;">            
                        <button class="btn btn-primary" onclick="addGrade()">‚ûï Add</button>        
                    </div>    
                </div>

                <!-- Subject Card -->    
                <div class="card">        
                    <h3 class="card-title">Subject</h3>        
                    <div class="form-group">            
                        <label>Subject Name</label>            
                        <input type="text" id="subjectNameInput" value="Mathematics">        
                    </div>        
                    <button class="btn btn-primary" onclick="saveSubject()">üíæ Save</button>    
                </div>

                <!-- Manual Device Backup (Optional) - UPDATED -->
                <div class="card">
                    <h3 class="card-title">üíæ Manual Device Backup (Optional)</h3>
        
                    <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 16px; line-height: 1.6;">
                        Download a backup file to your device for safekeeping. This is <strong>optional</strong> since your data is already safely stored in the cloud.
                    </p>
        
                    <button class="btn btn-primary" onclick="downloadBackup()" style="margin-bottom: 12px;">
                        üíæ Download Backup File
                    </button>
        
                    <button class="btn btn-secondary" onclick="uploadBackup()" style="margin-bottom: 20px;">
                        üìÇ Restore from Backup File
                    </button>
        
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 0;">
                            üì¶ Last Manual Backup: <span id="lastBackupTime" style="font-weight: 600; color: #fff;">Never</span>
                        </p>
                    </div>
                </div>

                <!-- Data Statistics -->
                <div class="card">
                    <h3 class="card-title">üìä Data Statistics</h3>
        
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: rgba(59,130,246,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Students</p>
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsStudents">0</p>
                        </div>
                        <div style="background: rgba(16,185,129,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Payments</p>
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsPayments">0</p>
                        </div>
                        <div style="background: rgba(245,158,11,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Classes</p>
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsTimetable">0</p>
                        </div>
                        <div style="background: rgba(139,92,246,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Attendance Records</p>
                            <p style="font-size: 24px; font-weight: 700; color: #fff; margin: 0;" id="statsAttendance">0</p>
                        </div>
                    </div>
        
                    <!-- Export Data -->
                    <h4 style="color: #fff; font-size: 16px; margin-bottom: 12px;">Export Data</h4>
                    <button class="btn btn-success" onclick="exportAllDataToExcel()" style="margin-bottom: 20px;">
                        üìä Export All Data to Excel
                    </button>
                </div>

                <!-- Danger Zone -->
                <div class="card">
                    <div style="background: rgba(239,68,68,0.2); padding: 15px; border-radius: 12px; border: 1px solid rgba(239,68,68,0.3);">
                        <h4 style="color: #FEE2E2; font-size: 16px; margin-bottom: 8px;">‚ö†Ô∏è Danger Zone</h4>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px;">
                            This action cannot be undone. All data will be permanently deleted from the cloud.
                        </p>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- QR Code Display Modal -->
            <div class="modal" id="qrCodeDisplayModal">    
                <div class="modal-content" style="max-width: 500px;">        
                    <div class="modal-header">            
                        <h3 class="modal-title">Student QR Code</h3>            
                        <button class="close-btn" onclick="closeQRCodeDisplay()">‚úñ</button>        
                    </div>
        
                    <div style="text-align: center;">            
                        <div style="background: #F3F4F6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">                
                            <p style="font-size: 18px; font-weight: 600; color: #1F2937; margin-bottom: 5px;" id="qrStudentName"></p>                
                            <p style="font-size: 14px; color: #6B7280; margin-bottom: 15px;" id="qrStudentDetails"></p>
                            
                            <!-- QR Code will be generated here -->                                
                            <div id="qrcode-container" style="display: flex; justify-content: center; margin: 20px 0;"></div>                                
                            
                            <p style="font-size: 16px; font-weight: 600; color: #2563EB;" id="qrStudentId"></p>            
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">                
                            <button class="btn btn-primary" onclick="downloadQRCode()">        
                                üíæ Download QR Code            
                            </button>                
                            <button class="btn btn-success" onclick="downloadStudentCard()">                    
                                üé´ Download ID Card        
                            </button>            
                        </div>        
                    </div>    
                </div>
            </div>
    
            <!-- Timetable Modal -->   
            <div class="modal" id="timetableModal">       
                <div class="modal-content">           
                    <div class="modal-header">                
                        <h3 class="modal-title" id="timetableModalTitle">Add Class</h3>                
                        <button class="close-btn" onclick="closeTimetableModal()">‚úñ</button>            
                    </div>           
                    <div class="form-group">                
                        <label>Day</label>                
                        <select id="timetableDay">                    
                            <option>Monday</option>                   
                            <option>Tuesday</option>                    
                            <option>Wednesday</option>                    
                            <option>Thursday</option>                    
                            <option>Friday</option>                   
                            <option>Saturday</option>                    
                            <option>Sunday</option>               
                        </select>            
                    </div>            
                    <div class="form-group">                
                        <label>Time</label>                
                        <input type="time" id="timetableTime">           
                    </div>            
                    <div class="form-group">                
                        <label>Grade</label>                
                        <select id="timetableGrade"></select>            
                    </div>           
                    <div class="form-group">                
                        <label>Notes</label>               
                        <input type="text" id="timetableNotes" placeholder="e.g., Room 101">           
                    </div>            
                    <button class="btn btn-primary" onclick="saveTimetableEntry()">üíæ Save</button>        
                </div>    
            </div>
    
            <!-- Payment Modal -->
            <div class="modal" id="paymentModal">        
                <div class="modal-content">            
                    <div class="modal-header">                
                        <h3 class="modal-title">Record Payment</h3>                
                        <button class="close-btn" onclick="closePaymentModal()">‚úñ</button>            
                    </div>            
                    <div class="form-group">                
                        <label>Amount</label>                
                        <input type="number" id="paymentAmount" placeholder="Enter amount">            
                    </div>            
                    <div class="form-group">                
                        <label>Date</label>                
                        <input type="date" id="paymentDate">            
                    </div>            
                    <div class="form-group">                
                        <label>Month</label>                
                        <input type="month" id="paymentMonth">            
                    </div>            
                    <div class="form-group">                
                        <label>Method</label>                
                        <select id="paymentMethod">                    
                            <option>Cash</option>                    
                            <option>Bank Transfer</option>                    
                            <option>Mobile Payment</option>              
                        </select>            
                    </div>         
                    <button class="btn btn-primary" onclick="savePayment()">üíæ Record</button>        
                </div>    
            </div>
        </div>
    </div>
    <footer class="app-footer">  
        ¬© <span id="year"></span> Class Manager WebApp. All rights reserved.
    </footer>
    <script type="text/javascript" src="https://www.payhere.lk/lib/payhere.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script type="module">     
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    </script>
    <script src="Js/AM Screen.js"></script>
    <script src="Js/Excel Export.js"></script>
    <script src="Js/Payhere.js"></script>
    <script src="Js/PM Screen.js"></script>
    <script src="Js/Reports.js"></script>
    <script src="Js/Save.js"></script>
    <script src="Js/Settings.js"></script>
    <script src="Js/SM Screen.js"></script>
    <script src="Js/Subscription.js"></script>
    <script src="Js/Timetable.js"></script>
    <script src="Js/QR Codes.js"></script>
    <script src="Js/"></script>
    <script>
        // ============================================
        // DECLARE GLOBAL VARIABLES FIRST
        // ============================================
    
        var database;  // Global Firebase database reference
        var auth;      // Global Firebase auth reference
        var currentUser = null;
        var currentUserId = null;
        var lastSyncedTimestamp = null;
        var isAdmin = false;
        var adminRole = null;
        var adminPermissions = {};
        var allUsersData = [];
                
        // ============================================        
        // FIREBASE CONFIGURATION        
        // ============================================
    
        const firebaseConfig = {    
            apiKey: "AIzaSyD4z857J2ipSxqK8pN4tEWqU-jeK_mwA2I", 
            authDomain: "class-manager-383ad.firebaseapp.com",  
            databaseURL: "https://class-manager-383ad-default-rtdb.asia-southeast1.firebasedatabase.app",  
            projectId: "class-manager-383ad",   
            storageBucket: "class-manager-383ad.firebasestorage.app",   
            messagingSenderId: "1085651561679",  
            appId: "1:1085651561679:web:82ca82d59d6ff2ec671bba"         
        };
              
        // Initialize Firebase     
        firebase.initializeApp(firebaseConfig);           
        database = firebase.database();
        auth = firebase.auth();

        console.log('‚úÖ Firebase initialized successfully');

        // ============================================
        // ADMIN DETECTION
        // ============================================

         async function checkIfAdmin(userId, userEmail) {
            try {
                console.log('üîç Checking admin status for:', userEmail);
        
                // Check if email exists in /admins/
                const emailKey = userEmail.replace(/\./g, '_').replace(/@/g, '@');
                const adminCheck = await database.ref('admins/' + emailKey).once('value');
        
                if (adminCheck.val() === true) {
                    console.log('‚úÖ User is an admin!');
                    isAdmin = true;
            
                    // Get admin profile with permissions
                    const adminProfile = await database.ref('admin-users/' + userId).once('value');
            
                    if (adminProfile.exists()) {
                        const profile = adminProfile.val();
                        adminRole = profile.role || 'admin';
                        adminPermissions = profile.permissions || {};
                        console.log('üëë Admin Role:', adminRole);
                        console.log('üîë Permissions:', adminPermissions);
                    } else {
                        // Default permissions if no profile exists
                        adminRole = 'super_admin';
                        adminPermissions = {
                            canViewAllUsers: true,
                            canEditAllUsers: true,
                            canManageSubscriptions: true,
                            canViewAnalytics: true,
                            canAddAdmins: true,
                            canDeleteUsers: true
                        };
                        console.log('‚ö†Ô∏è No admin profile found, using default super_admin permissions');
                    }
            
                    // Update UI for admin
                    updateUIForAdmin();
                    return true;
                }
        
                console.log('‚ÑπÔ∏è User is not an admin');
                isAdmin = false;
                return false;
        
            } catch (error) {
                console.error('‚ùå Error checking admin status:', error);
                isAdmin = false;
                return false;
            }
        }

        function updateUIForAdmin() {
            // Show admin menu item
            const adminMenuItem = document.getElementById('adminMenuItem');
            if (adminMenuItem) {
                adminMenuItem.style.display = 'flex';
            }
    
            // Add admin badge to navbar
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand && !document.querySelector('.admin-badge')) {
                const badge = document.createElement('span');
                badge.className = 'admin-badge';
                badge.textContent = 'üëë ADMIN';
                badge.style.cssText = 'background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; margin-left: 12px; box-shadow: 0 2px 8px rgba(255,215,0,0.3);';
                navbarBrand.appendChild(badge);
            }
    
            console.log('‚úÖ Admin UI updated');
        }

        // ============================================    
        // PAYHERE & APP DATA   
        // ============================================

        // PayHere Configuration
        const PAYHERE_CONFIG = {
            // SANDBOX CREDENTIALS (for testing)
            merchantId: '1221149',  // Replace with your Merchant ID
            sandbox: true,  // Set to false for production
    
            // Your website details
            returnUrl: window.location.href,
            cancelUrl: window.location.href,
            notifyUrl: 'https://yourwebsite.com/notify',  // Optional: for server-side notifications
    
            // Business details
            businessName: 'Class Manager',
            currency: 'LKR'
        };

        // Subscription prices in LKR
        const SUBSCRIPTION_PRICES = {
            monthly: {
                amount: 1000.00,  // Rs. 2,999.00
                currency: 'LKR',
                description: 'Class Manager - Monthly Subscription'
            },
            annual: {
                amount: 9600.00,  // Rs. 28,799.00 (Save 20%)
                currency: 'LKR',
                description: 'Class Manager - Annual Subscription'
            }
        };
    
        let appData = {        
            students: [],
            grades: ['06', '07', '08', '09', '10', '11', '12'],
            timetable: [],
            attendance: {},
            payments: [],
            subjectName: 'Mathematics',
            selectedStudent: null,
            editingTimetable: null,
            selectedPaymentStudent: null,
            // ADD SUBSCRIPTION DATA
            subscription: {
                plan: 'free_trial',  // 'free_trial', 'monthly', 'annual'
                status: 'active',     // 'active', 'expired', 'cancelled'
                startDate: new Date().toISOString(),
                endDate: null,
                maxStudents: 10,      // Free trial limit
                features: {
                    students: true,
                    attendance: true,
                    payments: true,
                    reports: true,
                    backup: true
                }
            }
        };

        // ============================================
        // CHECK AUTHENTICATION
        // ============================================

        auth.onAuthStateChanged(async (user) => {    
            if (user) {        
                currentUser = user;        
                currentUserId = user.uid;
                       
                console.log('‚úÖ User authenticated:', user.email);        
                console.log('User ID:', currentUserId);
                
                // ‚≠ê SAVE USER EMAIL TO FIREBASE PROFILE       
                try {           
                    const profileRef = database.ref('users/' + currentUserId + '/profile');           
                    const profileSnapshot = await profileRef.once('value');
                                          
                    if (!profileSnapshot.exists()) {            
                        // First time - create profile      
                        await profileRef.set({                 
                            email: user.email,                  
                            displayName: user.displayName || '',                  
                            photoURL: user.photoURL || '',                  
                            createdAt: new Date().toISOString(),                  
                            lastLogin: new Date().toISOString()              
                        });              
                        console.log('‚úÖ User profile created with email:', user.email);           
                    } else {
                
                        // Update existing profile               
                        await profileRef.update({                  
                            email: user.email,                  
                            lastLogin: new Date().toISOString()               
                        });               
                        console.log('‚úÖ User profile updated with email:', user.email);          
                    }       
                } catch (error) {           
                    console.error('‚ùå Error saving user profile:', error);       
                }
              
                // CHECK IF USER IS ADMIN      
                await checkIfAdmin(currentUserId, user.email);                
                // Hide loader       
                setTimeout(() => {                      
                    const loader = document.getElementById('loader');                       
                    if (loader) {                           
                        loader.classList.add('hide-loader');                            
                        setTimeout(() => {                                
                            loader.style.display = 'none';                            
                        }, 600);                   
                    }             
                }, 1000);        
                initializeApp();                 
            } else {                       
                console.log('‚ùå No user authenticated, redirecting...');          
                window.location.href = 'index.html';       
            }
        });

        // ============================================
        // LOGOUT FUNCTION
        // ============================================

        function logout() {    
            if (!confirm('Are you sure you want to sign out?')) {        
                return;    
            }

            auth.signOut()        
                .then(() => {            
                    console.log('‚úÖ User logged out');            
                    window.location.href = 'index.html';        
                })        
                .catch((error) => {            
                    console.error('Logout error:', error);            
                    alert('‚ùå Error signing out: ' + error.message);        
                });
        }

        // ============================================
        // INITIALIZE APP
        // ============================================

        function initializeApp() {
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            console.log('‚ïë   APP INITIALIZATION                   ‚ïë');
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            console.log('User:', currentUser.email);
            console.log('UID:', currentUserId);

            migrateLocalStorageToFirebase();
            
            loadData();                // ‚Üê Load THIS user's data
            initializeSubscription();  // ‚Üê Load subscription info
            enableRealtimeSync();      // ‚Üê Enable real-time updates

            console.log('‚úÖ App initialized');
        }

        function init() {
            console.log('Initializing app...');
        
            // Load saved data   
            loadData();
            // INITIALIZE SUBSCRIPTION    
            initializeSubscription();
     
            // Show app immediately    
            const app = document.getElementById('app');    
            if (app) {        
                app.classList.add('active');        
                console.log('App shown');    
            } else {        
                console.error('App element not found!');    
            }
        
            // Update dashboard if function exists    
            if (typeof updateDashboard === 'function') {        
                updateDashboard();    
            }
       
            console.log('App initialized');
        }

        // ============================================
        // REAL-TIME SYNC FUNCTION
        // ============================================

        function updateSyncStatus(status) {
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            if (!syncIcon || !syncText) return;
    
            if (status === 'syncing') {
                syncIcon.textContent = 'üîÑ';
                syncText.textContent = 'Syncing...';
            } else if (status === 'synced') {
                syncIcon.textContent = '‚òÅÔ∏è';
                syncText.textContent = 'Synced';
            } else if (status === 'error') {
                syncIcon.textContent = '‚ö†Ô∏è';
                syncText.textContent = 'Offline';
            }
        }

        function updateLastSavedTime() {
            const lastSavedEl = document.getElementById('lastSavedTime');
            if (lastSavedEl && appData.lastSaved) {
                const savedDate = new Date(appData.lastSaved);
                lastSavedEl.textContent = savedDate.toLocaleString();
            }
        }

        function teacherIdDisplay() { 
            if (!currentUserId) {
                console.warn("Teacher ID not available yet");
                return; 
            }
  
            const el = document.getElementById("teacherIdDisplay"); 
            if (el) {  
                el.textContent = currentUserId;   
            }
        }
        
        function copyTeacherId() {   
            if (!currentUserId) return;
   
            navigator.clipboard.writeText(currentUserId)        
                .then(() => alert("‚úÖ Teacher ID copied"))     
                .catch(() => alert("‚ùå Copy failed"));
        }

        function testLoadAdminUsers() {
            console.log('üîß MANUAL TEST - Loading users...');
            console.log('Is Admin:', isAdmin);
            console.log('Admin Role:', adminRole);
            console.log('Permissions:', adminPermissions);
            console.log('Current User:', currentUser ? currentUser.email : 'Not logged in');
    
            loadAllUsers();
        }
        
        function navigateTo(screenName) {
            console.log('üîÑ Navigating to:', screenName);
    
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName).classList.add('active');

            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-screen="${screenName}"]`);

            if (menuItem) menuItem.classList.add('active');

            toggleSidebar();

            // Call screen-specific functions
            if (screenName === 'students') loadStudentsScreen();
            if (screenName === 'timetable') loadTimetable();
            if (screenName === 'attendance') {
                const dateInput = document.getElementById('attendanceDateSelect');
                if (dateInput && !dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }
            if (screenName === 'payments') loadPaymentHistory();
            if (screenName === 'settings') loadSettings();
            if (screenName === 'subscription') updateSubscriptionDisplay();
    
            // AUTO-LOAD users when opening admin panel
            if (screenName === 'admin-panel') {
                console.log('üìä Admin panel opened - auto-loading users...');
                setTimeout(() => {
                    loadAllUsers();
                }, 200);
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function populateGradeDropdowns() {
            const html = appData.grades.map(g => `<option value="${g}">Grade ${g}</option>`).join('');
        
            // Only update elements that exist    
            const gradeFilter = document.getElementById('gradeFilter');
    
            if (gradeFilter) {
                gradeFilter.innerHTML = '<option value="all">All Grades</option>' + html;
            }
    
            const studentGradeFilter = document.getElementById('studentGradeFilter');
            if (studentGradeFilter) {
                studentGradeFilter.innerHTML = '<option value="all">All Grades</option>' + html;
            }
    
            const studentGradeInput = document.getElementById('studentGradeInput');
            if (studentGradeInput) {
                studentGradeInput.innerHTML = '<option value="">Select Grade</option>' + html;
            }
    
            const attendanceGrade = document.getElementById('attendanceGrade');
            if (attendanceGrade) {
                attendanceGrade.innerHTML = html;
            }
    
            const attendanceClassSelect = document.getElementById('attendanceClassSelect');
            if (attendanceClassSelect) {
                attendanceClassSelect.innerHTML = '<option value="">Choose a class</option>' + html;
            }
    
            const timetableGrade = document.getElementById('timetableGrade');
            if (timetableGrade) {
                timetableGrade.innerHTML = html;
            }
    
            const paymentGradeFilter = document.getElementById('paymentGradeFilter');
            if (paymentGradeFilter) {
                paymentGradeFilter.innerHTML = '<option value="all">All Grades</option>' + html;
            }
    
            const reportGrade = document.getElementById('reportGrade');
            if (reportGrade) {
                reportGrade.innerHTML = '<option value="all">All Grades</option>' + html;
            }
        }

        function updateDashboard() {
            const filter = document.getElementById('gradeFilter').value;
            const filtered = filter === 'all' ? appData.students : appData.students.filter(s => s.grade === filter);
            
            document.getElementById('totalStudents').textContent = filtered.length;
            
            const today = new Date().getDay();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayClasses = appData.timetable.filter(t => t.day === days[today]);
            document.getElementById('todayClasses').textContent = todayClasses.length;
            
            const pending = getPendingPayments().length;
            document.getElementById('pendingPayments').textContent = pending;
            
            document.getElementById('attendanceRate').textContent = getTodayAttendanceRate();
            
            const list = document.getElementById('todayClassesList');
            if (todayClasses.length === 0) {
                list.innerHTML = '<p style="color: #6B7280; font-size: 14px;">No classes today</p>';
            } else {
                list.innerHTML = todayClasses.map(c => `
                    <div style="padding: 12px; background: #EFF6FF; border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600;">Grade ${c.grade}</div>
                        <div style="font-size: 14px; color: #6B7280;">${c.time}</div>
                    </div>
                `).join('');
            }
        }

        function getPendingPayments() {
            const current = new Date();
            return appData.students.filter(student => {
                const payments = appData.payments.filter(p => p.studentId === student.id);
                if (payments.length === 0 && current.getDate() > 14) return true;
                if (payments.length > 0) {
                    const last = payments[payments.length - 1];
                    const payDate = new Date(last.date);
                    const months = (current.getFullYear() - payDate.getFullYear()) * 12 + (current.getMonth() - payDate.getMonth());
                    return months > 0 && current.getDate() > 14;
                }
                return false;
            });
        }

        function getTodayAttendanceRate() {
            const today = new Date().toISOString().split('T')[0];
            const att = appData.attendance[today] || {};
            const total = Object.keys(att).length;
            if (total === 0) return '0%';
            const present = Object.values(att).filter(s => s === 'present').length;
            return Math.round((present / total) * 100) + '%';
        }
        
        // ============================================
        // ADMIN PANEL FUNCTIONS
        // ============================================

        async function loadAllUsers() {
            console.log('üìä Starting loadAllUsers()...');
    
            // Check admin permissions
            if (!isAdmin) {
                console.error('‚ùå User is not an admin');
                alert('Access denied: You are not an admin!');
                return;
            }
    
            if (!adminPermissions.canViewAllUsers) {
                console.error('‚ùå No permission to view all users');
                alert('Access denied: You do not have permission to view all users!');
                return;
            }

            console.log('‚úÖ Admin permissions verified');
            console.log('üë§ Current User:', currentUser.email);
            console.log('üîë Admin Role:', adminRole);

            try {
                console.log('üîç Fetching users from Firebase...');
                const usersSnapshot = await database.ref('users').once('value');
        
                if (!usersSnapshot.exists()) {
                    console.warn('‚ö†Ô∏è No users found in database');
                    alert('No users found in the database.');
                    return;
                }
        
                console.log('‚úÖ Users data retrieved from Firebase');
        
                allUsersData = [];
                let userCount = 0;

                usersSnapshot.forEach((userSnapshot) => {
                    const userId = userSnapshot.key;
                    const userData = userSnapshot.val();
            
                    userCount++;
                    console.log(`Processing user ${userCount}:`, userId);
            
                    if (userData) {
                        // Try to find email in multiple possible locations
                        let email = 'No email found';
                
                        if (userData.profile && userData.profile.email) {
                            email = userData.profile.email;
                        } else if (userData.email) {
                            email = userData.email;
                        } else if (userData.data && userData.data.email) {
                            email = userData.data.email;
                        }
                
                        console.log('  üìß Email:', email);
                        console.log('  üìä Students:', (userData.data?.students || []).length);
                
                        const userInfo = {
                            userId: userId,
                            email: email,
                            createdAt: userData.profile?.createdAt || null,
                            studentsCount: (userData.data?.students || []).length,
                            paymentsCount: (userData.data?.payments || []).length,
                            subscription: userData.data?.subscription || {
                                plan: 'free_trial',
                                status: 'active'
                            },                           
                            lastSaved: userData.data?.lastSaved || null
                        };
                
                        allUsersData.push(userInfo);
                    }
                });

                console.log('‚úÖ Processed', allUsersData.length, 'users');
                console.log('üìä All users data:', allUsersData);

                // Update stats
                updateAdminStats();

                // Display users in table
                displayUsersTable();

                return allUsersData;

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                console.error('Error details:', error.message, error.stack);
                alert('Failed to load users: ' + error.message);
            }
        }

        function updateAdminStats() {
            // Total users
            const totalUsers = document.getElementById('adminTotalUsers');
            if (totalUsers) {
                totalUsers.textContent = allUsersData.length;
            }
    
            // Active subscriptions
            const activeSubscriptions = allUsersData.filter(u => 
                u.subscription.status === 'active' && 
                u.subscription.plan !== 'free_trial'
            ).length;
    
            const activeSubs = document.getElementById('adminActiveSubscriptions');
            if (activeSubs) {
                activeSubs.textContent = activeSubscriptions;
            }
    
            // Total students
            const totalStudents = allUsersData.reduce((sum, user) => sum + user.studentsCount, 0);
            const totalStudentsEl = document.getElementById('adminTotalStudents');
            if (totalStudentsEl) {
                totalStudentsEl.textContent = totalStudents;
            }
    
            // Total revenue (example - you'd calculate from actual payment data)
            const totalRevenue = activeSubscriptions * 1000; // Simplified
            const totalRevenueEl = document.getElementById('adminTotalRevenue');
            if (totalRevenueEl) {
                totalRevenueEl.textContent = 'LKR ' + totalRevenue.toLocaleString();
            }
        }

        function displayUsersTable() {
            console.log('üìã Displaying users table...');
    
            const tbody = document.getElementById('adminUsersTableBody');
    
            if (!tbody) {
                console.error('‚ùå Table body not found: adminUsersTableBody');
                return;
            }

            if (!allUsersData || allUsersData.length === 0) {
                console.warn('‚ö†Ô∏è No users to display');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            No users found in database
                        </td>
                    </tr>
                `;
                return;
            }

            console.log('‚úÖ Displaying', allUsersData.length, 'users');

            tbody.innerHTML = '';

            allUsersData.forEach((user, index) => {
                console.log(`Adding user ${index + 1} to table:`, user.email);
        
                const row = document.createElement('tr');

                const statusClass = user.subscription.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = user.subscription.status === 'active' ? '‚úÖ Active' : '‚ùå Inactive';

                row.innerHTML = `
                    <td><strong>${user.email}</strong></td>
                    <td><code style="font-size: 11px;">${user.userId.substring(0, 20)}...</code></td>
                    <td><strong>${user.studentsCount}</strong></td>
                    <td><span class="badge badge-${user.subscription.plan}">${user.subscription.plan}</span></td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-small btn-primary" onclick="viewUserDetails('${user.userId}')">üëÅÔ∏è View</button>
                        ${adminPermissions.canManageSubscriptions ? `
                        <button class="btn-small btn-success" onclick="manageUserSubscription('${user.userId}')">üí≥ Manage</button>
                        ` : ''}
                        ${adminPermissions.canDeleteUsers ? `
                        <button class="btn-small btn-danger" onclick="deleteUser('${user.userId}')">üóëÔ∏è Delete</button>
                        ` : ''}
                    </td>
                `;

                tbody.appendChild(row);
            });
    
            console.log('‚úÖ Table displayed successfully');
        }

        async function viewUserDetails(userId) {
            if (!isAdmin || !adminPermissions.canViewAllUsers) {
                alert('Access denied!');
                return;
            }
    
            try {
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
        
                if (!userData) {
                    alert('User not found!');
                    return;
                }
        
                // Show modal with user details
                showUserDetailsModal(userId, userData);
        
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Failed to load user details');
            }
        }

        function showUserDetailsModal(userId, userData) {
            const modal = `
                <div class="modal-overlay" id="userDetailsModal" onclick="closeModal('userDetailsModal')">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>User Details</h2>
                            <button class="modal-close" onclick="closeModal('userDetailsModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <h3>Profile Information</h3>
                            <p><strong>Email:</strong> ${userData.profile?.email || 'N/A'}</p>
                            <p><strong>User ID:</strong> <code>${userId}</code></p>
                            <p><strong>Created:</strong> ${userData.profile?.createdAt ? new Date(userData.profile.createdAt).toLocaleString() : 'N/A'}</p>
                    
                            <h3>Subscription</h3>
                            <p><strong>Plan:</strong> ${userData.data?.subscription?.plan || 'free_trial'}</p>
                            <p><strong>Status:</strong> ${userData.data?.subscription?.status || 'active'}</p>
                            <p><strong>Max Students:</strong> ${userData.data?.subscription?.maxStudents || 10}</p>
                    
                            <h3>Data Statistics</h3>
                            <p><strong>Students:</strong> ${(userData.data?.students || []).length}</p>
                            <p><strong>Timetable Entries:</strong> ${(userData.data?.timetable || []).length}</p>
                            <p><strong>Payments:</strong> ${(userData.data?.payments || []).length}</p>
                            <p><strong>Last Saved:</strong> ${userData.data?.lastSaved ? new Date(userData.data.lastSaved).toLocaleString() : 'Never'}</p>
                    
                            ${adminPermissions.canEditAllUsers ? `
                            <h3>Actions</h3>
                            <button class="btn btn-primary" onclick="exportUserData('${userId}')">üì• Export Data</button>
                            <button class="btn btn-success" onclick="grantUnlimitedAccess('${userId}')">‚≠ê Grant Unlimited</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
    
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        async function manageUserSubscription(userId) {
            if (!isAdmin || !adminPermissions.canManageSubscriptions) {
                alert('Access denied!');
                return;
            }
    
            const user = allUsersData.find(u => u.userId === userId);
            if (!user) return;
    
            const modal = `
                <div class="modal-overlay" id="subscriptionModal" onclick="closeModal('subscriptionModal')">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Manage Subscription</h2>
                            <button class="modal-close" onclick="closeModal('subscriptionModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <p><strong>User:</strong> ${user.email}</p>
                            <p><strong>Current Plan:</strong> ${user.subscription.plan}</p>
                    
                            <div class="form-group">
                                <label>New Plan:</label>
                                <select id="newSubscriptionPlan">
                                    <option value="free_trial">Free Trial (10 students)</option>
                                    <option value="monthly">Monthly (Unlimited)</option>
                                    <option value="annual">Annual (Unlimited)</option>
                                    <option value="lifetime">Lifetime (Unlimited)</option>
                                </select>
                            </div>
                    
                            <div class="form-group">
                                <label>Status:</label>
                                <select id="newSubscriptionStatus">
                                    <option value="active">Active</option>
                                    <option value="expired">Expired</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                    
                            <button class="btn btn-primary" onclick="updateSubscription('${userId}')">üíæ Update Subscription</button>
                            <button class="btn btn-success" onclick="grantUnlimitedAccess('${userId}')">‚≠ê Grant Unlimited</button>
                        </div>
                    </div>
                </div>
            `;
    
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function updateSubscription(userId) {
            const plan = document.getElementById('newSubscriptionPlan').value;
            const status = document.getElementById('newSubscriptionStatus').value;
    
            const maxStudents = plan === 'free_trial' ? 10 : Infinity;
    
            const newSubscription = {
                plan: plan,
                status: status,
                maxStudents: maxStudents,
                startDate: new Date().toISOString(),
                endDate: plan === 'lifetime' ? null : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
                features: {
                    students: true,
                    attendance: true,
                    payments: true,
                    reports: true,
                    backup: true,
                    export: true
                },
                updatedBy: currentUserId,
                updatedAt: new Date().toISOString()
            };
    
            try {
                await database.ref('users/' + userId + '/data/subscription').set(newSubscription);
        
                // Log admin action
                await logAdminAction('update_subscription', userId, { newPlan: plan, newStatus: status });
        
                alert('‚úÖ Subscription updated successfully!');
                closeModal('subscriptionModal');
                loadAllUsers(); // Refresh
        
            } catch (error) {
                console.error('Error updating subscription:', error);
                alert('Failed to update subscription');
            }
        }

        async function grantUnlimitedAccess(userId) {
            if (!confirm('Grant unlimited lifetime access to this user?')) {
                return;
            }
    
            const unlimitedSubscription = {
                plan: 'lifetime',
                status: 'active',
                maxStudents: Infinity,
                startDate: new Date().toISOString(),
                endDate: null,
                features: {
                    students: true,
                    attendance: true,
                    payments: true,
                    reports: true,
                    backup: true,
                    export: true,
                    priority_support: true
                },
                grantedBy: currentUserId,
                grantedAt: new Date().toISOString()
            };
    
            try {
                await database.ref('users/' + userId + '/data/subscription').set(unlimitedSubscription);
        
                await logAdminAction('grant_unlimited', userId, unlimitedSubscription);
        
                alert('‚úÖ Unlimited access granted!');
                closeModal('userDetailsModal');
                closeModal('subscriptionModal');
                loadAllUsers();
        
            } catch (error) {
                console.error('Error granting access:', error);
                alert('Failed to grant access');
            }
        }

        async function logAdminAction(action, targetUserId, details) {
            try {
                const logEntry = {
                    adminId: currentUserId,
                    adminEmail: currentUser.email,
                    action: action,
                    targetUserId: targetUserId,
                    details: details,
                    timestamp: new Date().toISOString()
                };
        
                await database.ref('admin-logs').push(logEntry);
                console.log('üìù Admin action logged:', action);
        
            } catch (error) {
                console.error('Failed to log admin action:', error);
            }
        }

        // ============================================
        // ADMIN MANAGEMENT FUNCTIONS
        // ============================================

        async function loadAdminList() {
            if (!isAdmin || adminRole !== 'super_admin') {
                return;
            }
    
            try {
                const adminsSnapshot = await database.ref('admin-users').once('value');
                const adminsList = document.getElementById('adminsList');
        
                if (!adminsList) return;
        
                adminsList.innerHTML = '<h3>Current Admins</h3>';
        
                adminsSnapshot.forEach((adminSnapshot) => {
                    const adminData = adminSnapshot.val();
                    const adminId = adminSnapshot.key;
            
                    const adminCard = document.createElement('div');
                    adminCard.className = 'admin-card';
                    adminCard.innerHTML = `
                        <div class="admin-info">
                            <strong>${adminData.email}</strong>
                            <span class="badge badge-${adminData.role}">${adminData.role}</span>
                        </div>
                        <div class="admin-actions">
                            ${adminId !== currentUserId ? `
                                <button class="btn-small btn-danger" onclick="removeAdmin('${adminId}', '${adminData.email}')">Remove</button>
                            ` : '<span class="text-muted">(You)</span>'}
                        </div>
                    `;
            
                    adminsList.appendChild(adminCard);
                });
        
            } catch (error) {
                console.error('Error loading admin list:', error);
            }
        }

        async function addNewAdmin() {
            if (!isAdmin || adminRole !== 'super_admin') {
                alert('‚ùå Only super admins can add new admins');
                return;
            }
    
            const email = document.getElementById('newAdminEmail').value.trim();
            const role = document.getElementById('newAdminRole').value;
    
            if (!email) {
                alert('Please enter an email address');
                return;
            }
    
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
    
            try {
                // Step 1: Find user ID from email
                const usersSnapshot = await database.ref('users').once('value');
                let targetUserId = null;
             
                usersSnapshot.forEach((userSnapshot) => {                   
                    const userData = userSnapshot.val();
                    if (userData.profile && userData.profile.email === email) {
                        targetUserId = userSnapshot.key;
                    }
                });
        
                if (!targetUserId) {
                    alert('‚ö†Ô∏è User not found!\n\nThis email address must create an account first before being made an admin.');
                    return;
                }
        
                // Step 2: Add to admins list
                const emailKey = email.replace(/\./g, '_');
                await database.ref('admins/' + emailKey).set(true);
        
                // Step 3: Create admin profile
                const permissions = getPermissionsForRole(role);
        
                await database.ref('admin-users/' + targetUserId).set({
                    email: email,
                    role: role,
                    permissions: permissions,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUserId
                });
        
                await logAdminAction('add_admin', targetUserId, { email, role });
        
                alert('‚úÖ Admin added successfully!\n\n' + email + ' now has ' + role + ' access.');
        
                document.getElementById('newAdminEmail').value = '';
                loadAdminList();
        
            } catch (error) {
                console.error('Error adding admin:', error);
                alert('Failed to add admin: ' + error.message);
            }
        }

        function getPermissionsForRole(role) {
            const permissionSets = {
                super_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: true,
                    canManageSubscriptions: true,
                    canViewAnalytics: true,
                    canAddAdmins: true,
                    canDeleteUsers: true
                },
                support_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: false,
                    canManageSubscriptions: true,
                    canViewAnalytics: false,
                    canAddAdmins: false,
                    canDeleteUsers: false
                },
                analytics_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: false,
                    canManageSubscriptions: false,
                    canViewAnalytics: true,
                    canAddAdmins: false,
                    canDeleteUsers: false
                }
            };
    
            return permissionSets[role] || permissionSets.support_admin;
        }

        async function removeAdmin(adminId, adminEmail) {
            if (!isAdmin || adminRole !== 'super_admin') {
                alert('Access denied!');
                return;
            }
    
            if (!confirm('Remove admin access for ' + adminEmail + '?')) {
                return;
            }
    
            try {
                const emailKey = adminEmail.replace(/\./g, '_');
        
                await database.ref('admins/' + emailKey).remove();
                await database.ref('admin-users/' + adminId).remove();
        
                await logAdminAction('remove_admin', adminId, { email: adminEmail });
        
                alert('‚úÖ Admin removed successfully!');
                loadAdminList();
        
            } catch (error) {
                console.error('Error removing admin:', error);
                alert('Failed to remove admin');
            }
        }

        function filterAdminUsers() {
            const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminUsersTableBody tr');
    
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function showAdminTab(tabName) {  
            console.log('üîÑ Switching to admin tab:', tabName);
        
            // Hide all tab contents    
            document.querySelectorAll('.admin-tab-content').forEach(tab => {        
                tab.classList.remove('active');       
                tab.style.display = 'none';    
            });
    
            // Remove active styling from all buttons   
            document.querySelectorAll('.admin-tab').forEach(btn => {                
                btn.classList.remove('active');        
                btn.style.background = '#f3f4f6';        
                btn.style.color = '#374151';    
            });
   
            // Show the selected tab    
            const selectedTab = document.getElementById('admin-' + tabName + '-tab');   
            if (selectedTab) {       
                selectedTab.classList.add('active');        
                selectedTab.style.display = 'block';       
                console.log('‚úÖ Tab displayed:', tabName);    
            } else {        
                console.error('‚ùå Tab not found:', 'admin-' + tabName + '-tab');    
            }
    
            // Update button styling    
            if (event && event.target) {        
                event.target.classList.add('active');        
                event.target.style.background = '#2563EB';        
                event.target.style.color = 'white';   
            }
    
            // AUTO-LOAD DATA FOR EACH TAB    
            console.log('üìä Loading data for tab:', tabName);
        
            if (tabName === 'users') {        
                // Load users automatically       
                setTimeout(() => {            
                    console.log('‚è≥ Calling loadAllUsers()...');            
                    loadAllUsers();                        
                }, 100);
           
            } else if (tabName === 'subscriptions') {        
                setTimeout(() => loadSubscriptionsTab(), 100);
            
            } else if (tabName === 'analytics') {        
                setTimeout(() => loadAdminAnalytics(), 100);
            
            } else if (tabName === 'settings') {        
                setTimeout(() => loadAdminSettingsTab(), 100);   
            }
        }

        // ============================================
        // ANALYTICS TAB FUNCTIONS
        // ============================================

        function loadAdminAnalytics() {
            if (!isAdmin || !adminPermissions.canViewAnalytics) {
                document.getElementById('adminAnalytics').innerHTML = '<p style="color: #ef4444;">‚ùå You do not have permission to view analytics.</p>';
                return;
            }
    
            console.log('üìä Loading analytics...');
    
            const analyticsContainer = document.getElementById('adminAnalytics');
    
            if (!allUsersData || allUsersData.length === 0) {
                analyticsContainer.innerHTML = '<p style="color: #6b7280;">Please load users first from the "All Users" tab.</p>';
                return;
            }
    
            // Calculate analytics
            const analytics = calculateAnalytics();
    
            // Display analytics
            analyticsContainer.innerHTML = `
                <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <h4 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px;">Total Users</h4>
                        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #2563EB;">${analytics.totalUsers}</p>
                    </div>
            
                    <div class="stat-card">
                        <h4 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px;">Free Trial Users</h4>
                        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #6b7280;">${analytics.freeTrialUsers}</p>
                    </div>
            
                    <div class="stat-card">
                        <h4 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px;">Paid Users</h4>
                        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #10b981;">${analytics.paidUsers}</p>
                    </div>
            
                    <div class="stat-card">
                        <h4 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px;">Total Students</h4>
                        <p style="font-size: 32px; font-weight: 700; margin: 0; color: #8b5cf6;">${analytics.totalStudents}</p>
                    </div>
                </div>
        
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">User Growth</h3>
                    <div id="userGrowthChart" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px;">
                        <p style="color: #6b7280;">Chart visualization coming soon...</p>
                    </div>
                </div>
        
                <div class="card">
                    <h3 style="margin-top: 0;">Subscription Breakdown</h3>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Plan</th>
                                <th>Users</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Free Trial</td>
                                <td>${analytics.freeTrialUsers}</td>
                                <td>${analytics.freeTrialPercentage}%</td>
                            </tr>
                            <tr>
                                <td>Monthly</td>
                                <td>${analytics.monthlyUsers}</td>
                                <td>${analytics.monthlyPercentage}%</td>
                            </tr>
                            <tr>
                                <td>Annual</td>
                                <td>${analytics.annualUsers}</td>
                                <td>${analytics.annualPercentage}%</td>
                            </tr>
                            <tr>
                                <td>Lifetime</td>
                                <td>${analytics.lifetimeUsers}</td>
                                <td>${analytics.lifetimePercentage}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-top: 0;">Top Users by Students</h3>
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Students</th>
                                <th>Plan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analytics.topUsers.map(user => `
                                <tr>
                                    <td>${user.email}</td>
                                    <td>${user.studentsCount}</td>
                                    <td><span class="badge badge-${user.subscription.plan}">${user.subscription.plan}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function calculateAnalytics() {
            const totalUsers = allUsersData.length;
    
            const freeTrialUsers = allUsersData.filter(u => u.subscription.plan === 'free_trial').length;
            const monthlyUsers = allUsersData.filter(u => u.subscription.plan === 'monthly').length;
            const annualUsers = allUsersData.filter(u => u.subscription.plan === 'annual').length;
            const lifetimeUsers = allUsersData.filter(u => u.subscription.plan === 'lifetime').length;
            const paidUsers = monthlyUsers + annualUsers + lifetimeUsers;
    
            const totalStudents = allUsersData.reduce((sum, user) => sum + user.studentsCount, 0);
    
            const topUsers = [...allUsersData]
                .sort((a, b) => b.studentsCount - a.studentsCount)
                .slice(0, 10);
    
            return {
                totalUsers,
                freeTrialUsers,
                monthlyUsers,
                annualUsers,
                lifetimeUsers,
                paidUsers,
                totalStudents,
                freeTrialPercentage: totalUsers ? Math.round((freeTrialUsers / totalUsers) * 100) : 0,
                monthlyPercentage: totalUsers ? Math.round((monthlyUsers / totalUsers) * 100) : 0,
                annualPercentage: totalUsers ? Math.round((annualUsers / totalUsers) * 100) : 0,
                lifetimePercentage: totalUsers ? Math.round((lifetimeUsers / totalUsers) * 100) : 0,
                topUsers
            };
        }

        // ============================================
        // ADMIN SETTINGS TAB FUNCTIONS
        // ============================================

        function loadAdminSettingsTab() {
            if (adminRole !== 'super_admin') {
                document.getElementById('adminsList').innerHTML = '<p style="color: #ef4444;">‚ùå Only super admins can manage admin settings.</p>';
                return;
            }
    
            console.log('‚öôÔ∏è Loading admin settings...');
    
            loadAdminList();
        }

        async function loadAdminList() {
            if (adminRole !== 'super_admin') {
                return;
            }
    
            const adminsList = document.getElementById('adminsList');
    
            if (!adminsList) {
                console.error('adminsList element not found');
                return;
            }
    
            try {
                // Load admin list from /admins/
                const adminsSnapshot = await database.ref('admins').once('value');
                const adminsData = adminsSnapshot.val();
        
                if (!adminsData) {
                    adminsList.innerHTML = `
                        <h3>Current Admins</h3>
                        <p style="color: #6b7280;">No admins found in database.</p>
                    `;
                    return;
                }
        
                // Convert to array
                const adminsArray = Object.keys(adminsData).map(key => ({
                    emailKey: key,
                    email: key.replace(/_/g, '.'),
                    isActive: adminsData[key]
                }));
        
                // Load admin details
                const adminDetailsSnapshot = await database.ref('admin-users').once('value');
                const adminDetails = adminDetailsSnapshot.val() || {};
        
                adminsList.innerHTML = `
                    <h3 style="margin-bottom: 20px;">Current Admins (${adminsArray.length})</h3>
                    <div style="display: grid; gap: 15px;">
                        ${adminsArray.map(admin => {
                            // Find admin details
                            let adminInfo = null;
                            let adminId = null;
                    
                            Object.keys(adminDetails).forEach(uid => {
                                if (adminDetails[uid].email === admin.email) {
                                    adminInfo = adminDetails[uid];
                                    adminId = uid;
                                }
                            });
                    
                            const isCurrentUser = admin.email === currentUser.email;
                    
                            return `
                                <div class="admin-card" style="background: ${isCurrentUser ? '#f0f9ff' : 'white'}; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="admin-info" style="display: flex; gap: 12px; align-items: center; flex: 1;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                            ${admin.email.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: #111827;">
                                                ${admin.email}
                                                ${isCurrentUser ? '<span style="color: #3b82f6; font-size: 12px; margin-left: 8px;">(You)</span>' : ''}
                                            </div>
                                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                                ${adminInfo ? `
                                                    <span class="badge badge-${adminInfo.role}" style="margin-right: 8px;">${adminInfo.role}</span>
                                                    <span>Added: ${new Date(adminInfo.createdAt).toLocaleDateString()}</span>
                                                ` : '<span style="color: #f59e0b;">‚ö†Ô∏è No profile data</span>'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="admin-actions">
                                        ${!isCurrentUser ? `
                                            <button class="btn-small btn-danger" onclick="removeAdmin('${adminId || 'unknown'}', '${admin.email}', '${admin.emailKey}')" style="padding: 8px 16px;">
                                                üóëÔ∏è Remove
                                            </button>
                                        ` : `
                                            <span style="color: #6b7280; font-size: 12px;">Current user</span>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
        
            } catch (error) {
                console.error('Error loading admin list:', error);
                adminsList.innerHTML = `
                    <h3>Current Admins</h3>
                    <p style="color: #ef4444;">Error loading admins: ${error.message}</p>
                `;
            }
        }

        async function addNewAdmin() {
            if (adminRole !== 'super_admin') {
                alert('‚ùå Only super admins can add new admins');
                return;
            }
    
            const email = document.getElementById('newAdminEmail').value.trim();
            const role = document.getElementById('newAdminRole').value;
    
            if (!email) {
                alert('‚ö†Ô∏è Please enter an email address');
                return;
            }
    
            if (!email.includes('@')) {
                alert('‚ö†Ô∏è Please enter a valid email address');
                return;
            }
    
            // Show loading state
            const addButton = event.target;
            const originalText = addButton.textContent;
            addButton.disabled = true;
            addButton.textContent = '‚è≥ Adding...';
    
            try {
                // Step 1: Find user ID from email by checking all users
                console.log('üîç Looking for user with email:', email);
        
                let targetUserId = null;
        
                // Load all users to find the matching email
                const usersSnapshot = await database.ref('users').once('value');
                const usersData = usersSnapshot.val();
        
                if (usersData) {
                    Object.keys(usersData).forEach(userId => {
                        const userData = usersData[userId];
                        if (userData.profile && userData.profile.email === email) {
                    targetUserId = userId;
                        }
                    });
                }
        
                if (!targetUserId) {
                    alert('‚ö†Ô∏è User Not Found!\n\nThe email "' + email + '" must create an account first before being made an admin.\n\nAsk them to:\n1. Go to the login page\n2. Sign up with this email\n3. Then you can add them as admin');
                    addButton.disabled = false;
                    addButton.textContent = originalText;
                    return;
                }
        
                console.log('‚úÖ Found user ID:', targetUserId);
        
                // Step 2: Add to admins list
                const emailKey = email.replace(/\./g, '_').replace(/@/g, '@');
                await database.ref('admins/' + emailKey).set(true);
                console.log('‚úÖ Added to /admins/');
        
                // Step 3: Create admin profile
                const permissions = getPermissionsForRole(role);
        
                await database.ref('admin-users/' + targetUserId).set({
                    email: email,
                    role: role,
                    permissions: permissions,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUserId,
                    createdByEmail: currentUser.email
                });
               console.log('‚úÖ Created admin profile');
        
                // Step 4: Log the action
                await logAdminAction('add_admin', targetUserId, { 
                    email: email, 
                    role: role,
                    permissions: permissions 
                });
        
                alert('‚úÖ Admin Added Successfully!\n\n' + email + ' now has ' + role + ' access.\n\nThey will see admin features on their next login.');
        
                // Clear input
                document.getElementById('newAdminEmail').value = '';
                document.getElementById('newAdminRole').value = 'super_admin';
        
                // Reload admin list
                await loadAdminList();
        
            } catch (error) {
                console.error('‚ùå Error adding admin:', error);
                alert('‚ùå Failed to add admin!\n\nError: ' + error.message + '\n\nPlease try again or check the console for details.');
            } finally {
                addButton.disabled = false;
                addButton.textContent = originalText;
            }
        }

        async function removeAdmin(adminId, adminEmail, emailKey) {
            if (adminRole !== 'super_admin') {
                alert('‚ùå Only super admins can remove admins');
                return;
            }
    
            if (adminEmail === currentUser.email) {
                alert('‚ö†Ô∏è You cannot remove yourself as an admin!');
                return;
            }
    
            if (!confirm('üóëÔ∏è Remove Admin Access?\n\nRemove admin access for:\n' + adminEmail + '\n\nThey will lose all admin privileges immediately.\n\nContinue?')) {
                return;
            }
    
            try {
                // Remove from admins list
                await database.ref('admins/' + emailKey).remove();
                console.log('‚úÖ Removed from /admins/');
        
                // Remove admin profile (if exists)
                if (adminId && adminId !== 'unknown') {
                    await database.ref('admin-users/' + adminId).remove();
                    console.log('‚úÖ Removed admin profile');
                }
        
                // Log the action
                await logAdminAction('remove_admin', adminId || 'unknown', { 
                    email: adminEmail,
                    emailKey: emailKey
                });
        
                alert('‚úÖ Admin Removed!\n\n' + adminEmail + ' no longer has admin access.');
        
                // Reload admin list
                await loadAdminList();
        
            } catch (error) {
                console.error('‚ùå Error removing admin:', error);
                alert('‚ùå Failed to remove admin!\n\nError: ' + error.message);
            }
        }

        function getPermissionsForRole(role) {
            const permissionSets = {
                super_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: true,
                    canManageSubscriptions: true,
                    canViewAnalytics: true,
                    canAddAdmins: true,
                    canDeleteUsers: true
                },
                support_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: false,
                    canManageSubscriptions: true,
                    canViewAnalytics: false,
                    canAddAdmins: false,
                    canDeleteUsers: false
                },
                analytics_admin: {
                    canViewAllUsers: true,
                    canEditAllUsers: false,
                    canManageSubscriptions: false,
                    canViewAnalytics: true,
                    canAddAdmins: false,
                    canDeleteUsers: false
                }
            };
    
            return permissionSets[role] || permissionSets.support_admin;
        }
                
       
                   
        // Initialize app               
        init();
    </script>
    <script>  
        document.getElementById("year").textContent = new Date().getFullYear();
    </script>
</body>
</html>














