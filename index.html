<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Class Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
<div id="loader">
  <div class="loader-content">
    <img src="assets/logo.png" alt="Class Manager Logo" class="logo-img">
    <div class="dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <p>Preparing your workspace</p>
  </div>
</div>

<!-- Auth Container -->
<div class="auth-container">
  <div class="auth-header">
    <h1>Class Manager</h1>
    <p>Manage your classes efficiently</p>
  </div>

  <!-- Tab Switcher -->
  <div class="tab-switcher">
    <button class="tab-btn active" onclick="switchTab('login')">Login</button>
    <button class="tab-btn" onclick="switchTab('signup')">Sign Up</button>
  </div>

  <!-- Alert Message -->
  <div id="alert" class="alert"></div>

  <!-- Login Form -->
  <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
    <div class="input-group">
      <label for="loginEmail">Email address</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" required>
    </div>

    <div class="input-group">
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" placeholder="Enter your password" required>
      <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
    </div>

    <div class="forgot-password">
      <a href="#" onclick="alert('Password reset feature coming soon!'); return false;">Forgot password?</a>
    </div>

    <button type="submit" class="btn btn-primary" id="loginBtn">
      <span>Login to your account</span>
    </button>

    <div class="divider"><span>OR</span></div>

    <button type="button" class="btn btn-google" onclick="googleLogin()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
      <span>Continue with Google</span>
    </button>
  </form>

  <!-- Sign Up Form -->
  <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
    <div class="input-group">
      <label for="signupEmail">Email address</label>
      <input type="email" id="signupEmail" placeholder="you@example.com" required>
    </div>

    <div class="input-group">
      <label for="signupPassword">Password</label>
      <input type="password" id="signupPassword" placeholder="At least 6 characters" required minlength="6">
      <span class="password-toggle" onclick="togglePassword('signupPassword')">üëÅÔ∏è</span>
    </div>

    <div class="input-group">
      <label for="confirmPassword">Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Re-enter your password" required minlength="6">
      <span class="password-toggle" onclick="togglePassword('confirmPassword')">üëÅÔ∏è</span>
    </div>

    <button type="submit" class="btn btn-primary" id="signupBtn">
      <span>Create account</span>
    </button>

    <div class="divider"><span>OR</span></div>

    <button type="button" class="btn btn-google" onclick="googleLogin()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
      <span>Sign up with Google</span>
    </button>
  </form>
</div>
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {    
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    GoogleAuthProvider, 
    signInWithPopup,  // ‚Üê Using POPUP instead of redirect
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { 
    getDatabase, 
    ref, 
    set 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

 // ============================================
// FIXED GOOGLE LOGIN - PROPER INITIALIZATION
// Replace the entire Google login section in index.html
// ============================================

// ============================================
// STEP 1: FIREBASE INITIALIZATION
// ============================================

console.log('üîµ SCRIPT STARTED');

const firebaseConfig = {
    apiKey: "AIzaSyD4z857J2ipSxqK8pN4tEWqU-jeK_mwA2I",
    authDomain: "class-manager-383ad.firebaseapp.com",
    databaseURL: "https://class-manager-383ad-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "class-manager-383ad",
    storageBucket: "class-manager-383ad.firebasestorage.app",
    messagingSenderId: "1085651561679",
    appId: "1:1085651561679:web:82ca82d59d6ff2ec671bba"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

console.log('‚úÖ Firebase initialized');

// ============================================
// STEP 2: CHECK FOR REDIRECT RESULT
// (Must be AFTER auth is initialized)
// ============================================

auth.getRedirectResult()
    .then(async (result) => {
        if (result.user) {
            console.log('‚úÖ Google login successful (redirect):', result.user.email);
            
            try {
                // Save user email to Firebase
                await database.ref('users/' + result.user.uid + '/profile').set({
                    email: result.user.email,
                    displayName: result.user.displayName || '',
                    photoURL: result.user.photoURL || '',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                
                console.log('‚úÖ User profile saved');
            } catch (error) {
                console.error('‚ùå Error saving profile:', error);
            }
            
            // Redirect handled by onAuthStateChanged
        }
    })
    .catch((error) => {
        console.error('‚ùå Redirect result error:', error);
        
        // Only show error if it's not a user cancellation
        if (error.code !== 'auth/popup-closed-by-user' && 
            error.code !== 'auth/cancelled-popup-request') {
            alert('Login error: ' + error.message);
        }
    });

// ============================================
// STEP 3: AUTHENTICATION STATE LISTENER
// ============================================

auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log('‚úÖ User logged in:', user.email);
        
        try {
            // Save/update user profile
            await database.ref('users/' + user.uid + '/profile').set({
                email: user.email,
                displayName: user.displayName || '',
                photoURL: user.photoURL || '',
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            });
            
            console.log('‚úÖ User profile updated');
        } catch (error) {
            console.error('‚ùå Error saving profile:', error);
        }
        
        // Redirect to app
        console.log('‚û°Ô∏è Redirecting to app.html...');
        window.location.href = 'app.html';
        
    } else {
        console.log('‚ÑπÔ∏è No user authenticated');
    }
});

// ============================================
// STEP 4: GOOGLE LOGIN FUNCTION
// ============================================

async function googleLogin() {
    console.log('üîµ GOOGLE LOGIN CLICKED');
    
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // Add required scopes
        provider.addScope('email');
        provider.addScope('profile');
        
        console.log('  - Trying popup method...');
        
        try {
            // Try popup first (preferred method)
            const result = await auth.signInWithPopup(provider);
            
            if (result.user) {
                console.log('‚úÖ Google login successful (popup):', result.user.email);
                
                // Save user email to Firebase
                await database.ref('users/' + result.user.uid + '/profile').set({
                    email: result.user.email,
                    displayName: result.user.displayName || '',
                    photoURL: result.user.photoURL || '',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                
                console.log('‚úÖ User profile saved');
                
                // onAuthStateChanged will handle redirect
            }
            
        } catch (popupError) {
            console.warn('‚ö†Ô∏è Popup method failed:', popupError.code);
            
            // If popup was blocked or closed, fallback to redirect
            if (popupError.code === 'auth/popup-blocked' || 
                popupError.code === 'auth/popup-closed-by-user' ||
                popupError.code === 'auth/cancelled-popup-request') {
                
                console.log('  - Falling back to redirect method...');
                alert('Popup blocked. Redirecting to Google login...');
                
                await auth.signInWithRedirect(provider);
                // User will be redirected back after login
                
            } else {
                // Other errors - throw them
                throw popupError;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Google login error:', error);
        console.error('  - Code:', error.code);
        console.error('  - Message:', error.message);
        
        // User-friendly error messages
        let errorMessage = 'Google login failed. ';
        
        if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = 'Login cancelled. Please try again.';
        } else if (error.code === 'auth/popup-blocked') {
            errorMessage = 'Popup was blocked by your browser. Please allow popups and try again.';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Network error. Please check your internet connection.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
    }
}

// Make function globally available
window.googleLogin = googleLogin;

// ============================================
// STEP 5: EMAIL/PASSWORD LOGIN FUNCTION
// ============================================

async function emailLogin() {
    console.log('üìß EMAIL LOGIN CLICKED');
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!email || !password) {
        alert('Please enter email and password');
        return;
    }
    
    try {
        const result = await auth.signInWithEmailAndPassword(email, password);
        
        console.log('‚úÖ Email login successful:', result.user.email);
        
        // Save/update user profile
        await database.ref('users/' + result.user.uid + '/profile').set({
            email: result.user.email,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
        });
        
        // onAuthStateChanged will handle redirect
        
    } catch (error) {
        console.error('‚ùå Email login error:', error);
        
        let errorMessage = 'Login failed. ';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email.';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Incorrect password.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address.';
        } else if (error.code === 'auth/user-disabled') {
            errorMessage = 'This account has been disabled.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
    }
}

window.emailLogin = emailLogin;

// ============================================
// STEP 6: EMAIL/PASSWORD SIGNUP FUNCTION
// ============================================

async function emailSignup() {
    console.log('üìß EMAIL SIGNUP CLICKED');
    
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();
    
    if (!email || !password || !confirmPassword) {
        alert('Please fill in all fields');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    try {
        const result = await auth.createUserWithEmailAndPassword(email, password);
        
        console.log('‚úÖ Signup successful:', result.user.email);
        
        // Save user profile
        await database.ref('users/' + result.user.uid + '/profile').set({
            email: result.user.email,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
        });
        
        console.log('‚úÖ User profile created');
        
        alert('Account created successfully!');
        
        // onAuthStateChanged will handle redirect
        
    } catch (error) {
        console.error('‚ùå Signup error:', error);
        
        let errorMessage = 'Signup failed. ';
        
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email is already registered. Please login instead.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak. Please use a stronger password.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
    }
}

window.emailSignup = emailSignup;

console.log('‚úÖ All login functions loaded');
</script>
</body>
</html>



















