<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Class Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
<div id="loader">
  <div class="loader-content">
    <img src="assets/logo.png" alt="Class Manager Logo" class="logo-img">
    <div class="dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <p>Preparing your workspace</p>
  </div>
</div>

<!-- Auth Container -->
<div class="auth-container">
  <div class="auth-header">
    <h1>Class Manager</h1>
    <p>Manage your classes efficiently</p>
  </div>

  <!-- Tab Switcher -->
  <div class="tab-switcher">
    <button class="tab-btn active" onclick="switchTab('login')">Login</button>
    <button class="tab-btn" onclick="switchTab('signup')">Sign Up</button>
  </div>

  <!-- Alert Message -->
  <div id="alert" class="alert"></div>

  <!-- Login Form -->
  <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
    <div class="input-group">
      <label for="loginEmail">Email address</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" required>
    </div>

    <div class="input-group">
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" placeholder="Enter your password" required>
      <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
    </div>

    <div class="forgot-password">
      <a href="#" onclick="alert('Password reset feature coming soon!'); return false;">Forgot password?</a>
    </div>

    <button type="submit" class="btn btn-primary" id="loginBtn">
      <span>Login to your account</span>
    </button>

    <div class="divider"><span>OR</span></div>

    <button type="button" class="btn btn-google" onclick="googleLogin()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
      <span>Continue with Google</span>
    </button>
  </form>

  <!-- Sign Up Form -->
  <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
    <div class="input-group">
      <label for="signupEmail">Email address</label>
      <input type="email" id="signupEmail" placeholder="you@example.com" required>
    </div>

    <div class="input-group">
      <label for="signupPassword">Password</label>
      <input type="password" id="signupPassword" placeholder="At least 6 characters" required minlength="6">
      <span class="password-toggle" onclick="togglePassword('signupPassword')">üëÅÔ∏è</span>
    </div>

    <div class="input-group">
      <label for="confirmPassword">Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Re-enter your password" required minlength="6">
      <span class="password-toggle" onclick="togglePassword('confirmPassword')">üëÅÔ∏è</span>
    </div>

    <button type="submit" class="btn btn-primary" id="signupBtn">
      <span>Create account</span>
    </button>

    <div class="divider"><span>OR</span></div>

    <button type="button" class="btn btn-google" onclick="googleLogin()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
      <span>Sign up with Google</span>
    </button>
  </form>
</div>
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {    
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    GoogleAuthProvider, 
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { 
    getDatabase, 
    ref, 
    set 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  console.log("üîµ SCRIPT STARTED");

  const firebaseConfig = {
    apiKey: "AIzaSyD4z857J2ipSxqK8pN4tEWqU-jeK_mwA2I",
    authDomain: "class-manager-383ad.firebaseapp.com",
    databaseURL: "https://class-manager-383ad-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "class-manager-383ad",
    storageBucket: "class-manager-383ad.firebasestorage.app",
    messagingSenderId: "1085651561679",
    appId: "1:1085651561679:web:82ca82d59d6ff2ec671bba"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  console.log("‚úÖ Firebase initialized");

  emailjs.init("rHYrJYPEObugXQPep");

  function sendLoginEmail(userEmail) {
    emailjs.send("service_jcmia18", "template_c34t4jt", {
      user_email: userEmail,
      login_time: new Date().toLocaleString(),
      device: navigator.userAgent
    }).catch(err => console.error("Email error:", err));
  }

  // Check if we're returning from Google OAuth
  const isReturningFromGoogle = sessionStorage.getItem('googleLoginInProgress');
  console.log("üîç Google login in progress?", isReturningFromGoogle);

  // Flag to prevent multiple redirects
  let hasRedirected = false;

  // Handle auth state changes
  onAuthStateChanged(auth, async (user) => {
    console.log("üîî Auth state changed");
    console.log("  - User:", user ? user.email : "null");
    console.log("  - Has redirected?", hasRedirected);
    console.log("  - Returning from Google?", isReturningFromGoogle);

    if (user && !hasRedirected) {
      console.log("‚úÖ User is authenticated");

      // If returning from Google, save profile
      if (isReturningFromGoogle === 'true') {
        console.log("üíæ Saving Google user profile...");
        
        try {
          await set(ref(database, "users/" + user.uid + "/profile"), {
            email: user.email,
            name: user.displayName,
            photoURL: user.photoURL,
            lastLogin: new Date().toISOString(),
          });
          console.log("‚úÖ Profile saved");
          sendLoginEmail(user.email);
        } catch (error) {
          console.error("‚ùå Error saving profile:", error);
        }

        // Clear the flag
        sessionStorage.removeItem('googleLoginInProgress');
      }

      // Redirect to app
      hasRedirected = true;
      console.log("üîÑ REDIRECTING TO APP");
      
      setTimeout(() => {
        window.location.replace("app.html");
      }, 500);
    } else if (!user) {
      console.log("‚ÑπÔ∏è No user authenticated - showing login form");
      // Clear any stale flags
      sessionStorage.removeItem('googleLoginInProgress');
    }
  });

  // Also try getRedirectResult (as backup)
  getRedirectResult(auth)
    .then((result) => {
      console.log("üì• getRedirectResult:", result ? "Has result" : "null");
      if (result) {
        console.log("  - Email:", result.user.email);
      }
    })
    .catch((error) => {
      console.error("‚ùå getRedirectResult error:", error);
    });

  window.login = async function(email, password, callback) {
    console.log("üìß Email login attempt:", email);
    try {
      await signInWithEmailAndPassword(auth, email, password);
      console.log("‚úÖ Email login successful");
      sendLoginEmail(email);
      // onAuthStateChanged will handle redirect
    } catch (error) {
      console.error("‚ùå Email login error:", error);
      if (callback) callback(error.message);
    }
  };

  window.signUp = async function(email, password, callback) {
    console.log("üìù Signup attempt:", email);
    if (password.length < 6) {
      if (callback) callback("Password must be at least 6 characters");
      return;
    }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      console.log("‚úÖ Signup successful");
      
      await set(ref(database, 'users/' + cred.user.uid + '/profile'), {
        email: email,
        createdAt: new Date().toISOString()
      });
      console.log("‚úÖ Profile created");
      
      sendLoginEmail(email);
      // onAuthStateChanged will handle redirect
    } catch (error) {
      console.error("‚ùå Signup error:", error);
      if (callback) callback(error.message);
    }
  };

  window.googleLogin = async function() {
    console.log("üîµ GOOGLE LOGIN CLICKED");
    
    // Set flag before redirecting
    sessionStorage.setItem('googleLoginInProgress', 'true');
    console.log("  - Flag set in sessionStorage");
    
    try {
      const provider = new GoogleAuthProvider();
      console.log("  - Starting redirect to Google...");
      await signInWithRedirect(auth, provider);
    } catch (error) {
      console.error("‚ùå Google login error:", error);
      sessionStorage.removeItem('googleLoginInProgress');
      alert("Google login failed: " + error.message);
    }
  };

  window.addEventListener("load", () => {
    console.log("üé® Page loaded");
    setTimeout(() => {
      document.getElementById("loader")?.classList.add("hide-loader");
    }, 2500);
  });

  window.switchTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(t => {
      t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
    });
    document.querySelectorAll('.auth-form').forEach(f => {
      f.classList.toggle('active', f.id === tab + 'Form');
    });
    hideAlert();
  };

  window.togglePassword = function(inputId) {
    const input = document.getElementById(inputId);
    if (input) input.type = input.type === 'password' ? 'text' : 'password';
  };

  function showAlert(message, type = 'error') {
    const alert = document.getElementById('alert');
    if (alert) {
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
    }
  }

  function hideAlert() {
    document.getElementById('alert')?.classList.remove('show');
  }

  window.handleLogin = async function(e) {
    e.preventDefault();
    hideAlert();
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span><span>Logging in...</span>';
    await window.login(
      document.getElementById('loginEmail').value,
      document.getElementById('loginPassword').value,
      (error) => {
        showAlert(error);
        btn.disabled = false;
        btn.innerHTML = '<span>Login to your account</span>';
      }
    );
  };

  window.handleSignup = async function(e) {
    e.preventDefault();
    hideAlert();
    const pass = document.getElementById('signupPassword').value;
    const conf = document.getElementById('confirmPassword').value;
    if (pass !== conf) {
      showAlert('Passwords do not match!');
      return;
    }
    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span><span>Creating account...</span>';
    await window.signUp(
      document.getElementById('signupEmail').value,
      pass,
      (error) => {
        showAlert(error);
        btn.disabled = false;
        btn.innerHTML = '<span>Create account</span>';
      }
    );
  };
  
  console.log("üéØ Script setup complete");
</script>
</body>
</html>












